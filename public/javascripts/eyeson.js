!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("eyeson",[],t):"object"==typeof exports?exports.eyeson=t():e.eyeson=t()}(window,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=29)}([function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t,n){var i=n(7),r=n(12);e.exports=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?r(e):t}},function(e,t,n){var i=n(18);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}},function(e,t,n){var i=n(23),r=n(24),s=n(25);e.exports=function(e,t){return i(e)||r(e,t)||s()}},function(e,t,n){var i=n(19);function r(t,n,s){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=r=Reflect.get:e.exports=r=function(e,t,n){var r=i(e,t);if(r){var s=Object.getOwnPropertyDescriptor(r,t);return s.get?s.get.call(n):s.value}},r(t,n,s||t)}e.exports=r},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=i=function(e){return n(e)}:e.exports=i=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},i(t)}e.exports=i},function(e,t,n){e.exports=n(22)},function(e,t,n){
/*!
* screenfull
* v5.0.0 - 2019-09-09
* (c) Sindre Sorhus; MIT License
*/
!function(){"use strict";var t="undefined"!=typeof window&&void 0!==window.document?window.document:{},n=e.exports,i=function(){for(var e,n=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],i=0,r=n.length,s={};i<r;i++)if((e=n[i])&&e[1]in t){for(i=0;i<e.length;i++)s[n[0][i]]=e[i];return s}return!1}(),r={change:i.fullscreenchange,error:i.fullscreenerror},s={request:function(e){return new Promise(function(n,r){var s=function(){this.off("change",s),n()}.bind(this);this.on("change",s),e=e||t.documentElement,Promise.resolve(e[i.requestFullscreen]()).catch(r)}.bind(this))},exit:function(){return new Promise(function(e,n){if(this.isFullscreen){var r=function(){this.off("change",r),e()}.bind(this);this.on("change",r),Promise.resolve(t[i.exitFullscreen]()).catch(n)}else e()}.bind(this))},toggle:function(e){return this.isFullscreen?this.exit():this.request(e)},onchange:function(e){this.on("change",e)},onerror:function(e){this.on("error",e)},on:function(e,n){var i=r[e];i&&t.addEventListener(i,n,!1)},off:function(e,n){var i=r[e];i&&t.removeEventListener(i,n,!1)},raw:i};i?(Object.defineProperties(s,{isFullscreen:{get:function(){return Boolean(t[i.fullscreenElement])}},element:{enumerable:!0,get:function(){return t[i.fullscreenElement]}},isEnabled:{enumerable:!0,get:function(){return Boolean(t[i.fullscreenEnabled])}}}),n?e.exports=s:window.screenfull=s):n?e.exports={isEnabled:!1}:window.screenfull={isEnabled:!1}}()},function(e,t){function n(e,t,n,i,r,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(i,r)}e.exports=function(e){return function(){var t=this,i=arguments;return new Promise(function(r,s){var o=e.apply(t,i);function a(e){n(o,r,s,a,c,"next",e)}function c(e){n(o,r,s,a,c,"throw",e)}a(void 0)})}}},function(e,t,n){"use strict";var i={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},i.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},i.getDescription=function(e){var t=i.splitSections(e);return t&&t[0]},i.getMediaSections=function(e){var t=i.splitSections(e);return t.shift(),t},i.matchPrefix=function(e,t){return i.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},i.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1];break;case"ufrag":n.ufrag=t[i+1],n.usernameFragment=t[i+1];break;default:n[t[i]]=t[i+1]}return n},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},i.parseIceOptions=function(e){return e.substr(14).split(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},i.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),r=0;r<i.length;r++)n[(t=i[r].trim().split("="))[0].trim()]=t[1];return n},i.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},i.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},i.getMid=function(e){var t=i.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},i.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},i.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:i.matchPrefix(e+t,"a=fingerprint:").map(i.parseFingerprint)}},i.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},i.getIceParameters=function(e,t){var n=i.splitLines(e);return{usernameFragment:(n=n.concat(i.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=i.splitLines(e)[0].split(" "),r=3;r<n.length;r++){var s=n[r],o=i.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var a=i.parseRtpMap(o),c=i.matchPrefix(e,"a=fmtp:"+s+" ");switch(a.parameters=c.length?i.parseFmtp(c[0]):{},a.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(i.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(i.parseExtmap(e))}),t},i.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=i.writeRtpMap(e),n+=i.writeFmtp(e),n+=i.writeRtcpFb(e)});var r=0;return t.codecs.forEach(function(e){e.maxptime>r&&(r=e.maxptime)}),r>0&&(n+="a=maxptime:"+r+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach(function(e){n+=i.writeExtmap(e)}),n},i.parseRtpEncodingParameters=function(e){var t,n=[],r=i.parseRtpParameters(e),s=-1!==r.fecMechanisms.indexOf("RED"),o=-1!==r.fecMechanisms.indexOf("ULPFEC"),a=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=a.length>0&&a[0].ssrc,u=i.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substr(17).split(" ").map(function(e){return parseInt(e,10)})});u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),r.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(i.rtx={ssrc:t}),n.push(i),s&&((i=JSON.parse(JSON.stringify(i))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(i))}}),0===n.length&&c&&n.push({ssrc:c});var h=i.matchPrefix(e,"b=");return h.length&&(h=0===h[0].indexOf("b=TIAS:")?parseInt(h[0].substr(7),10):0===h[0].indexOf("b=AS:")?1e3*parseInt(h[0].substr(5),10)*.95-16e3:void 0,n.forEach(function(e){e.maxBitrate=h})),n},i.parseRtcpParameters=function(e){var t={},n=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var r=i.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=r.length>0,t.compound=0===r.length;var s=i.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},i.parseMsid=function(e){var t,n=i.matchPrefix(e,"a=msid:");if(1===n.length)return{stream:(t=n[0].substr(7).split(" "))[0],track:t[1]};var r=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return r.length>0?{stream:(t=r[0].value.split(" "))[0],track:t[1]}:void 0},i.parseSctpDescription=function(e){var t,n=i.parseMLine(e),r=i.matchPrefix(e,"a=max-message-size:");r.length>0&&(t=parseInt(r[0].substr(19),10)),isNaN(t)&&(t=65536);var s=i.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substr(12),10),protocol:n.fmt,maxMessageSize:t};if(i.matchPrefix(e,"a=sctpmap:").length>0){var o=i.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(o[0],10),protocol:o[1],maxMessageSize:t}}},i.writeSctpDescription=function(e,t){var n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},i.generateSessionId=function(){return Math.random().toString().substr(2,21)},i.writeSessionBoilerplate=function(e,t,n){var r=void 0!==t?t:2;return"v=0\r\no="+(n||"thisisadapterortc")+" "+(e||i.generateSessionId())+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,n,r){var s=i.writeRtpDescription(e.kind,t);if(s+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o="msid:"+r.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+o,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),s},i.getDirection=function(e,t){for(var n=i.splitLines(e),r=0;r<n.length;r++)switch(n[r]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[r].substr(2)}return t?i.getDirection(t):"sendrecv"},i.getKind=function(e){return i.splitLines(e)[0].split(" ")[0].substr(2)},i.isRejected=function(e){return"0"===e.split(" ",2)[1]},i.parseMLine=function(e){var t=i.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},i.parseOLine=function(e){var t=i.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},i.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=i.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return!1;return!0},e.exports=i},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var i=n(26),r=n(27),s=n(28);e.exports=function(e){return i(e)||r(e)||s()}},function(e,t,n){"use strict";var i=n(11);function r(e,t,n,r,s){var o=i.writeRtpDescription(e.kind,t);if(o+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":s||"active"),o+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=a;var c="msid:"+(r?r.id:"-")+" "+a+"\r\n";o+="a="+c,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+i.localCName+"\r\n"),o}function s(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},i=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},r=function(e,t,n,r){var s=i(e.parameters.apt,n),o=i(t.parameters.apt,r);return s&&o&&s.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach(function(i){for(var s=0;s<t.codecs.length;s++){var o=t.codecs[s];if(i.name.toLowerCase()===o.name.toLowerCase()&&i.clockRate===o.clockRate){if("rtx"===i.name.toLowerCase()&&i.parameters&&o.parameters.apt&&!r(i,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(i.numChannels,o.numChannels),n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(e){for(var t=0;t<i.rtcpFeedback.length;t++)if(i.rtcpFeedback[t].type===e.type&&i.rtcpFeedback[t].parameter===e.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var r=t.headerExtensions[i];if(e.uri===r.uri){n.headerExtensions.push(r);break}}}),n}function o(e,t,n){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function a(e,t){var n=e.getRemoteCandidates().find(function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type});return n||e.addRemoteCandidate(t),!n}function c(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}e.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,n,i,r){var s=new Event("track");s.track=n,s.receiver=i,s.transceiver={receiver:i},s.streams=r,e.setTimeout(function(){t._dispatchEvent("track",s)})}var h=function(n){var r=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){r[e]=s[e].bind(s)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all"}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced"}if(n.iceServers=function(e,t){var n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var r="string"==typeof i;return r&&(i=[i]),i=i.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!n?(n=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")}),delete e.url,e.urls=r?i[0]:i,!!i.length}})}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var o=n.iceCandidatePoolSize;o>0;o--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=i.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(h.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(h.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),h.prototype.onicecandidate=null,h.prototype.onaddstream=null,h.prototype.ontrack=null,h.prototype.onremovestream=null,h.prototype.onsignalingstatechange=null,h.prototype.oniceconnectionstatechange=null,h.prototype.onconnectionstatechange=null,h.prototype.onicegatheringstatechange=null,h.prototype.onnegotiationneeded=null,h.prototype.ondatachannel=null,h.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},h.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},h.prototype.getConfiguration=function(){return this._config},h.prototype.getLocalStreams=function(){return this.localStreams},h.prototype.getRemoteStreams=function(){return this.remoteStreams},h.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,i={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)i.iceTransport=this.transceivers[0].iceTransport,i.dtlsTransport=this.transceivers[0].dtlsTransport;else{var r=this._createIceAndDtlsTransports();i.iceTransport=r.iceTransport,i.dtlsTransport=r.dtlsTransport}return t||this.transceivers.push(i),i},h.prototype.addTrack=function(t,n){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var i;if(this.transceivers.find(function(e){return e.track===t}))throw c("InvalidAccessError","Track already exists.");for(var r=0;r<this.transceivers.length;r++)this.transceivers[r].track||this.transceivers[r].kind!==t.kind||(i=this.transceivers[r]);return i||(i=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),i.track=t,i.stream=n,i.rtpSender=new e.RTCRtpSender(t,i.dtlsTransport),i.rtpSender},h.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach(function(t){n.addTrack(t,e)});else{var i=e.clone();e.getTracks().forEach(function(e,t){var n=i.getTracks()[t];e.addEventListener("enabled",function(e){n.enabled=e.enabled})}),i.getTracks().forEach(function(e){n.addTrack(e,i)})}},h.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find(function(e){return e.rtpSender===t});if(!n)throw c("InvalidAccessError","Sender was not created by this connection.");var i=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map(function(e){return e.stream}).indexOf(i)&&this.localStreams.indexOf(i)>-1&&this.localStreams.splice(this.localStreams.indexOf(i),1),this._maybeFireNegotiationNeeded()},h.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(e){var n=t.getSenders().find(function(t){return t.track===e});n&&t.removeTrack(n)})},h.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},h.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},h.prototype._createIceGatherer=function(t,n){var i=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var r=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(r,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;r.state=n?"completed":"gathering",null!==i.transceivers[t].bufferedCandidateEvents&&i.transceivers[t].bufferedCandidateEvents.push(e)},r.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),r},h.prototype._gather=function(t,n){var r=this,s=this.transceivers[n].iceGatherer;if(!s.onlocalcandidate){var o=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),s.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var o=new Event("icecandidate");o.candidate={sdpMid:t,sdpMLineIndex:n};var a=e.candidate,c=!a||0===Object.keys(a).length;if(c)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),a.component=1,a.ufrag=s.getLocalParameters().usernameFragment;var u=i.writeCandidate(a);o.candidate=Object.assign(o.candidate,i.parseCandidate(u)),o.candidate.candidate=u,o.candidate.toJSON=function(){return{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex,usernameFragment:o.candidate.usernameFragment}}}var h=i.getMediaSections(r._localDescription.sdp);h[o.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+o.candidate.candidate+"\r\n",r._localDescription.sdp=i.getDescription(r._localDescription.sdp)+h.join("");var d=r.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),c||r._dispatchEvent("icecandidate",o),d&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange())}},e.setTimeout(function(){o.forEach(function(e){s.onlocalcandidate(e)})},0)}},h.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var i=new e.RTCDtlsTransport(n);return i.ondtlsstatechange=function(){t._updateConnectionState()},i.onerror=function(){Object.defineProperty(i,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:n,dtlsTransport:i}},h.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var i=this.transceivers[e].dtlsTransport;i&&(delete i.ondtlsstatechange,delete i.onerror,delete this.transceivers[e].dtlsTransport)},h.prototype._transceive=function(e,n,r){var o=s(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:i.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),r&&e.rtpReceiver&&o.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),e.recvEncodingParameters.length?o.encodings=e.recvEncodingParameters:o.encodings=[{}],o.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(o.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},h.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!o("setLocalDescription",e.type,r.signalingState)||r._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=i.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=i.parseRtpParameters(e);r.transceivers[t].localCapabilities=n}),r.transceivers.forEach(function(e,t){r._gather(e.mid,t)});else if("answer"===e.type){t=i.splitSections(r._remoteDescription.sdp),n=t.shift();var a=i.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var o=r.transceivers[t],c=o.iceGatherer,u=o.iceTransport,h=o.dtlsTransport,d=o.localCapabilities,l=o.remoteCapabilities;if(!(i.isRejected(e)&&0===i.matchPrefix(e,"a=bundle-only").length)&&!o.rejected){var p=i.getIceParameters(e,n),f=i.getDtlsParameters(e,n);a&&(f.role="server"),r.usingBundle&&0!==t||(r._gather(o.mid,t),"new"===u.state&&u.start(c,p,a?"controlling":"controlled"),"new"===h.state&&h.start(f));var m=s(d,l);r._transceive(o,m.codecs.length>0,!1)}})}return r._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},h.prototype.setRemoteDescription=function(r){var h=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(c("TypeError",'Unsupported type "'+r.type+'"'));if(!o("setRemoteDescription",r.type,h.signalingState)||h._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+r.type+" in state "+h.signalingState));var d={};h.remoteStreams.forEach(function(e){d[e.id]=e});var l=[],p=i.splitSections(r.sdp),f=p.shift(),m=i.matchPrefix(f,"a=ice-lite").length>0,g=i.matchPrefix(f,"a=group:BUNDLE ").length>0;h.usingBundle=g;var v=i.matchPrefix(f,"a=ice-options:")[0];return h.canTrickleIceCandidates=!!v&&v.substr(14).split(" ").indexOf("trickle")>=0,p.forEach(function(o,c){var u=i.splitLines(o),p=i.getKind(o),v=i.isRejected(o)&&0===i.matchPrefix(o,"a=bundle-only").length,T=u[0].substr(2).split(" ")[2],y=i.getDirection(o,f),S=i.parseMsid(o),b=i.getMid(o)||i.generateIdentifier();if(v||"application"===p&&("DTLS/SCTP"===T||"UDP/DTLS/SCTP"===T))h.transceivers[c]={mid:b,kind:p,protocol:T,rejected:!0};else{var C,E,_,R,w,A,I,k,D;!v&&h.transceivers[c]&&h.transceivers[c].rejected&&(h.transceivers[c]=h._createTransceiver(p,!0));var x,O,P=i.parseRtpParameters(o);v||(x=i.getIceParameters(o,f),(O=i.getDtlsParameters(o,f)).role="client"),I=i.parseRtpEncodingParameters(o);var N=i.parseRtcpParameters(o),U=i.matchPrefix(o,"a=end-of-candidates",f).length>0,M=i.matchPrefix(o,"a=candidate:").map(function(e){return i.parseCandidate(e)}).filter(function(e){return 1===e.component});if(("offer"===r.type||"answer"===r.type)&&!v&&g&&c>0&&h.transceivers[c]&&(h._disposeIceAndDtlsTransports(c),h.transceivers[c].iceGatherer=h.transceivers[0].iceGatherer,h.transceivers[c].iceTransport=h.transceivers[0].iceTransport,h.transceivers[c].dtlsTransport=h.transceivers[0].dtlsTransport,h.transceivers[c].rtpSender&&h.transceivers[c].rtpSender.setTransport(h.transceivers[0].dtlsTransport),h.transceivers[c].rtpReceiver&&h.transceivers[c].rtpReceiver.setTransport(h.transceivers[0].dtlsTransport)),"offer"!==r.type||v){if("answer"===r.type&&!v){E=(C=h.transceivers[c]).iceGatherer,_=C.iceTransport,R=C.dtlsTransport,w=C.rtpReceiver,A=C.sendEncodingParameters,k=C.localCapabilities,h.transceivers[c].recvEncodingParameters=I,h.transceivers[c].remoteCapabilities=P,h.transceivers[c].rtcpParameters=N,M.length&&"new"===_.state&&(!m&&!U||g&&0!==c?M.forEach(function(e){a(C.iceTransport,e)}):_.setRemoteCandidates(M)),g&&0!==c||("new"===_.state&&_.start(E,x,"controlling"),"new"===R.state&&R.start(O)),!s(C.localCapabilities,C.remoteCapabilities).codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,h._transceive(C,"sendrecv"===y||"recvonly"===y,"sendrecv"===y||"sendonly"===y),!w||"sendrecv"!==y&&"sendonly"!==y?delete C.rtpReceiver:(D=w.track,S?(d[S.stream]||(d[S.stream]=new e.MediaStream),n(D,d[S.stream]),l.push([D,w,d[S.stream]])):(d.default||(d.default=new e.MediaStream),n(D,d.default),l.push([D,w,d.default])))}}else{(C=h.transceivers[c]||h._createTransceiver(p)).mid=b,C.iceGatherer||(C.iceGatherer=h._createIceGatherer(c,g)),M.length&&"new"===C.iceTransport.state&&(!U||g&&0!==c?M.forEach(function(e){a(C.iceTransport,e)}):C.iceTransport.setRemoteCandidates(M)),k=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(k.codecs=k.codecs.filter(function(e){return"rtx"!==e.name})),A=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var $,L=!1;if("sendrecv"===y||"sendonly"===y){if(L=!C.rtpReceiver,w=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),L)D=w.track,S&&"-"===S.stream||(S?(d[S.stream]||(d[S.stream]=new e.MediaStream,Object.defineProperty(d[S.stream],"id",{get:function(){return S.stream}})),Object.defineProperty(D,"id",{get:function(){return S.track}}),$=d[S.stream]):(d.default||(d.default=new e.MediaStream),$=d.default)),$&&(n(D,$),C.associatedRemoteMediaStreams.push($)),l.push([D,w,$])}else C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach(function(t){var n=t.getTracks().find(function(e){return e.id===C.rtpReceiver.track.id});n&&function(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(n,t)}),C.associatedRemoteMediaStreams=[]);C.localCapabilities=k,C.remoteCapabilities=P,C.rtpReceiver=w,C.rtcpParameters=N,C.sendEncodingParameters=A,C.recvEncodingParameters=I,h._transceive(h.transceivers[c],!1,L)}}}),void 0===h._dtlsRole&&(h._dtlsRole="offer"===r.type?"active":"passive"),h._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?h._updateSignalingState("have-remote-offer"):h._updateSignalingState("stable"),Object.keys(d).forEach(function(t){var n=d[t];if(n.getTracks().length){if(-1===h.remoteStreams.indexOf(n)){h.remoteStreams.push(n);var i=new Event("addstream");i.stream=n,e.setTimeout(function(){h._dispatchEvent("addstream",i)})}l.forEach(function(e){var t=e[0],i=e[1];n.id===e[2].id&&u(h,t,i,[n])})}}),l.forEach(function(e){e[2]||u(h,e[0],e[1],[])}),e.setTimeout(function(){h&&h.transceivers&&h.transceivers.forEach(function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},h.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},h.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},h.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout(function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}},0))},h.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++}),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n)}},h.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)}),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n)}},h.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var s=n.transceivers.filter(function(e){return"audio"===e.kind}).length,o=n.transceivers.filter(function(e){return"video"===e.kind}).length,a=arguments[0];if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==a.offerToReceiveAudio&&(s=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio),void 0!==a.offerToReceiveVideo&&(o=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(n.transceivers.forEach(function(e){"audio"===e.kind?--s<0&&(e.wantReceive=!1):"video"===e.kind&&--o<0&&(e.wantReceive=!1)});s>0||o>0;)s>0&&(n._createTransceiver("audio"),s--),o>0&&(n._createTransceiver("video"),o--);var u=i.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach(function(r,s){var o=r.track,a=r.kind,c=r.mid||i.generateIdentifier();r.mid=c,r.iceGatherer||(r.iceGatherer=n._createIceGatherer(s,n.usingBundle));var u=e.RTCRtpSender.getCapabilities(a);t<15019&&(u.codecs=u.codecs.filter(function(e){return"rtx"!==e.name})),u.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach(function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)})}),u.headerExtensions.forEach(function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach(function(t){e.uri===t.uri&&(e.id=t.id)})});var h=r.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];o&&t>=15019&&"video"===a&&!h[0].rtx&&(h[0].rtx={ssrc:h[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,a)),r.localCapabilities=u,r.sendEncodingParameters=h}),"max-compat"!==n._config.bundlePolicy&&(u+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",n.transceivers.forEach(function(e,t){u+=r(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),u+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach(function(e){e.component=1,u+="a="+i.writeCandidate(e)+"\r\n"}),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))});var h=new e.RTCSessionDescription({type:"offer",sdp:u});return Promise.resolve(h)},h.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var o=i.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(o+="a=group:BUNDLE "+n.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n";var a=i.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach(function(e,i){if(!(i+1>a)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?o+="m=application 0 DTLS/SCTP 5000\r\n":o+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?o+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(o+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(o+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var u=s(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter(function(e){return"rtx"===e.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,o+=r(e,u,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(o+="a=rtcp-rsize\r\n")}});var u=new e.RTCSessionDescription({type:"answer",sdp:o});return Promise.resolve(u)},h.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(r,s){if(!n._remoteDescription)return s(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var o=e.sdpMLineIndex;if(e.sdpMid)for(var u=0;u<n.transceivers.length;u++)if(n.transceivers[u].mid===e.sdpMid){o=u;break}var h=n.transceivers[o];if(!h)return s(c("OperationError","Can not add ICE candidate"));if(h.rejected)return r();var d=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===d.protocol&&(0===d.port||9===d.port))return r();if(d.component&&1!==d.component)return r();if((0===o||o>0&&h.iceTransport!==n.transceivers[0].iceTransport)&&!a(h.iceTransport,d))return s(c("OperationError","Can not add ICE candidate"));var l=e.candidate.trim();0===l.indexOf("a=")&&(l=l.substr(2)),(t=i.getMediaSections(n._remoteDescription.sdp))[o]+="a="+(d.type?l:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=i.getDescription(n._remoteDescription.sdp)+t.join("")}else for(var p=0;p<n.transceivers.length&&(n.transceivers[p].rejected||(n.transceivers[p].iceTransport.addRemoteCandidate({}),(t=i.getMediaSections(n._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=i.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));p++);r()})},h.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach(function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver)}),!n)throw c("InvalidAccessError","Invalid selector.");return n.getStats()}var i=[];return this.transceivers.forEach(function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(t){e[t]&&i.push(e[t].getStats())})}),Promise.all(i).then(function(e){var t=new Map;return e.forEach(function(e){e.forEach(function(e){t.set(e.id,e)})}),t})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var i=n.prototype.getStats;n.prototype.getStats=function(){return i.apply(this).then(function(e){var t=new Map;return Object.keys(e).forEach(function(n){var i;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(i=e[n]).type]||i.type,t.set(n,e[n])}),t})}}});var d=["createOffer","createAnswer"];return d.forEach(function(e){var t=h.prototype[e];h.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then(function(t){"function"==typeof e[0]&&e[0].apply(null,[t])},function(t){"function"==typeof e[1]&&e[1].apply(null,[t])}):t.apply(this,arguments)}}),(d=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach(function(e){var t=h.prototype[e];h.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)},function(t){"function"==typeof e[2]&&e[2].apply(null,[t])}):t.apply(this,arguments)}}),["getStats"].forEach(function(e){var t=h.prototype[e];h.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then(function(){"function"==typeof e[1]&&e[1].apply(null)}):t.apply(this,arguments)}}),h}},function(e,t,n){(function(e,i){var r;
/*!
 * Platform.js <https://mths.be/platform>
 * Copyright 2014-2018 Benjamin Tan <https://bnjmnt4n.now.sh/>
 * Copyright 2011-2013 John-David Dalton <http://allyoucanleet.com/>
 * Available under MIT license <https://mths.be/mit>
 */(function(){"use strict";var s={function:!0,object:!0},o=s[typeof window]&&window||this,a=s[typeof t]&&t,c=s[typeof e]&&e&&!e.nodeType&&e,u=a&&c&&"object"==typeof i&&i;!u||u.global!==u&&u.window!==u&&u.self!==u||(o=u);var h=Math.pow(2,53)-1,d=/\bOpera/,l=Object.prototype,p=l.hasOwnProperty,f=l.toString;function m(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function g(e){return e=b(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:m(e)}function v(e,t){for(var n in e)p.call(e,n)&&t(e[n],n,e)}function T(e){return null==e?m(e):f.call(e).slice(8,-1)}function y(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function S(e,t){var n=null;return function(e,t){var n=-1,i=e?e.length:0;if("number"==typeof i&&i>-1&&i<=h)for(;++n<i;)t(e[n],n,e);else v(e,t)}(e,function(i,r){n=t(n,i,r,e)}),n}function b(e){return String(e).replace(/^ +| +$/g,"")}var C=function e(t){var n=o,i=t&&"object"==typeof t&&"String"!=T(t);i&&(n=t,t=null);var r=n.navigator||{},s=r.userAgent||"";t||(t=s);var a,c,u,h,l,p=i?!!r.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(f.toString()),m=i?"Object":"ScriptBridgingProxyObject",C=i?"Object":"Environment",E=i&&n.java?"JavaPackage":T(n.java),_=i?"Object":"RuntimeObject",R=/\bJava/.test(E)&&n.java,w=R&&T(n.environment)==C,A=R?"a":"α",I=R?"b":"β",k=n.document||{},D=n.operamini||n.opera,x=d.test(x=i&&D?D["[[Class]]"]:T(D))?x:D=null,O=t,P=[],N=null,U=t==s,M=U&&D&&"function"==typeof D.version&&D.version(),$=S([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)}),L=function(e){return S(e,function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)})}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),H=j([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),q=function(e){return S(e,function(e,n,i){return e||(n[H]||n[/^[a-z]+(?: +[a-z]+\b)*/i.exec(H)]||RegExp("\\b"+y(i)+"(?:\\b|\\w*\\d)","i").exec(t))&&i})}({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}}),F=function(e){return S(e,function(e,n){var i=n.pattern||y(n);return!e&&(e=RegExp("\\b"+i+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(e=function(e,t,n){var i={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return t&&n&&/^Win/i.test(e)&&!/^Windows Phone /i.test(e)&&(i=i[/[\d.]+$/.exec(e)])&&(e="Windows "+i),e=String(e),t&&n&&(e=e.replace(RegExp(t,"i"),n)),e=g(e.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(e,i,n.label||n)),e})}(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function j(e){return S(e,function(e,n){var i=n.pattern||y(n);return!e&&(e=RegExp("\\b"+i+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+i+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+i+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(n.label&&!RegExp(i,"i").test(n.label)?n.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),n=n.label||n,e=g(e[0].replace(RegExp(i,"i"),n).replace(RegExp("; *(?:"+n+"[_-])?","i")," ").replace(RegExp("("+n+")[-_.]?(\\w)","i"),"$1 $2"))),e})}if($&&($=[$]),q&&!H&&(H=j([q])),(a=/\bGoogle TV\b/.exec(H))&&(H=a[0]),/\bSimulator\b/i.test(t)&&(H=(H?H+" ":"")+"Simulator"),"Opera Mini"==L&&/\bOPiOS\b/.test(t)&&P.push("running in Turbo/Uncompressed mode"),"IE"==L&&/\blike iPhone OS\b/.test(t)?(q=(a=e(t.replace(/like iPhone OS/,""))).manufacturer,H=a.product):/^iP/.test(H)?(L||(L="Safari"),F="iOS"+((a=/ OS ([\d_]+)/i.exec(t))?" "+a[1].replace(/_/g,"."):"")):"Konqueror"!=L||/buntu/i.test(F)?q&&"Google"!=q&&(/Chrome/.test(L)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(H))||/\bAndroid\b/.test(F)&&/^Chrome/.test(L)&&/\bVersion\//i.test(t)?(L="Android Browser",F=/\bAndroid\b/.test(F)?F:"Android"):"Silk"==L?(/\bMobi/i.test(t)||(F="Android",P.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&P.unshift("accelerated")):"PaleMoon"==L&&(a=/\bFirefox\/([\d.]+)\b/.exec(t))?P.push("identifying as Firefox "+a[1]):"Firefox"==L&&(a=/\b(Mobile|Tablet|TV)\b/i.exec(t))?(F||(F="Firefox OS"),H||(H=a[1])):!L||(a=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(L))?(L&&!H&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(a+"/")+8))&&(L=null),(a=H||q||F)&&(H||q||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(F))&&(L=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(F)?F:a)+" Browser")):"Electron"==L&&(a=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&P.push("Chromium "+a):F="Kubuntu",M||(M=S(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",y(L),"(?:Firefox|Minefield|NetFront)"],function(e,n){return e||(RegExp(n+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null})),(a=("iCab"==$&&parseFloat(M)>3?"WebKit":/\bOpera\b/.test(L)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test($)&&"WebKit"||!$&&/\bMSIE\b/i.test(t)&&("Mac OS"==F?"Tasman":"Trident")||"WebKit"==$&&/\bPlayStation\b(?! Vita\b)/i.test(L)&&"NetFront")&&($=[a]),"IE"==L&&(a=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(L+=" Mobile",F="Windows Phone "+(/\+$/.test(a)?a:a+".x"),P.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(L="IE Mobile",F="Windows Phone 8.x",P.unshift("desktop mode"),M||(M=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=L&&"Trident"==$&&(a=/\brv:([\d.]+)/.exec(t))&&(L&&P.push("identifying as "+L+(M?" "+M:"")),L="IE",M=a[1]),U){if(h="global",l=null!=(u=n)?typeof u[h]:"number",/^(?:boolean|number|string|undefined)$/.test(l)||"object"==l&&!u[h])T(a=n.runtime)==m?(L="Adobe AIR",F=a.flash.system.Capabilities.os):T(a=n.phantom)==_?(L="PhantomJS",M=(a=a.version||null)&&a.major+"."+a.minor+"."+a.patch):"number"==typeof k.documentMode&&(a=/\bTrident\/(\d+)/i.exec(t))?(M=[M,k.documentMode],(a=+a[1]+4)!=M[1]&&(P.push("IE "+M[1]+" mode"),$&&($[1]=""),M[1]=a),M="IE"==L?String(M[1].toFixed(1)):M[0]):"number"==typeof k.documentMode&&/^(?:Chrome|Firefox)\b/.test(L)&&(P.push("masking as "+L+" "+M),L="IE",M="11.0",$=["Trident"],F="Windows");else if(R&&(O=(a=R.lang.System).getProperty("os.arch"),F=F||a.getProperty("os.name")+" "+a.getProperty("os.version")),w){try{M=n.require("ringo/engine").version.join("."),L="RingoJS"}catch(e){(a=n.system)&&a.global.system==n.system&&(L="Narwhal",F||(F=a[0].os||null))}L||(L="Rhino")}else"object"==typeof n.process&&!n.process.browser&&(a=n.process)&&("object"==typeof a.versions&&("string"==typeof a.versions.electron?(P.push("Node "+a.versions.node),L="Electron",M=a.versions.electron):"string"==typeof a.versions.nw&&(P.push("Chromium "+M,"Node "+a.versions.node),L="NW.js",M=a.versions.nw)),L||(L="Node.js",O=a.arch,F=a.platform,M=(M=/[\d.]+/.exec(a.version))?M[0]:null));F=F&&g(F)}if(M&&(a=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(M)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(U&&r.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(N=/b/i.test(a)?"beta":"alpha",M=M.replace(RegExp(a+"\\+?$"),"")+("beta"==N?I:A)+(/\d+\+?/.exec(a)||"")),"Fennec"==L||"Firefox"==L&&/\b(?:Android|Firefox OS)\b/.test(F))L="Firefox Mobile";else if("Maxthon"==L&&M)M=M.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(H))"Xbox 360"==H&&(F=null),"Xbox 360"==H&&/\bIEMobile\b/.test(t)&&P.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(L)&&(!L||H||/Browser|Mobi/.test(L))||"Windows CE"!=F&&!/Mobi/i.test(t))if("IE"==L&&U)try{null===n.external&&P.unshift("platform preview")}catch(e){P.unshift("embedded")}else(/\bBlackBerry\b/.test(H)||/\bBB10\b/.test(t))&&(a=(RegExp(H.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||M)?(F=((a=[a,/BB10/.test(t)])[1]?(H=null,q="BlackBerry"):"Device Software")+" "+a[0],M=null):this!=v&&"Wii"!=H&&(U&&D||/Opera/.test(L)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==L&&/\bOS X (?:\d+\.){2,}/.test(F)||"IE"==L&&(F&&!/^Win/.test(F)&&M>5.5||/\bWindows XP\b/.test(F)&&M>8||8==M&&!/\bTrident\b/.test(t)))&&!d.test(a=e.call(v,t.replace(d,"")+";"))&&a.name&&(a="ing as "+a.name+((a=a.version)?" "+a:""),d.test(L)?(/\bIE\b/.test(a)&&"Mac OS"==F&&(F=null),a="identify"+a):(a="mask"+a,L=x?g(x.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(a)&&(F=null),U||(M=null)),$=["Presto"],P.push(a));else L+=" Mobile";(a=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(a=[parseFloat(a.replace(/\.(\d)$/,".0$1")),a],"Safari"==L&&"+"==a[1].slice(-1)?(L="WebKit Nightly",N="alpha",M=a[1].slice(0,-1)):M!=a[1]&&M!=(a[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(M=null),a[1]=(/\bChrome\/([\d.]+)/i.exec(t)||0)[1],537.36==a[0]&&537.36==a[2]&&parseFloat(a[1])>=28&&"WebKit"==$&&($=["Blink"]),U&&(p||a[1])?($&&($[1]="like Chrome"),a=a[1]||((a=a[0])<530?1:a<532?2:a<532.05?3:a<533?4:a<534.03?5:a<534.07?6:a<534.1?7:a<534.13?8:a<534.16?9:a<534.24?10:a<534.3?11:a<535.01?12:a<535.02?"13+":a<535.07?15:a<535.11?16:a<535.19?17:a<536.05?18:a<536.1?19:a<537.01?20:a<537.11?"21+":a<537.13?23:a<537.18?24:a<537.24?25:a<537.36?26:"Blink"!=$?"27":"28")):($&&($[1]="like Safari"),a=(a=a[0])<400?1:a<500?2:a<526?3:a<533?4:a<534?"4+":a<535?5:a<537?6:a<538?7:a<601?8:"8"),$&&($[1]+=" "+(a+="number"==typeof a?".x":/[.+]/.test(a)?"":"+")),"Safari"==L&&(!M||parseInt(M)>45)&&(M=a)),"Opera"==L&&(a=/\bzbov|zvav$/.exec(F))?(L+=" ",P.unshift("desktop mode"),"zvav"==a?(L+="Mini",M=null):L+="Mobile",F=F.replace(RegExp(" *"+a+"$"),"")):"Safari"==L&&/\bChrome\b/.exec($&&$[1])&&(P.unshift("desktop mode"),L="Chrome Mobile",M=null,/\bOS X\b/.test(F)?(q="Apple",F="iOS 4.3+"):F=null),M&&0==M.indexOf(a=/[\d.]+$/.exec(F))&&t.indexOf("/"+a+"-")>-1&&(F=b(F.replace(a,""))),$&&!/\b(?:Avant|Nook)\b/.test(L)&&(/Browser|Lunascape|Maxthon/.test(L)||"Safari"!=L&&/^iOS/.test(F)&&/\bSafari\b/.test($[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(L)&&$[1])&&(a=$[$.length-1])&&P.push(a),P.length&&(P=["("+P.join("; ")+")"]),q&&H&&H.indexOf(q)<0&&P.push("on "+q),H&&P.push((/^on /.test(P[P.length-1])?"":"on ")+H),F&&(a=/ ([\d.+]+)$/.exec(F),c=a&&"/"==F.charAt(F.length-a[0].length-1),F={architecture:32,family:a&&!c?F.replace(a[0],""):F,version:a?a[1]:null,toString:function(){var e=this.version;return this.family+(e&&!c?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(a=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(O))&&!/\bi686\b/i.test(O)?(F&&(F.architecture=64,F.family=F.family.replace(RegExp(" *"+a),"")),L&&(/\bWOW64\b/i.test(t)||U&&/\w(?:86|32)$/.test(r.cpuClass||r.platform)&&!/\bWin64; x64\b/i.test(t))&&P.unshift("32-bit")):F&&/^OS X/.test(F.family)&&"Chrome"==L&&parseFloat(M)>=39&&(F.architecture=64),t||(t=null);var G={};return G.description=t,G.layout=$&&$[0],G.manufacturer=q,G.name=L,G.prerelease=N,G.product=H,G.ua=t,G.version=L&&M,G.os=F||{architecture:null,family:null,version:null,toString:function(){return"null"}},G.parse=e,G.toString=function(){return this.description||""},G.version&&P.unshift(M),G.name&&P.unshift(L),F&&L&&(F!=String(F).split(" ")[0]||F!=L.split(" ")[0]&&!H)&&P.push(H?"("+F+")":"on "+F),P.length&&(G.description=P.join(" ")),G}();o.platform=C,void 0===(r=function(){return C}.call(t,n,t,e))||(e.exports=r)}).call(this)}).call(this,n(20)(e),n(21))},function(e,t,n){
/*!
 * 
 *  SIP version 0.11.6
 *  Copyright (c) 2014-2018 Junction Networks, Inc <http://www.onsip.com>
 *  Homepage: https://sipjs.com
 *  License: https://sipjs.com/license/
 * 
 * 
 *  ~~~SIP.js contains substantial portions of JsSIP under the following license~~~
 *  Homepage: http://jssip.net
 *  Copyright (c) 2012-2013 José Luis Millán - Versatica <http://www.versatica.com>
 * 
 *  Permission is hereby granted, free of charge, to any person obtaining
 *  a copy of this software and associated documentation files (the
 *  "Software"), to deal in the Software without restriction, including
 *  without limitation the rights to use, copy, modify, merge, publish,
 *  distribute, sublicense, and/or sell copies of the Software, and to
 *  permit persons to whom the Software is furnished to do so, subject to
 *  the following conditions:
 * 
 *  The above copyright notice and this permission notice shall be
 *  included in all copies or substantial portions of the Software.
 * 
 *  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 *  EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 *  MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 *  NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 *  LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 *  OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 *  WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 * 
 *  ~~~ end JsSIP license ~~~
 * 
 * 
 * 
 * 
 */
var i;i=function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";e.exports=n(1)(n(40))},function(e,t,n){"use strict";e.exports=function(e){var t=n(2),i=t.version,r=t.title,s=Object.defineProperties({},{version:{get:function(){return i}},name:{get:function(){return r}}});return n(3)(s,e),s.LoggerFactory=n(4)(e.console),s.EventEmitter=n(5)(),s.C=n(7)(s.name,s.version),s.Exceptions=n(8),s.Timers=n(9)(e.timers),s.Transport=n(10)(s),n(11)(s),n(12)(s),n(13)(s),n(14)(s),n(15)(s),n(16)(s),n(18)(s),n(19)(s),s.SessionDescriptionHandler=n(20)(s.EventEmitter),n(21)(s),n(22)(s),n(23)(s),n(25)(s),n(26)(s),n(27)(s,e),n(32)(s),s.DigestAuthentication=n(33)(s.Utils),s.Grammar=n(36)(s),s.Web={Modifiers:n(38)(s),Simple:n(39)(s)},s}},function(e){e.exports={name:"sip.js",title:"SIP.js",description:"A simple, intuitive, and powerful JavaScript signaling library",version:"0.11.6",main:"dist/sip.js",browser:{"./src/environment.js":"./src/environment_browser.js"},homepage:"https://sipjs.com",author:"OnSIP <developer@onsip.com> (https://sipjs.com/aboutus/)",contributors:[{url:"https://github.com/onsip/SIP.js/blob/master/THANKS.md"}],repository:{type:"git",url:"https://github.com/onsip/SIP.js.git"},keywords:["sip","websocket","webrtc","library","javascript"],devDependencies:{"awesome-typescript-loader":"^5.2.1",eslint:"^5.4.0","jasmine-core":"^3.2.1",karma:"^3.0.0","karma-chrome-launcher":"^2.2.0","karma-cli":"^1.0.1","karma-jasmine":"^1.1.0","karma-jasmine-html-reporter":"^1.3.1","karma-mocha-reporter":"^2.2.5","karma-webpack":"^3.0.0",pegjs:"^0.10.0","pegjs-loader":"^0.5.4",typescript:"^3.0.3",webpack:"^4.19.0","webpack-cli":"^3.0.8"},engines:{node:">=6.0"},license:"MIT",scripts:{prebuild:"eslint src/*.js src/**/*.js","build-dev":"webpack --progress --env.buildType dev","build-prod":"webpack --progress --env.buildType prod","copy-dist-files":"cp dist/sip.js dist/sip-$npm_package_version.js && cp dist/sip.min.js  dist/sip-$npm_package_version.min.js",build:"npm run build-dev && npm run build-prod && npm run copy-dist-files",browserTest:"sleep 2 && open http://0.0.0.0:9876/debug.html & karma start --reporters kjhtml --no-single-run",commandLineTest:"karma start --reporters mocha --browsers ChromeHeadless --single-run",buildAndTest:"npm run build && npm run commandLineTest",buildAndBrowserTest:"npm run build && npm run browserTest"},dependencies:{"crypto-js":"^3.1.9-1"},optionalDependencies:{promiscuous:"^0.6.0"}}},function(e,t,n){"use strict";e.exports=function(e,t){var n;n={Promise:t.Promise,defer:function(){var e={};return e.promise=new n.Promise(function(t,n){e.resolve=t,e.reject=n}),e},reducePromises:function(t,n){return t.reduce(function(e,t){return e=e.then(t)},e.Utils.Promise.resolve(n))},augment:function(e,t,n,i){var r,s;for(r in s=t.prototype)(i||void 0===e[r])&&(e[r]=s[r]);t.apply(e,n)},defaultOptions:function(e,t){return e=e||{},t=t||{},Object.assign({},e,t)},optionsOverride:function(e,t,n,i,r,s){i&&e[n]&&r.warn(n+" is deprecated, please use "+t+" instead"),e[t]&&e[n]&&r.warn(t+" overriding "+n),e[t]=e[t]||e[n]||s},str_utf8_length:function(e){return encodeURIComponent(e).replace(/%[A-F\d]{2}/g,"U").length},generateFakeSDP:function(e){if(e){var t=e.indexOf("o="),n=e.indexOf("\r\n",t);return"v=0\r\n"+e.slice(t,n)+"\r\ns=-\r\nt=0 0\r\nc=IN IP4 0.0.0.0"}},isFunction:function(e){return void 0!==e&&"[object Function]"===Object.prototype.toString.call(e)},isDecimal:function(e){return!isNaN(e)&&parseFloat(e)===parseInt(e,10)},createRandomToken:function(e,t){var n,i="";for(t=t||32,n=0;n<e;n++)i+=(Math.random()*t|0).toString(t);return i},newTag:function(){return e.Utils.createRandomToken(e.UA.C.TAG_LENGTH)},newUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},hostType:function(t){if(t)return-1!==(t=e.Grammar.parse(t,"host"))?t.host_type:void 0},normalizeTarget:function(t,n){var i,r,s;if(t){if(t instanceof e.URI)return t;if("string"==typeof t){switch((i=t.split("@")).length){case 1:if(!n)return;r=t,s=n;break;case 2:r=i[0],s=i[1];break;default:r=i.slice(0,i.length-1).join("@"),s=i[i.length-1]}return r=r.replace(/^(sips?|tel):/i,""),/^[\-\.\(\)]*\+?[0-9\-\.\(\)]+$/.test(r)&&(r=r.replace(/[\-\.\(\)]/g,"")),t=e.C.SIP+":"+e.Utils.escapeUser(r)+"@"+s,e.URI.parse(t)}}},escapeUser:function(e){return encodeURIComponent(decodeURIComponent(e)).replace(/%3A/gi,":").replace(/%2B/gi,"+").replace(/%3F/gi,"?").replace(/%2F/gi,"/")},headerize:function(e){var t,n={"Call-Id":"Call-ID",Cseq:"CSeq","Min-Se":"Min-SE",Rack:"RAck",Rseq:"RSeq","Www-Authenticate":"WWW-Authenticate"},i=e.toLowerCase().replace(/_/g,"-").split("-"),r="",s=i.length;for(t=0;t<s;t++)0!==t&&(r+="-"),r+=i[t].charAt(0).toUpperCase()+i[t].substring(1);return n[r]&&(r=n[r]),r},sipErrorCause:function(t){var n;for(n in e.C.SIP_ERROR_CAUSES)if(-1!==e.C.SIP_ERROR_CAUSES[n].indexOf(t))return e.C.causes[n];return e.C.causes.SIP_FAILURE_CODE},getReasonPhrase:function(t,n){return n||e.C.REASON_PHRASE[t]||""},getReasonHeaderValue:function(t,n){return"SIP;cause="+t+';text="'+(n=e.Utils.getReasonPhrase(t,n))+'"'},getCancelReason:function(t,n){if(t&&t<200||t>699)throw new TypeError("Invalid status_code: "+t);if(t)return e.Utils.getReasonHeaderValue(t,n)},buildStatusLine:function(e,t){if(t=t||null,!(e=e||null)||e<100||e>699)throw new TypeError("Invalid status_code: "+e);if(t&&"string"!=typeof t&&!(t instanceof String))throw new TypeError("Invalid reason_phrase: "+t);return"SIP/2.0 "+e+" "+(t=n.getReasonPhrase(e,t))+"\r\n"},getRandomTestNetIP:function(){return"192.0.2."+(e=1,t=254,Math.floor(Math.random()*(t-e+1)+e));var e,t}},e.Utils=n}},function(e,t,n){"use strict";var i={error:0,warn:1,log:2,debug:3};e.exports=function(e){var t=function(){var e,t=2,n=!0,r=null;this.loggers={},e=this.getLogger("sip.loggerfactory"),Object.defineProperties(this,{builtinEnabled:{get:function(){return n},set:function(t){"boolean"==typeof t?n=t:e.error('invalid "builtinEnabled" parameter value: '+JSON.stringify(t))}},level:{get:function(){return t},set:function(n){n>=0&&n<=3?t=n:n>3?t=3:i.hasOwnProperty(n)?t=i[n]:e.error('invalid "level" parameter value: '+JSON.stringify(n))}},connector:{get:function(){return r},set:function(t){null===t||""===t||void 0===t?r=null:"function"==typeof t?r=t:e.error('invalid "connector" parameter value: '+JSON.stringify(t))}}})};function n(e,t,n){this.logger=e,this.category=t,this.label=n}return t.prototype.print=function(t,n,i,r){if("string"==typeof r){var s=[new Date,n];i&&s.push(i),r=s.concat(r).join(" | ")}t.call(e,r)},Object.keys(i).forEach(function(r){n.prototype[r]=function(e){this.logger[r](this.category,this.label,e)},t.prototype[r]=function(t,n,s){this.level>=i[r]&&(this.builtinEnabled&&this.print(e[r],t,n,s),this.connector&&this.connector(r,t,n,s))}}),t.prototype.getLogger=function(e,t){var i;return t&&3===this.level?new n(this,e,t):this.loggers[e]?this.loggers[e]:(i=new n(this,e),this.loggers[e]=i,i)},t}},function(e,t,n){"use strict";var i=n(6).EventEmitter;e.exports=function(){function e(){i.call(this)}return e.prototype=Object.create(i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),e}},function(e,t){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function r(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}e.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,n,o,a,c,u;if(this._events||(this._events={}),"error"===e&&(!this._events.error||r(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var h=new Error('Uncaught, unspecified "error" event. ('+t+")");throw h.context=t,h}if(s(n=this._events[e]))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:a=Array.prototype.slice.call(arguments,1),n.apply(this,a)}else if(r(n))for(a=Array.prototype.slice.call(arguments,1),o=(u=n.slice()).length,c=0;c<o;c++)u[c].apply(this,a);return!0},n.prototype.addListener=function(e,t){var o;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?r(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,r(this._events[e])&&!this._events[e].warned&&(o=s(this._maxListeners)?n.defaultMaxListeners:this._maxListeners)&&o>0&&this._events[e].length>o&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){if(!i(t))throw TypeError("listener must be a function");var n=!1;function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}return r.listener=t,this.on(e,r),this},n.prototype.removeListener=function(e,t){var n,s,o,a;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(n=this._events[e]).length,s=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(r(n)){for(a=o;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){s=a;break}if(s<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(s,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(i(n=this._events[e]))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t,n){"use strict";e.exports=function(e,t){return{USER_AGENT:e+"/"+t,SIP:"sip",SIPS:"sips",causes:{CONNECTION_ERROR:"Connection Error",REQUEST_TIMEOUT:"Request Timeout",SIP_FAILURE_CODE:"SIP Failure Code",INTERNAL_ERROR:"Internal Error",BUSY:"Busy",REJECTED:"Rejected",REDIRECTED:"Redirected",UNAVAILABLE:"Unavailable",NOT_FOUND:"Not Found",ADDRESS_INCOMPLETE:"Address Incomplete",INCOMPATIBLE_SDP:"Incompatible SDP",AUTHENTICATION_ERROR:"Authentication Error",DIALOG_ERROR:"Dialog Error",WEBRTC_NOT_SUPPORTED:"WebRTC Not Supported",WEBRTC_ERROR:"WebRTC Error",CANCELED:"Canceled",NO_ANSWER:"No Answer",EXPIRES:"Expires",NO_ACK:"No ACK",NO_PRACK:"No PRACK",USER_DENIED_MEDIA_ACCESS:"User Denied Media Access",BAD_MEDIA_DESCRIPTION:"Bad Media Description",RTP_TIMEOUT:"RTP Timeout"},supported:{UNSUPPORTED:"none",SUPPORTED:"supported",REQUIRED:"required"},SIP_ERROR_CAUSES:{REDIRECTED:[300,301,302,305,380],BUSY:[486,600],REJECTED:[403,603],NOT_FOUND:[404,604],UNAVAILABLE:[480,410,408,430],ADDRESS_INCOMPLETE:[484],INCOMPATIBLE_SDP:[488,606],AUTHENTICATION_ERROR:[401,407]},ACK:"ACK",BYE:"BYE",CANCEL:"CANCEL",INFO:"INFO",INVITE:"INVITE",MESSAGE:"MESSAGE",NOTIFY:"NOTIFY",OPTIONS:"OPTIONS",REGISTER:"REGISTER",UPDATE:"UPDATE",SUBSCRIBE:"SUBSCRIBE",PUBLISH:"PUBLISH",REFER:"REFER",PRACK:"PRACK",REASON_PHRASE:{100:"Trying",180:"Ringing",181:"Call Is Being Forwarded",182:"Queued",183:"Session Progress",199:"Early Dialog Terminated",200:"OK",202:"Accepted",204:"No Notification",300:"Multiple Choices",301:"Moved Permanently",302:"Moved Temporarily",305:"Use Proxy",380:"Alternative Service",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",410:"Gone",412:"Conditional Request Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Unsupported URI Scheme",417:"Unknown Resource-Priority",420:"Bad Extension",421:"Extension Required",422:"Session Interval Too Small",423:"Interval Too Brief",428:"Use Identity Header",429:"Provide Referrer Identity",430:"Flow Failed",433:"Anonymity Disallowed",436:"Bad Identity-Info",437:"Unsupported Certificate",438:"Invalid Identity Header",439:"First Hop Lacks Outbound Support",440:"Max-Breadth Exceeded",469:"Bad Info Package",470:"Consent Needed",478:"Unresolvable Destination",480:"Temporarily Unavailable",481:"Call/Transaction Does Not Exist",482:"Loop Detected",483:"Too Many Hops",484:"Address Incomplete",485:"Ambiguous",486:"Busy Here",487:"Request Terminated",488:"Not Acceptable Here",489:"Bad Event",491:"Request Pending",493:"Undecipherable",494:"Security Agreement Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Server Time-out",505:"Version Not Supported",513:"Message Too Large",580:"Precondition Failure",600:"Busy Everywhere",603:"Decline",604:"Does Not Exist Anywhere",606:"Not Acceptable"},OPTION_TAGS:{"100rel":!0,199:!0,answermode:!0,"early-session":!0,eventlist:!0,explicitsub:!0,"from-change":!0,"geolocation-http":!0,"geolocation-sip":!0,gin:!0,gruu:!0,histinfo:!0,ice:!0,join:!0,"multiple-refer":!0,norefersub:!0,nosub:!0,outbound:!0,path:!0,policy:!0,precondition:!0,pref:!0,privacy:!0,"recipient-list-invite":!0,"recipient-list-message":!0,"recipient-list-subscribe":!0,replaces:!0,"resource-priority":!0,"sdp-anat":!0,"sec-agree":!0,tdialog:!0,timer:!0,uui:!0},dtmfType:{INFO:"info",RTP:"rtp"}}}},function(e,t,n){"use strict";var i;e.exports={ConfigurationError:(i=function(e,t){this.code=1,this.name="CONFIGURATION_ERROR",this.parameter=e,this.value=t,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter},i.prototype=new Error,i),InvalidStateError:function(){var e=function(e){this.code=2,this.name="INVALID_STATE_ERROR",this.status=e,this.message="Invalid status: "+e};return e.prototype=new Error,e}(),NotSupportedError:function(){var e=function(e){this.code=3,this.name="NOT_SUPPORTED_ERROR",this.message=e};return e.prototype=new Error,e}(),GetDescriptionError:function(){var e=function(e){this.code=4,this.name="GET_DESCRIPTION_ERROR",this.message=e};return e.prototype=new Error,e}(),RenegotiationError:function(){var e=function(e){this.code=5,this.name="RENEGOTIATION_ERROR",this.message=e};return e.prototype=new Error,e}(),MethodParameterError:function(){var e=function(e,t,n){this.code=6,this.name="METHOD_PARAMETER_ERROR",this.method=e,this.parameter=t,this.value=n,this.message=this.value?"Invalid value "+JSON.stringify(this.value)+' for parameter "'+this.parameter+'"':"Missing parameter: "+this.parameter};return e.prototype=new Error,e}(),TransportError:function(){var e=function(e){this.code=7,this.name="TRANSPORT_ERROR",this.message=e};return e.prototype=new Error,e}(),SessionDescriptionHandlerError:function(){var e=function(e,t,n){this.code=8,this.name="SESSION_DESCRIPTION_HANDLER_ERROR",this.method=e,this.error=t,this.message=n||"Error with Session Description Handler"};return e.prototype=new Error,e}()}},function(e,t,n){"use strict";var i=500;e.exports=function(e){var t={T1:i,T2:4e3,T4:5e3,TIMER_B:32e3,TIMER_D:0,TIMER_F:32e3,TIMER_H:32e3,TIMER_I:0,TIMER_J:0,TIMER_K:0,TIMER_L:32e3,TIMER_M:32e3,TIMER_N:32e3,PROVISIONAL_RESPONSE_INTERVAL:6e4};return["setTimeout","clearTimeout","setInterval","clearInterval"].forEach(function(n){t[n]=function(){return e[n].apply(e,arguments)}}),t}},function(e,t,n){"use strict";e.exports=function(e){var t=function(e,t){};return t.prototype=Object.create(e.EventEmitter.prototype,{connect:{writable:!0,value:function(e){return e=e||{},this.connectPromise(e).then(function(e){!e.overrideEvent&&this.emit("connected")}.bind(this))}},connectPromise:{writable:!0,value:function(e){}},isConnected:{writable:!0,value:function(){}},send:{writable:!0,value:function(e,t){return t=t||{},this.sendPromise(e).then(function(e){!e.overrideEvent&&this.emit("messageSent",e.msg)}.bind(this))}},sendPromise:{writable:!0,value:function(e,t){}},onMessage:{writable:!0,value:function(e){}},disconnect:{writable:!0,value:function(e){return e=e||{},this.disconnectPromise(e).then(function(e){!e.overrideEvent&&this.emit("disconnected")}.bind(this))}},disconnectPromise:{writable:!0,value:function(e){}},afterConnected:{writable:!0,value:function(e){this.isConnected()?e():this.once("connected",e)}},waitForConnected:{writable:!0,value:function(){return console.warn("DEPRECATION WARNING Transport.waitForConnected(): use afterConnected() instead"),new e.Utils.Promise(function(e){this.afterConnected(e)}.bind(this))}}}),t}},function(e,t,n){"use strict";e.exports=function(e){var t;function n(e,t){var n=t,i=0,r=0;if(e.substring(n,n+2).match(/(^\r\n)/))return-2;for(;0===i;){if(-1===(r=e.indexOf("\r\n",n)))return r;!e.substring(r+2,r+4).match(/(^\r\n)/)&&e.charAt(r+2).match(/(^\s+)/)?n=r+2:i=r}return i}function i(t,n,i,r){var s,o,a,c,u=n.indexOf(":",i),h=n.substring(i,u).trim(),d=n.substring(u+1,r).trim();switch(h.toLowerCase()){case"via":case"v":t.addHeader("via",d),1===t.getHeaders("via").length?(c=t.parseHeader("Via"))&&(t.via=c,t.via_branch=c.branch):c=0;break;case"from":case"f":t.setHeader("from",d),(c=t.parseHeader("from"))&&(t.from=c,t.from_tag=c.getParam("tag"));break;case"to":case"t":t.setHeader("to",d),(c=t.parseHeader("to"))&&(t.to=c,t.to_tag=c.getParam("tag"));break;case"record-route":if(-1===(c=e.Grammar.parse(d,"Record_Route"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)s=c[o],t.addHeader("record-route",d.substring(s.position,s.offset)),t.headers["Record-Route"][t.getHeaders("record-route").length-1].parsed=s.parsed;break;case"call-id":case"i":t.setHeader("call-id",d),(c=t.parseHeader("call-id"))&&(t.call_id=d);break;case"contact":case"m":if(-1===(c=e.Grammar.parse(d,"Contact"))){c=void 0;break}for(a=c.length,o=0;o<a;o++)s=c[o],t.addHeader("contact",d.substring(s.position,s.offset)),t.headers.Contact[t.getHeaders("contact").length-1].parsed=s.parsed;break;case"content-length":case"l":t.setHeader("content-length",d),c=t.parseHeader("content-length");break;case"content-type":case"c":t.setHeader("content-type",d),c=t.parseHeader("content-type");break;case"cseq":t.setHeader("cseq",d),(c=t.parseHeader("cseq"))&&(t.cseq=c.value),t instanceof e.IncomingResponse&&(t.method=c.method);break;case"max-forwards":t.setHeader("max-forwards",d),c=t.parseHeader("max-forwards");break;case"www-authenticate":t.setHeader("www-authenticate",d),c=t.parseHeader("www-authenticate");break;case"proxy-authenticate":t.setHeader("proxy-authenticate",d),c=t.parseHeader("proxy-authenticate");break;case"refer-to":case"r":t.setHeader("refer-to",d),(c=t.parseHeader("refer-to"))&&(t.refer_to=c);break;default:t.setHeader(h,d),c=0}return void 0!==c||{error:'error parsing header "'+h+'"'}}(t={}).parseMessage=function(t,r){var s,o,a,c,u,h=0,d=t.indexOf("\r\n"),l=r.getLogger("sip.parser");if(-1!==d){if(o=t.substring(0,d),-1!==(u=e.Grammar.parse(o,"Request_Response"))){for(u.status_code?((s=new e.IncomingResponse(r)).status_code=u.status_code,s.reason_phrase=u.reason_phrase):((s=new e.IncomingRequest(r)).method=u.method,s.ruri=u.uri),s.data=t,h=d+2;;){if(-2===(d=n(t,h))){c=h+2;break}if(-1===d)return void l.error("malformed message");if(!0!==(u=i(s,t,h,d)))return void l.error(u.error);h=d+2}return s.hasHeader("content-length")?(a=s.getHeader("content-length"),s.body=t.substr(c,a)):s.body=t.substring(c),s}l.warn('error parsing first line of SIP message: "'+o+'"')}else l.warn("no CRLF found, not a SIP message, discarded")},e.Parser=t}},function(e,t,n){"use strict";e.exports=function(e){var t,n,i,r;function s(t){var n=t.ua.configuration.hackAllowUnregisteredOptionTags,i=[],r={};return t.method===e.C.REGISTER?i.push("path","gruu"):t.method===e.C.INVITE&&(t.ua.contact.pub_gruu||t.ua.contact.temp_gruu)&&i.push("gruu"),t.ua.configuration.rel100===e.C.supported.SUPPORTED&&i.push("100rel"),t.ua.configuration.replaces===e.C.supported.SUPPORTED&&i.push("replaces"),i.push("outbound"),"Supported: "+(i=(i=i.concat(t.ua.configuration.extraSupported)).filter(function(t){var i=e.C.OPTION_TAGS[t],s=!r[t];return r[t]=!0,(i||n)&&s})).join(", ")+"\r\n"}(t=function(t,n,i,r,s,o){var a,c,u,h,d,l;if(r=r||{},!t||!n||!i)return null;this.logger=i.getLogger("sip.sipmessage"),this.ua=i,this.headers={},this.method=t,this.ruri=n,this.body=o,this.extraHeaders=(s||[]).slice(),this.statusCode=r.status_code,this.reasonPhrase=r.reason_phrase,r.route_set?this.setHeader("route",r.route_set):i.configuration.usePreloadedRoute&&this.setHeader("route",i.transport.server.sip_uri),this.setHeader("via",""),this.setHeader("max-forwards",e.UA.C.MAX_FORWARDS),d=r.to_uri||n,a=r.to_displayName||0===r.to_displayName?'"'+r.to_displayName+'" ':"",a+="<"+(d&&d.toRaw?d.toRaw():d)+">",a+=r.to_tag?";tag="+r.to_tag:"",this.to=new e.NameAddrHeader.parse(a),this.setHeader("to",a),l=r.from_uri||i.configuration.uri,c=r.from_displayName||0===r.from_displayName?'"'+r.from_displayName+'" ':i.configuration.displayName?'"'+i.configuration.displayName+'" ':"",c+="<"+(l&&l.toRaw?l.toRaw():l)+">;tag=",c+=r.from_tag||e.Utils.newTag(),this.from=new e.NameAddrHeader.parse(c),this.setHeader("from",c),u=r.call_id||i.configuration.sipjsId+e.Utils.createRandomToken(15),this.call_id=u,this.setHeader("call-id",u),h=r.cseq||Math.floor(1e4*Math.random()),this.cseq=h,this.setHeader("cseq",h+" "+t)}).prototype={setHeader:function(t,n){this.headers[e.Utils.headerize(t)]=n instanceof Array?n:[n]},getHeader:function(t){var n,i,r=this.extraHeaders.length,s=this.headers[e.Utils.headerize(t)];if(s){if(s[0])return s[0]}else for(n=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<r;i++)if(s=this.extraHeaders[i],n.test(s))return s.substring(s.indexOf(":")+1).trim()},getHeaders:function(t){var n,i,r,s=this.headers[e.Utils.headerize(t)],o=[];if(s){for(i=s.length,n=0;n<i;n++)o.push(s[n]);return o}for(i=this.extraHeaders.length,r=new RegExp("^\\s*"+t+"\\s*:","i"),n=0;n<i;n++)s=this.extraHeaders[n],r.test(s)&&o.push(s.substring(s.indexOf(":")+1).trim());return o},hasHeader:function(t){var n,i,r=this.extraHeaders.length;if(this.headers[e.Utils.headerize(t)])return!0;for(n=new RegExp("^\\s*"+t+"\\s*:","i"),i=0;i<r;i++)if(n.test(this.extraHeaders[i]))return!0;return!1},toString:function(){var t,n,i,r="";for(t in r+=this.method+" "+(this.ruri.toRaw?this.ruri.toRaw():this.ruri)+" SIP/2.0\r\n",this.headers)for(n=this.headers[t].length,i=0;i<n;i++)r+=t+": "+this.headers[t][i]+"\r\n";for(n=this.extraHeaders.length,i=0;i<n;i++)r+=this.extraHeaders[i].trim()+"\r\n";return r+=s(this),r+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",this.body?"string"==typeof this.body?(r+="Content-Length: "+(n=e.Utils.str_utf8_length(this.body))+"\r\n\r\n",r+=this.body):this.body.body&&this.body.contentType?(n=e.Utils.str_utf8_length(this.body.body),r+="Content-Type: "+this.body.contentType+"\r\n",r+="Content-Length: "+n+"\r\n\r\n",r+=this.body.body):r+="Content-Length: 0\r\n\r\n":r+="Content-Length: 0\r\n\r\n",r}},(n=function(){this.data=null,this.headers=null,this.method=null,this.via=null,this.via_branch=null,this.call_id=null,this.cseq=null,this.from=null,this.from_tag=null,this.to=null,this.to_tag=null,this.body=null}).prototype={addHeader:function(t,n){var i={raw:n};t=e.Utils.headerize(t),this.headers[t]?this.headers[t].push(i):this.headers[t]=[i]},getHeader:function(t){var n=this.headers[e.Utils.headerize(t)];if(n)return n[0]?n[0].raw:void 0},getHeaders:function(t){var n,i,r=this.headers[e.Utils.headerize(t)],s=[];if(!r)return[];for(i=r.length,n=0;n<i;n++)s.push(r[n].raw);return s},hasHeader:function(t){return!!this.headers[e.Utils.headerize(t)]},parseHeader:function(t,n){var i,r,s;if(t=e.Utils.headerize(t),n=n||0,this.headers[t]){if(!(n>=this.headers[t].length))return r=(i=this.headers[t][n]).raw,i.parsed?i.parsed:-1===(s=e.Grammar.parse(r,t.replace(/-/g,"_")))?(this.headers[t].splice(n,1),void this.logger.warn('error parsing "'+t+'" header field with value "'+r+'"')):(i.parsed=s,s);this.logger.log('not so many "'+t+'" headers present')}else this.logger.log('header "'+t+'" not present')},s:function(e,t){return this.parseHeader(e,t)},setHeader:function(t,n){var i={raw:n};this.headers[e.Utils.headerize(t)]=[i]},toString:function(){return this.data}},((i=function(e){this.logger=e.getLogger("sip.sipmessage"),this.ua=e,this.headers={},this.ruri=null,this.transport=null,this.server_transaction=null}).prototype=new n).reply=function(t,n,i,r,o,a){var c,u,h,d,l,p=this.getHeader("To"),f=0,m=0;if(l=e.Utils.buildStatusLine(t,n),i=(i||[]).slice(),this.method===e.C.INVITE&&t>100&&t<=200)for(h=(c=this.getHeaders("record-route")).length;f<h;f++)l+="Record-Route: "+c[f]+"\r\n";for(h=(u=this.getHeaders("via")).length;m<h;m++)l+="Via: "+u[m]+"\r\n";for(!this.to_tag&&t>100?p+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(p+=";tag="+this.to_tag),l+="To: "+p+"\r\n",l+="From: "+this.getHeader("From")+"\r\n",l+="Call-ID: "+this.call_id+"\r\n",l+="CSeq: "+this.cseq+" "+this.method+"\r\n",h=i.length,d=0;d<h;d++)l+=i[d].trim()+"\r\n";return l+=s(this),l+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",r?"string"==typeof r?(l+="Content-Type: application/sdp\r\n",l+="Content-Length: "+(h=e.Utils.str_utf8_length(r))+"\r\n\r\n",l+=r):r.body&&r.contentType?(h=e.Utils.str_utf8_length(r.body),l+="Content-Type: "+r.contentType+"\r\n",l+="Content-Length: "+h+"\r\n\r\n",l+=r.body):l+="Content-Length: 0\r\n\r\n":l+="Content-Length: 0\r\n\r\n",this.server_transaction.receiveResponse(t,l).then(o,a),l},i.prototype.reply_sl=function(t,n){var i,r,s=0,o=this.getHeaders("via"),a=o.length;for(r=e.Utils.buildStatusLine(t,n);s<a;s++)r+="Via: "+o[s]+"\r\n";i=this.getHeader("To"),!this.to_tag&&t>100?i+=";tag="+e.Utils.newTag():this.to_tag&&!this.s("to").hasParam("tag")&&(i+=";tag="+this.to_tag),r+="To: "+i+"\r\n",r+="From: "+this.getHeader("From")+"\r\n",r+="Call-ID: "+this.call_id+"\r\n",r+="CSeq: "+this.cseq+" "+this.method+"\r\n",r+="User-Agent: "+this.ua.configuration.userAgentString+"\r\n",r+="Content-Length: 0\r\n\r\n",this.transport.send(r)},(r=function(e){this.logger=e.getLogger("sip.sipmessage"),this.headers={},this.status_code=null,this.reason_phrase=null}).prototype=new n,e.OutgoingRequest=t,e.IncomingRequest=i,e.IncomingResponse=r}},function(e,t,n){"use strict";e.exports=function(e){var t;(t=function(t,n,i,r,s,o){var a,c,u,h;if(!i)throw new TypeError('missing or invalid "host" parameter');for(a in t=t||e.C.SIP,this.parameters={},this.headers={},s)this.setParam(a,s[a]);for(c in o)this.setHeader(c,o[c]);u={scheme:t,user:n,host:i,port:r},h={scheme:t.toLowerCase(),user:n,host:i.toLowerCase(),port:r},Object.defineProperties(this,{_normal:{get:function(){return h}},_raw:{get:function(){return u}},scheme:{get:function(){return h.scheme},set:function(e){u.scheme=e,h.scheme=e.toLowerCase()}},user:{get:function(){return h.user},set:function(e){h.user=u.user=e}},host:{get:function(){return h.host},set:function(e){u.host=e,h.host=e.toLowerCase()}},aor:{get:function(){return h.user+"@"+h.host}},port:{get:function(){return h.port},set:function(e){h.port=u.port=0===e?e:parseInt(e,10)||null}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=null==t?null:t.toString())},getParam:function(e){if(e)return this.parameters[e.toLowerCase()]},hasParam:function(e){if(e)return!!this.parameters.hasOwnProperty(e.toLowerCase())},deleteParam:function(e){var t;if(e=e.toLowerCase(),this.parameters.hasOwnProperty(e))return t=this.parameters[e],delete this.parameters[e],t},clearParams:function(){this.parameters={}},setHeader:function(t,n){this.headers[e.Utils.headerize(t)]=n instanceof Array?n:[n]},getHeader:function(t){if(t)return this.headers[e.Utils.headerize(t)]},hasHeader:function(t){if(t)return!!this.headers.hasOwnProperty(e.Utils.headerize(t))},deleteHeader:function(t){var n;if(t=e.Utils.headerize(t),this.headers.hasOwnProperty(t))return n=this.headers[t],delete this.headers[t],n},clearHeaders:function(){this.headers={}},clone:function(){return new t(this._raw.scheme,this._raw.user,this._raw.host,this._raw.port,JSON.parse(JSON.stringify(this.parameters)),JSON.parse(JSON.stringify(this.headers)))},toRaw:function(){return this._toString(this._raw)},toString:function(){return this._toString(this._normal)},_toString:function(t){var n,i,r,s,o=[];for(i in s=t.scheme+":",t.scheme.toLowerCase().match("^sips?$")||(s+="//"),t.user&&(s+=e.Utils.escapeUser(t.user)+"@"),s+=t.host,(t.port||0===t.port)&&(s+=":"+t.port),this.parameters)s+=";"+i,null!==this.parameters[i]&&(s+="="+this.parameters[i]);for(n in this.headers)for(r in this.headers[n])o.push(n+"="+this.headers[n][r]);return o.length>0&&(s+="?"+o.join("&")),s}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"SIP_URI"))?t:void 0},e.URI=t}},function(e,t,n){"use strict";e.exports=function(e){var t;(t=function(t,n,i){var r;if(!(t&&t instanceof e.URI))throw new TypeError('missing or invalid "uri" parameter');for(r in this.uri=t,this.parameters={},i)this.setParam(r,i[r]);Object.defineProperties(this,{friendlyName:{get:function(){return this.displayName||t.aor}},displayName:{get:function(){return n},set:function(e){n=0===e?"0":e}}})}).prototype={setParam:function(e,t){e&&(this.parameters[e.toLowerCase()]=null==t?null:t.toString())},getParam:e.URI.prototype.getParam,hasParam:e.URI.prototype.hasParam,deleteParam:e.URI.prototype.deleteParam,clearParams:e.URI.prototype.clearParams,clone:function(){return new t(this.uri.clone(),this.displayName,JSON.parse(JSON.stringify(this.parameters)))},toString:function(){var e,t;for(t in e=this.displayName||0===this.displayName?'"'+this.displayName+'" ':"",e+="<"+this.uri.toString()+">",this.parameters)e+=";"+t,null!==this.parameters[t]&&(e+="="+this.parameters[t]);return e}},t.parse=function(t){return-1!==(t=e.Grammar.parse(t,"Name_Addr_Header"))?t:void 0},e.NameAddrHeader=t}},function(e,t,n){"use strict";e.exports=function(e){var t={STATUS_TRYING:1,STATUS_PROCEEDING:2,STATUS_CALLING:3,STATUS_ACCEPTED:4,STATUS_COMPLETED:5,STATUS_TERMINATED:6,STATUS_CONFIRMED:7,NON_INVITE_CLIENT:"nict",NON_INVITE_SERVER:"nist",INVITE_CLIENT:"ict",INVITE_SERVER:"ist"};function n(e,t,n){var i;return i="SIP/2.0/"+(e.ua.configuration.hackViaTcp?"TCP":t.server.scheme),i+=" "+e.ua.configuration.viaHost+";branch="+n,e.ua.configuration.forceRport&&(i+=";rport"),i}var i=function(e,i,r){var s;this.type=t.NON_INVITE_CLIENT,this.transport=r,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=i,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),s=n(e,r,this.id),this.request.setHeader("via",s),this.request_sender.ua.newTransaction(this)};(i.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},i.prototype.send=function(){this.stateChanged(t.STATUS_TRYING),this.F=e.Timers.setTimeout(this.timer_F.bind(this),e.Timers.TIMER_F),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},i.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting non-INVITE client transaction "+this.id),e.Timers.clearTimeout(this.F),e.Timers.clearTimeout(this.K),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onTransportError()},i.prototype.timer_F=function(){this.logger.debug("Timer F expired for non-INVITE client transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout()},i.prototype.timer_K=function(){this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},i.prototype.receiveResponse=function(n){var i=n.status_code;if(i<200)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(n)}else switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),e.Timers.clearTimeout(this.F),408===i?this.request_sender.onRequestTimeout():this.request_sender.receiveResponse(n),this.K=e.Timers.setTimeout(this.timer_K.bind(this),e.Timers.TIMER_K)}};var r=function(e,i,r){var s,o=this;this.type=t.INVITE_CLIENT,this.transport=r,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=i,this.logger=e.ua.getLogger("sip.transaction.ict",this.id),s=n(e,r,this.id),this.request.setHeader("via",s),this.request_sender.ua.newTransaction(this),this.request.cancel=function(e,t){for(var n=(t=(t||[]).slice()).length,i=null,r=0;r<n;r++)i=(i||"")+t[r].trim()+"\r\n";o.cancel_request(o,e,i)}};(r.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},r.prototype.send=function(){this.stateChanged(t.STATUS_CALLING),this.B=e.Timers.setTimeout(this.timer_B.bind(this),e.Timers.TIMER_B),this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},r.prototype.onTransportError=function(){this.logger.log("transport error occurred, deleting INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),e.Timers.clearTimeout(this.D),e.Timers.clearTimeout(this.M),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.state!==t.STATUS_ACCEPTED&&this.request_sender.onTransportError()},r.prototype.timer_M=function(){this.logger.debug("Timer M expired for INVITE client transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this))},r.prototype.timer_B=function(){this.logger.debug("Timer B expired for INVITE client transaction "+this.id),this.state===t.STATUS_CALLING&&(this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this),this.request_sender.onRequestTimeout())},r.prototype.timer_D=function(){this.logger.debug("Timer D expired for INVITE client transaction "+this.id),e.Timers.clearTimeout(this.B),this.stateChanged(t.STATUS_TERMINATED),this.request_sender.ua.destroyTransaction(this)},r.prototype.sendACK=function(t){var n,i=this;t=t||{},n=this.response.getHeader("contact")?this.response.parseHeader("contact").uri:this.request.ruri;var r=new e.OutgoingRequest("ACK",n,this.request.ua,{cseq:this.response.cseq,call_id:this.response.call_id,from_uri:this.response.from.uri,from_tag:this.response.from_tag,to_uri:this.response.to.uri,to_tag:this.response.to_tag,route_set:this.response.getHeaders("record-route").reverse()},t.extraHeaders||[],t.body);return this.ackSender=new e.RequestSender({request:r,onRequestTimeout:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTimeout:function(){i.logger.warn("ACK Request timed out")},onTransportError:this.request_sender.applicant.applicant?this.request_sender.applicant.applicant.onRequestTransportError:function(){i.logger.warn("ACK Request had a transport error")},receiveResponse:t.receiveResponse||function(){i.logger.warn("Received a response to an ACK which was unexpected. Dropping Response.")}},this.request.ua).send(),r},r.prototype.cancel_request=function(n,i,r){var s=n.request;this.cancel=e.C.CANCEL+" "+s.ruri+" SIP/2.0\r\n",this.cancel+="Via: "+s.headers.Via.toString()+"\r\n",this.request.headers.Route&&(this.cancel+="Route: "+s.headers.Route.toString()+"\r\n"),this.cancel+="To: "+s.headers.To.toString()+"\r\n",this.cancel+="From: "+s.headers.From.toString()+"\r\n",this.cancel+="Call-ID: "+s.headers["Call-ID"].toString()+"\r\n",this.cancel+="Max-Forwards: "+e.UA.C.MAX_FORWARDS+"\r\n",this.cancel+="CSeq: "+s.headers.CSeq.toString().split(" ")[0]+" CANCEL\r\n",i&&(this.cancel+="Reason: "+i+"\r\n"),r&&(this.cancel+=r),this.cancel+="Content-Length: 0\r\n\r\n",this.state===t.STATUS_PROCEEDING&&this.transport.send(this.cancel)},r.prototype.receiveResponse=function(n){var i=n.status_code;if(n.transaction=this,this.response&&this.response.status_code===n.status_code&&this.response.cseq===n.cseq)return this.logger.debug("ICT Received a retransmission for cseq: "+n.cseq),void(this.ackSender&&this.ackSender.send());if(this.response=n,i>=100&&i<=199)switch(this.state){case t.STATUS_CALLING:this.stateChanged(t.STATUS_PROCEEDING),this.request_sender.receiveResponse(n),this.cancel&&this.transport.send(this.cancel);break;case t.STATUS_PROCEEDING:this.request_sender.receiveResponse(n)}else if(i>=200&&i<=299)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.M=e.Timers.setTimeout(this.timer_M.bind(this),e.Timers.TIMER_M),this.request_sender.receiveResponse(n);break;case t.STATUS_ACCEPTED:this.request_sender.receiveResponse(n)}else if(i>=300&&i<=699)switch(this.state){case t.STATUS_CALLING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.sendACK(),this.request_sender.receiveResponse(n);break;case t.STATUS_COMPLETED:this.sendACK()}};var s=function(e,t,i){var r;this.transport=i,this.id="z9hG4bK"+Math.floor(1e7*Math.random()),this.request_sender=e,this.request=t,this.logger=e.ua.getLogger("sip.transaction.nict",this.id),r=n(e,i,this.id),this.request.setHeader("via",r)};(s.prototype=Object.create(e.EventEmitter.prototype)).send=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},s.prototype.onTransportError=function(){this.logger.log("transport error occurred, for an ACK client transaction "+this.id),this.request_sender.onTransportError()};var o=function(e,n){this.type=t.NON_INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=n.transport,this.ua=n,this.last_response="",e.server_transaction=this,this.logger=n.getLogger("sip.transaction.nist",this.id),this.state=t.STATUS_TRYING,n.newTransaction(this)};(o.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},o.prototype.timer_J=function(){this.logger.debug("Timer J expired for non-INVITE server transaction "+this.id),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},o.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting non-INVITE server transaction "+this.id),e.Timers.clearTimeout(this.J),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},o.prototype.receiveResponse=function(n,i){var r=e.Utils.defer();if(100===n)switch(this.state){case t.STATUS_TRYING:this.stateChanged(t.STATUS_PROCEEDING),this.transport.send(i).catch(function(){this.onTransportError()}.bind(this));break;case t.STATUS_PROCEEDING:this.last_response=i,this.transport.send(i).then(function(){r.resolve()}).catch(function(){this.onTransportError(),r.reject()}.bind(this))}else if(n>=200&&n<=699)switch(this.state){case t.STATUS_TRYING:case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_COMPLETED),this.last_response=i,this.J=e.Timers.setTimeout(this.timer_J.bind(this),e.Timers.TIMER_J),this.transport.send(i).then(function(){r.resolve()}).catch(function(){this.onTransportError(),r.reject()}.bind(this))}return r.promise};var a=function(e,n){this.type=t.INVITE_SERVER,this.id=e.via_branch,this.request=e,this.transport=n.transport,this.ua=n,this.last_response="",e.server_transaction=this,this.logger=n.getLogger("sip.transaction.ist",this.id),this.state=t.STATUS_PROCEEDING,n.newTransaction(this),this.resendProvisionalTimer=null,e.reply(100)};(a.prototype=Object.create(e.EventEmitter.prototype)).stateChanged=function(e){this.state=e,this.emit("stateChanged")},a.prototype.timer_H=function(){this.logger.debug("Timer H expired for INVITE server transaction "+this.id),this.state===t.STATUS_COMPLETED&&this.logger.warn("transactions","ACK for INVITE server transaction was never received, call will be terminated"),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_I=function(){this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this)},a.prototype.timer_L=function(){this.logger.debug("Timer L expired for INVITE server transaction "+this.id),this.state===t.STATUS_ACCEPTED&&(this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.onTransportError=function(){this.transportError||(this.transportError=!0,this.logger.log("transport error occurred, deleting INVITE server transaction "+this.id),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),e.Timers.clearTimeout(this.L),e.Timers.clearTimeout(this.H),e.Timers.clearTimeout(this.I),this.stateChanged(t.STATUS_TERMINATED),this.ua.destroyTransaction(this))},a.prototype.resend_provisional=function(){this.transport.send(this.request).catch(function(){this.onTransportError()}.bind(this))},a.prototype.receiveResponse=function(n,i){var r=this,s=e.Utils.defer();if(n>=100&&n<=199)switch(this.state){case t.STATUS_PROCEEDING:this.transport.send(i).catch(function(){this.onTransportError()}.bind(this)),this.last_response=i}if(n>100&&n<=199&&this.state===t.STATUS_PROCEEDING)null===this.resendProvisionalTimer&&(this.resendProvisionalTimer=e.Timers.setInterval(r.resend_provisional.bind(r),e.Timers.PROVISIONAL_RESPONSE_INTERVAL));else if(n>=200&&n<=299)switch(this.state){case t.STATUS_PROCEEDING:this.stateChanged(t.STATUS_ACCEPTED),this.last_response=i,this.L=e.Timers.setTimeout(r.timer_L.bind(r),e.Timers.TIMER_L),null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null);case t.STATUS_ACCEPTED:this.transport.send(i).then(function(){s.resolve()}).catch(function(e){this.logger.error(e),this.onTransportError(),s.reject()}.bind(this))}else if(n>=300&&n<=699)switch(this.state){case t.STATUS_PROCEEDING:null!==this.resendProvisionalTimer&&(e.Timers.clearInterval(this.resendProvisionalTimer),this.resendProvisionalTimer=null),this.transport.send(i).then(function(){this.stateChanged(t.STATUS_COMPLETED),this.H=e.Timers.setTimeout(r.timer_H.bind(r),e.Timers.TIMER_H),s.resolve()}.bind(this)).catch(function(e){this.logger.error(e),this.onTransportError(),s.reject()}.bind(this))}return s.promise},e.Transactions={C:t,checkTransaction:function(n,i){var r;switch(i.method){case e.C.INVITE:if(r=n.transactions.ist[i.via_branch]){switch(r.state){case t.STATUS_PROCEEDING:r.transport.send(r.last_response)}return!0}break;case e.C.ACK:if(!(r=n.transactions.ist[i.via_branch]))return!1;if(r.state===t.STATUS_ACCEPTED)return!1;if(r.state===t.STATUS_COMPLETED)return r.stateChanged(t.STATUS_CONFIRMED),r.I=e.Timers.setTimeout(r.timer_I.bind(r),e.Timers.TIMER_I),!0;break;case e.C.CANCEL:return(r=n.transactions.ist[i.via_branch])?(i.reply_sl(200),r.state!==t.STATUS_PROCEEDING):(i.reply_sl(481),!0);default:if(r=n.transactions.nist[i.via_branch]){switch(r.state){case t.STATUS_TRYING:break;case t.STATUS_PROCEEDING:case t.STATUS_COMPLETED:r.transport.send(r.last_response)}return!0}}},NonInviteClientTransaction:i,InviteClientTransaction:r,AckClientTransaction:s,NonInviteServerTransaction:o,InviteServerTransaction:a}}},function(e,t,n){"use strict";e.exports=function(e){var t,i=n(17)(e),r={STATUS_EARLY:1,STATUS_CONFIRMED:2};(t=function(t,n,i,s){var o;if(this.uac_pending_reply=!1,this.uas_pending_reply=!1,!n.hasHeader("contact"))return{error:"unable to create a Dialog without Contact header field"};s=n instanceof e.IncomingResponse?n.status_code<200?r.STATUS_EARLY:r.STATUS_CONFIRMED:s||r.STATUS_CONFIRMED,o=n.parseHeader("contact"),"UAS"===i?(this.id={call_id:n.call_id,local_tag:n.to_tag,remote_tag:n.from_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=s,this.remote_seqnum=n.cseq,this.local_uri=n.parseHeader("to").uri,this.remote_uri=n.parseHeader("from").uri,this.remote_target=o.uri,this.route_set=n.getHeaders("record-route"),this.invite_seqnum=n.cseq,this.local_seqnum=n.cseq):"UAC"===i&&(this.id={call_id:n.call_id,local_tag:n.from_tag,remote_tag:n.to_tag,toString:function(){return this.call_id+this.local_tag+this.remote_tag}},this.state=s,this.invite_seqnum=n.cseq,this.local_seqnum=n.cseq,this.local_uri=n.parseHeader("from").uri,this.pracked=[],this.remote_uri=n.parseHeader("to").uri,this.remote_target=o.uri,this.route_set=n.getHeaders("record-route").reverse()),this.logger=t.ua.getLogger("sip.dialog",this.id.toString()),this.owner=t,t.ua.dialogs[this.id.toString()]=this,this.logger.log("new "+i+" dialog created with status "+(this.state===r.STATUS_EARLY?"EARLY":"CONFIRMED")),t.emit("dialog",this)}).prototype={update:function(e,t){this.state=r.STATUS_CONFIRMED,this.logger.log("dialog "+this.id.toString()+"  changed to CONFIRMED state"),"UAC"===t&&(this.route_set=e.getHeaders("record-route").reverse())},terminate:function(){this.logger.log("dialog "+this.id.toString()+" deleted"),this.sessionDescriptionHandler&&this.state!==r.STATUS_CONFIRMED&&this.sessionDescriptionHandler.close(),delete this.owner.ua.dialogs[this.id.toString()]},createRequest:function(t,n,i){var r,s;return n=(n||[]).slice(),this.local_seqnum||(this.local_seqnum=Math.floor(1e4*Math.random())),r=t===e.C.CANCEL||t===e.C.ACK?this.invite_seqnum:this.local_seqnum+=1,(s=new e.OutgoingRequest(t,this.remote_target,this.owner.ua,{cseq:r,call_id:this.id.call_id,from_uri:this.local_uri,from_tag:this.id.local_tag,to_uri:this.remote_uri,to_tag:this.id.remote_tag,route_set:this.route_set},n,i)).dialog=this,s},checkInDialogRequest:function(t){var n=this;if(this.remote_seqnum){if(t.cseq<this.remote_seqnum)return t.method!==e.C.ACK&&t.reply(500),t.cseq===this.invite_seqnum}else this.remote_seqnum=t.cseq;switch(t.method){case e.C.INVITE:if(!0===this.uac_pending_reply)t.reply(491);else{if(!0===this.uas_pending_reply&&t.cseq>this.remote_seqnum){var i=1+(10*Math.random()|0);return t.reply(500,null,["Retry-After:"+i]),this.remote_seqnum=t.cseq,!1}this.uas_pending_reply=!0,t.server_transaction.on("stateChanged",function t(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",t),n.uas_pending_reply=!1)})}t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_ACCEPTED&&(n.remote_target=t.parseHeader("contact").uri)});break;case e.C.NOTIFY:t.hasHeader("contact")&&t.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_COMPLETED&&(n.remote_target=t.parseHeader("contact").uri)})}return t.cseq>this.remote_seqnum&&(this.remote_seqnum=t.cseq),!0},sendRequest:function(e,t,n){var r=((n=n||{}).extraHeaders||[]).slice(),s=null;n.body&&(n.body.body?s=n.body:((s={}).body=n.body,n.contentType&&(s.contentType=n.contentType)));var o=this.createRequest(t,r,s);return new i(this,e,o).send(),o},receiveRequest:function(e){this.checkInDialogRequest(e)&&this.owner.receiveRequest(e)}},t.C=r,e.Dialog=t}},function(e,t,n){"use strict";e.exports=function(e){var t;return(t=function(e,t,n){this.dialog=e,this.applicant=t,this.request=n,this.reattempt=!1,this.reattemptTimer=null}).prototype={send:function(){var t=this,n=new e.RequestSender(this,this.dialog.owner.ua);n.send(),this.request.method===e.C.INVITE&&n.clientTransaction.state!==e.Transactions.C.STATUS_TERMINATED&&(this.dialog.uac_pending_reply=!0,n.clientTransaction.on("stateChanged",function n(){this.state!==e.Transactions.C.STATUS_ACCEPTED&&this.state!==e.Transactions.C.STATUS_COMPLETED&&this.state!==e.Transactions.C.STATUS_TERMINATED||(this.removeListener("stateChanged",n),t.dialog.uac_pending_reply=!1)}))},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var n=this;408===t.status_code||481===t.status_code?this.applicant.onDialogError(t):t.method===e.C.INVITE&&491===t.status_code?this.reattempt?this.applicant.receiveResponse(t):(this.request.cseq.value=this.dialog.local_seqnum+=1,this.reattemptTimer=e.Timers.setTimeout(function(){n.applicant.owner.status!==e.Session.C.STATUS_TERMINATED&&(n.reattempt=!0,n.request_sender.send())},this.getReattemptTimeout())):this.applicant.receiveResponse(t)}},t}},function(e,t,n){"use strict";e.exports=function(e){var t;(t=function(t,n){this.logger=n.getLogger("sip.requestsender"),this.ua=n,this.applicant=t,this.method=t.request.method,this.request=t.request,this.credentials=null,this.challenged=!1,this.staled=!1,n.status!==e.UA.C.STATUS_USER_CLOSED||this.method===e.C.BYE&&this.method===e.C.ACK||this.onTransportError()}).prototype={send:function(){switch(this.method){case"INVITE":this.clientTransaction=new e.Transactions.InviteClientTransaction(this,this.request,this.ua.transport);break;case"ACK":this.clientTransaction=new e.Transactions.AckClientTransaction(this,this.request,this.ua.transport);break;default:this.clientTransaction=new e.Transactions.NonInviteClientTransaction(this,this.request,this.ua.transport)}return this.clientTransaction.send(),this.clientTransaction},onRequestTimeout:function(){this.applicant.onRequestTimeout()},onTransportError:function(){this.applicant.onTransportError()},receiveResponse:function(t){var n,i,r,s=t.status_code;if(401===s||407===s){if(401===t.status_code?(i=t.parseHeader("www-authenticate"),r="authorization"):(i=t.parseHeader("proxy-authenticate"),r="proxy-authorization"),!i)return this.logger.warn(t.status_code+" with wrong or missing challenge, cannot authenticate"),void this.applicant.receiveResponse(t);if(!this.challenged||!this.staled&&!0===i.stale){if(this.credentials||(this.credentials=this.ua.configuration.authenticationFactory(this.ua)),!this.credentials.authenticate(this.request,i))return void this.applicant.receiveResponse(t);this.challenged=!0,i.stale&&(this.staled=!0),t.method===e.C.REGISTER?n=this.applicant.cseq+=1:this.request.dialog?n=this.request.dialog.local_seqnum+=1:(n=this.request.cseq+1,this.request.cseq=n),this.request.setHeader("cseq",n+" "+this.method),this.request.setHeader(r,this.credentials.toString()),this.send()}else this.applicant.receiveResponse(t)}else this.applicant.receiveResponse(t)}},e.RequestSender=t}},function(e,t,n){"use strict";e.exports=function(e){var t;(t=function(t){var n={};this.registrar=t.configuration.registrarServer,this.expires=t.configuration.registerExpires,this.contact=t.contact.toString(),this.contact+=";reg-id=1",this.contact+=';+sip.instance="<urn:uuid:'+t.configuration.instanceId+'>"',this.call_id=e.Utils.createRandomToken(22),this.cseq=Math.floor(1e4*Math.random()),this.to_uri=t.configuration.uri,n.to_uri=this.to_uri,n.to_displayName=t.configuration.displayName,n.call_id=this.call_id,n.cseq=this.cseq,e.Utils.augment(this,e.ClientContext,[t,"REGISTER",this.registrar,{params:n}]),this.registrationTimer=null,this.registrationExpiredTimer=null,this.registered=!1,this.logger=t.getLogger("sip.registercontext"),t.on("transportCreated",function(e){e.on("disconnected",this.onTransportDisconnected.bind(this))}.bind(this))}).prototype=Object.create({},{register:{writable:!0,value:function(t){var n,i=this;this.options=t||{},(n=(this.options.extraHeaders||[]).slice()).push("Contact: "+this.contact+";expires="+this.expires),n.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.closeHeaders=this.options.closeWithHeaders?(this.options.extraHeaders||[]).slice():[],this.receiveResponse=function(t){var n,r,s,o=t.getHeaders("contact").length;if(t.cseq===this.cseq)switch(null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.emit("accepted",t),t.hasHeader("expires")&&(r=t.getHeader("expires")),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),!o){this.logger.warn("no Contact header in response to REGISTER, response ignored");break}for(;o--;){if((n=t.parseHeader("contact",o)).uri.user===this.ua.contact.uri.user){r=n.getParam("expires");break}n=null}if(!n){this.logger.warn("no Contact header pointing to us, response ignored");break}r||(r=this.expires),this.registrationTimer=e.Timers.setTimeout(function(){i.registrationTimer=null,i.register(i.options)},1e3*r-3e3),this.registrationExpiredTimer=e.Timers.setTimeout(function(){i.logger.warn("registration expired"),i.registered&&i.unregistered(null,e.C.causes.EXPIRES)},1e3*r),n.hasParam("temp-gruu")&&(this.ua.contact.temp_gruu=e.URI.parse(n.getParam("temp-gruu").replace(/"/g,""))),n.hasParam("pub-gruu")&&(this.ua.contact.pub_gruu=e.URI.parse(n.getParam("pub-gruu").replace(/"/g,""))),this.registered=!0,this.emit("registered",t||null);break;case/^423$/.test(t.status_code):t.hasHeader("min-expires")?(this.expires=t.getHeader("min-expires"),this.register(this.options)):(this.logger.warn("423 response received for REGISTER without Min-Expires"),this.registrationFailure(t,e.C.causes.SIP_FAILURE_CODE));break;default:s=e.Utils.sipErrorCause(t.status_code),this.registrationFailure(t,s)}},this.onRequestTimeout=function(){this.registrationFailure(null,e.C.causes.REQUEST_TIMEOUT)},this.onTransportError=function(){this.registrationFailure(null,e.C.causes.CONNECTION_ERROR)},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=n,this.send()}},registrationFailure:{writable:!0,value:function(e,t){this.emit("failed",e||null,t||null)}},onTransportDisconnected:{writable:!0,value:function(){this.registered_before=this.registered,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.registered&&this.unregistered(null,e.C.causes.CONNECTION_ERROR)}},onTransportConnected:{writable:!0,value:function(){this.register(this.options)}},close:{writable:!0,value:function(){var e={all:!1,extraHeaders:this.closeHeaders};this.registered_before=this.registered,this.registered&&this.unregister(e)}},unregister:{writable:!0,value:function(t){var n;t=t||{},this.registered||t.all||this.logger.warn("Already unregistered, but sending an unregister anyways."),n=(t.extraHeaders||[]).slice(),this.registered=!1,null!==this.registrationTimer&&(e.Timers.clearTimeout(this.registrationTimer),this.registrationTimer=null),t.all?(n.push("Contact: *"),n.push("Expires: 0")):n.push("Contact: "+this.contact+";expires=0"),this.receiveResponse=function(t){var n;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("accepted",t),null!==this.registrationExpiredTimer&&(e.Timers.clearTimeout(this.registrationExpiredTimer),this.registrationExpiredTimer=null),this.unregistered(t);break;default:n=e.Utils.sipErrorCause(t.status_code),this.unregistered(t,n)}},this.onRequestTimeout=function(){},this.cseq++,this.request.cseq=this.cseq,this.request.setHeader("cseq",this.cseq+" REGISTER"),this.request.extraHeaders=n,this.send()}},unregistered:{writable:!0,value:function(e,t){this.registered=!1,this.emit("unregistered",e||null,t||null)}}}),e.RegisterContext=t}},function(e,t,n){"use strict";e.exports=function(e){var t=function(){};return t.prototype=Object.create(e.prototype,{close:{value:function(){}},getDescription:{value:function(e,t){}},hasDescription:{value:function(e){}},holdModifier:{value:function(e){}},setDescription:{value:function(e,t,n){}},sendDtmf:{value:function(e,t){}},getDirection:{value:function(){}}}),t}},function(e,t,n){"use strict";e.exports=function(e){var t;((t=function(t,n,i,r){var s=i;if(void 0===i)throw new TypeError("Not enough arguments");if(this.ua=t,this.logger=t.getLogger("sip.clientcontext"),this.method=n,!(i=t.normalizeTarget(i)))throw new TypeError("Invalid target: "+s);(r=Object.create(r||Object.prototype)).extraHeaders=(r.extraHeaders||[]).slice(),this.request=new e.OutgoingRequest(this.method,i,this.ua,r.params,r.extraHeaders),r.body&&(this.body={},this.body.body=r.body,r.contentType&&(this.body.contentType=r.contentType),this.request.body=this.body),this.localIdentity=this.request.from,this.remoteIdentity=this.request.to,this.data={}}).prototype=Object.create(e.EventEmitter.prototype)).send=function(){return new e.RequestSender(this,this.ua).send(),this},t.prototype.cancel=function(t){(t=t||{}).extraHeaders=(t.extraHeaders||[]).slice();var n=e.Utils.getCancelReason(t.status_code,t.reason_phrase);this.request.cancel(n,t.extraHeaders),this.emit("cancel")},t.prototype.receiveResponse=function(t){var n=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,n);break;case/^2[0-9]{2}$/.test(t.status_code):this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("accepted",t,n);break;default:this.ua.applicants[this]&&delete this.ua.applicants[this],this.emit("rejected",t,n),this.emit("failed",t,n)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ClientContext=t}},function(e,t,n){"use strict";e.exports=function(e){var t;((t=function(t,n){this.ua=t,this.logger=t.getLogger("sip.servercontext"),this.request=n,n.method===e.C.INVITE?this.transaction=new e.Transactions.InviteServerTransaction(n,t):this.transaction=new e.Transactions.NonInviteServerTransaction(n,t),n.body&&(this.body=n.body),n.hasHeader("Content-Type")&&(this.contentType=n.getHeader("Content-Type")),this.method=n.method,this.data={},this.localIdentity=n.to,this.remoteIdentity=n.from,n.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(n.getHeader("P-Asserted-Identity")))}).prototype=Object.create(e.EventEmitter.prototype)).progress=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=180),e.minCode=100,e.maxCode=199,e.events=["progress"],this.reply(e)},t.prototype.accept=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=200),e.minCode=200,e.maxCode=299,e.events=["accepted"],this.reply(e)},t.prototype.reject=function(e){return(e=Object.create(e||Object.prototype)).statusCode||(e.statusCode=480),e.minCode=300,e.maxCode=699,e.events=["rejected","failed"],this.reply(e)},t.prototype.reply=function(t){var n,i=(t=t||{}).statusCode||100,r=t.minCode||100,s=t.maxCode||699,o=e.Utils.getReasonPhrase(i,t.reasonPhrase),a=t.extraHeaders||[],c=t.body,u=t.events||[];if(i<r||i>s)throw new TypeError("Invalid statusCode: "+i);return n=this.request.reply(i,o,a,c),u.forEach(function(e){this.emit(e,n,o)},this),this},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR)},e.ServerContext=t}},function(e,t,n){"use strict";e.exports=function(e){var t,i,r,s,o,a=n(24)(e),c={STATUS_NULL:0,STATUS_INVITE_SENT:1,STATUS_1XX_RECEIVED:2,STATUS_INVITE_RECEIVED:3,STATUS_WAITING_FOR_ANSWER:4,STATUS_ANSWERED:5,STATUS_WAITING_FOR_PRACK:6,STATUS_WAITING_FOR_ACK:7,STATUS_CANCELED:8,STATUS_TERMINATED:9,STATUS_ANSWERED_WAITING_FOR_PRACK:10,STATUS_EARLY_MEDIA:11,STATUS_CONFIRMED:12};(t=function(t){if(this.status=c.STATUS_NULL,this.dialog=null,this.pendingReinvite=!1,this.earlyDialogs={},!t)throw new e.Exceptions.SessionDescriptionHandlerMissing("A session description handler is required for the session to function");this.sessionDescriptionHandlerFactory=t,this.hasOffer=!1,this.hasAnswer=!1,this.timers={ackTimer:null,expiresTimer:null,invite2xxTimer:null,userNoAnswerTimer:null,rel1xxTimer:null,prackTimer:null},this.startTime=null,this.endTime=null,this.tones=null,this.local_hold=!1,this.early_sdp=null,this.rel100=e.C.supported.UNSUPPORTED}).prototype={dtmf:function(t,n){var i=[],r=this,s=this.ua.configuration.dtmfType;if(n=n||{},void 0===t)throw new TypeError("Not enough arguments");if(this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.status);if("string"!=typeof t&&"number"!=typeof t||!t.toString().match(/^[0-9A-D#*,]+$/i))throw new TypeError("Invalid tones: "+t);var o=function(){var t,i;if(r.status===c.STATUS_TERMINATED||!r.tones||0===r.tones.length)return r.tones=null,this;(t=r.tones.shift()).on("failed",function(){r.tones=null}),t.send(n),i=t.duration+t.interToneGap,e.Timers.setTimeout(o,i)};if(t=t.toString(),s===e.C.dtmfType.RTP&&(this.sessionDescriptionHandler.sendDtmf(t,n)||(this.logger.warn("Attempt to use dtmfType 'RTP' has failed, falling back to INFO packet method"),s=e.C.dtmfType.INFO)),s===e.C.dtmfType.INFO){for(t=t.split("");t.length>0;)i.push(new a(this,t.shift(),n));if(this.tones)return this.tones=this.tones.concat(i),this;this.tones=i,o()}return this},bye:function(t){var n=(t=Object.create(t||Object.prototype)).statusCode;if(this.status===c.STATUS_TERMINATED)return this.logger.error("Error: Attempted to send BYE in a terminated session."),this;if(this.logger.log("terminating Session"),n&&(n<200||n>=700))throw new TypeError("Invalid statusCode: "+n);return t.receiveResponse=function(){},this.sendRequest(e.C.BYE,t).terminated()},refer:function(t,n){if(n=n||{},this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.referContext=new e.ReferClientContext(this.ua,this,t,n),this.emit("referRequested",this.referContext),this.referContext.refer(n)},sendRequest:function(t,n){n=n||{};var i=this,r=new e.OutgoingRequest(t,this.dialog.remote_target,this.ua,{cseq:n.cseq||(this.dialog.local_seqnum+=1),call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set,statusCode:n.statusCode,reasonPhrase:n.reasonPhrase},n.extraHeaders||[],n.body);return new e.RequestSender({request:r,onRequestTimeout:function(){i.onRequestTimeout()},onTransportError:function(){i.onTransportError()},receiveResponse:n.receiveResponse||function(e){i.receiveNonInviteResponse(e)}},this.ua).send(),this.emit(t.toLowerCase(),r),this},close:function(){var t;if(this.status===c.STATUS_TERMINATED)return this;for(t in this.logger.log("closing INVITE session "+this.id),this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.timers)e.Timers.clearTimeout(this.timers[t]);for(t in this.dialog&&(this.dialog.terminate(),delete this.dialog),this.earlyDialogs)this.earlyDialogs[t].terminate(),delete this.earlyDialogs[t];return this.status=c.STATUS_TERMINATED,this.ua.transport.removeListener("transportError",this.errorListener),delete this.ua.sessions[this.id],this},createDialog:function(t,n,i){var r,s,o=t["UAS"===n?"to_tag":"from_tag"],a=t["UAS"===n?"from_tag":"to_tag"],c=t.call_id+o+a;if(s=this.earlyDialogs[c],i)return!!s||((s=new e.Dialog(this,t,n,e.Dialog.C.STATUS_EARLY)).error?(this.logger.error(s.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.earlyDialogs[c]=s,!0));if(s){for(var u in s.update(t,n),this.dialog=s,delete this.earlyDialogs[c],this.earlyDialogs)this.earlyDialogs[u].terminate(),delete this.earlyDialogs[u];return!0}return(r=new e.Dialog(this,t,n)).error?(this.logger.error(r.error),this.failed(t,e.C.causes.INTERNAL_ERROR),!1):(this.to_tag=t.to_tag,this.dialog=r,!0)},hold:function(t,n){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?this.logger.log("Session is already on hold, cannot put it on hold again"):((t=t||{}).modifiers=n||[],t.modifiers.push(this.sessionDescriptionHandler.holdModifier),this.local_hold=!0,this.sendReinvite(t))},unhold:function(t,n){if(this.status!==c.STATUS_WAITING_FOR_ACK&&this.status!==c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.local_hold?(t=t||{},n&&(t.modifiers=n),this.local_hold=!1,this.sendReinvite(t)):this.logger.log("Session is not on hold, cannot unhold it")},reinvite:function(e,t){return e=e||{},t&&(e.modifiers=t),this.sendReinvite(e)},receiveReinvite:function(t){var n,i=this;if(i.emit("reinvite",this),t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),"0"!==t.getHeader("Content-Length")||t.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))return t.reply(415),void this.emit("reinviteFailed",i);n=this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers))}else n=this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers);this.receiveRequest=function(t){t.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK?this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)}.bind(this))):(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.emit("confirmed",t)):e.Session.prototype.receiveRequest.apply(this,[t])}.bind(this),n.catch(function(n){var r;throw n instanceof e.Exceptions.SessionDescriptionHandlerError?r=500:n instanceof e.Exceptions.RenegotiationError?(i.emit("renegotiationError",n),i.logger.warn(n),r=488):(i.logger.error(n),r=488),t.reply(r),i.emit("reinviteFailed",i),n}).then(function(e){var n=["Contact: "+i.contact];t.reply(200,null,n,e,function(){i.status=c.STATUS_WAITING_FOR_ACK,i.setACKTimer(),i.emit("reinviteAccepted",i)})})},sendReinvite:function(t){if(this.pendingReinvite)this.logger.warn("Reinvite in progress. Please wait until complete, then try again.");else{this.pendingReinvite=!0,(t=t||{}).modifiers=t.modifiers||[];var n=this,i=(t.extraHeaders||[]).slice();i.push("Contact: "+this.contact),i.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){n.sendRequest(e.C.INVITE,{extraHeaders:i,body:t,receiveResponse:n.receiveReinviteResponse.bind(n)})}).catch(function(t){if(t instanceof e.Exceptions.RenegotiationError)return n.pendingReinvite=!1,n.emit("renegotiationError",t),n.logger.warn("Renegotiation Error"),void n.logger.warn(t);n.logger.error("sessionDescriptionHandler error"),n.logger.error(t)})}},receiveRequest:function(t){switch(t.method){case e.C.BYE:t.reply(200),this.status===c.STATUS_CONFIRMED&&(this.emit("bye",t),this.terminated(t,e.C.causes.BYE));break;case e.C.INVITE:this.status===c.STATUS_CONFIRMED&&(this.logger.log("re-INVITE received"),this.receiveReinvite(t));break;case e.C.INFO:if(this.status===c.STATUS_CONFIRMED||this.status===c.STATUS_WAITING_FOR_ACK){if(this.onInfo)return this.onInfo(t);var n,i,r,s=t.getHeader("content-type"),o=/^(Signal\s*?=\s*?)([0-9A-D#*]{1})(\s)?.*/,u=/^(Duration\s?=\s?)([0-9]{1,4})(\s)?.*/;s&&(s.match(/^application\/dtmf-relay/i)?(t.body&&2===(n=t.body.split("\r\n",2)).length&&(o.test(n[0])&&(i=n[0].replace(o,"$2")),u.test(n[1])&&(r=parseInt(n[1].replace(u,"$2"),10))),new a(this,i,{duration:r}).init_incoming(t)):t.reply(415,null,["Accept: application/dtmf-relay"]))}break;case e.C.REFER:if(this.status===c.STATUS_CONFIRMED)if(this.logger.log("REFER received"),this.referContext=new e.ReferServerContext(this.ua,t),this.listeners("referRequested").length)this.emit("referRequested",this.referContext);else{this.logger.log("No referRequested listeners, automatically accepting and following the refer");var h={followRefer:!0};this.passedOptions&&(h.inviteOptions=this.passedOptions),this.referContext.accept(h,this.modifiers)}break;case e.C.NOTIFY:if(this.referContext&&this.referContext instanceof e.ReferClientContext&&t.hasHeader("event")&&/^refer(;.*)?$/.test(t.getHeader("event")))return void this.referContext.receiveNotify(t);t.reply(200,"OK"),this.emit("notify",t)}},receiveReinviteResponse:function(t){var n=this;if(this.status!==c.STATUS_TERMINATED)if(this.pendingReinvite)switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):if(this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.pendingReinvite=!1,e.Timers.clearTimeout(n.timers.invite2xxTimer),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.logger.error("2XX response received to re-invite but did not have a description"),this.emit("reinviteFailed",n),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("2XX response received to re-invite but did not have a description"));break}this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).catch(function(t){n.logger.error("Could not set the description in 2XX response"),n.logger.error(t),n.emit("reinviteFailed",n),n.emit("renegotiationError",t),n.sendRequest(e.C.BYE,{extraHeaders:["Reason: "+e.Utils.getReasonHeaderValue(488,"Not Acceptable Here")]}),n.terminated(null,e.C.causes.INCOMPATIBLE_SDP)}).then(function(){n.emit("reinviteAccepted",n)});break;default:this.pendingReinvite=!1,this.logger.log("Received a non 1XX or 2XX response to a re-invite"),this.emit("reinviteFailed",n),this.emit("renegotiationError",new e.Exceptions.RenegotiationError("Invalid response to a re-invite"))}else this.logger.error("Received reinvite response, but have no pending reinvite");else this.logger.error("Received reinvite response, but in STATUS_TERMINATED")},acceptAndTerminate:function(t,n,i){var r=[];return n&&r.push("Reason: "+e.Utils.getReasonHeaderValue(n,i)),(this.dialog||this.createDialog(t,"UAC"))&&(this.emit("ack",t.transaction.sendACK()),this.sendRequest(e.C.BYE,{extraHeaders:r})),this},setInvite2xxTimer:function(t,n){var i=this,r=e.Timers.T1;this.timers.invite2xxTimer=e.Timers.setTimeout(function s(){if(i.status===c.STATUS_WAITING_FOR_ACK){i.logger.log("no ACK received, attempting to retransmit OK");var o=["Contact: "+i.contact];t.reply(200,null,o,n),r=Math.min(2*r,e.Timers.T2),i.timers.invite2xxTimer=e.Timers.setTimeout(s,r)}},r)},setACKTimer:function(){var t=this;this.timers.ackTimer=e.Timers.setTimeout(function(){t.status===c.STATUS_WAITING_FOR_ACK&&(t.logger.log("no ACK received for an extended period of time, terminating the call"),e.Timers.clearTimeout(t.timers.invite2xxTimer),t.sendRequest(e.C.BYE),t.terminated(null,e.C.causes.NO_ACK))},e.Timers.TIMER_H)},onTransportError:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)},onRequestTimeout:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))},onDialogError:function(t){this.status===c.STATUS_CONFIRMED?this.terminated(t,e.C.causes.DIALOG_ERROR):this.status!==c.STATUS_TERMINATED&&(this.failed(t,e.C.causes.DIALOG_ERROR),this.terminated(t,e.C.causes.DIALOG_ERROR))},failed:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.emit("failed",e||null,t||null),this)},rejected:function(e,t){return this.emit("rejected",e||null,t||null),this},canceled:function(){return this.sessionDescriptionHandler&&this.sessionDescriptionHandler.close(),this.emit("cancel"),this},accepted:function(t,n){return n=e.Utils.getReasonPhrase(t&&t.status_code,n),this.startTime=new Date,this.replacee&&(this.replacee.emit("replaced",this),this.replacee.terminate()),this.emit("accepted",t,n),this},terminated:function(e,t){return this.status===c.STATUS_TERMINATED?this:(this.endTime=new Date,this.close(),this.emit("terminated",e||null,t||null),this)},connecting:function(e){return this.emit("connecting",{request:e}),this}},t.C=c,e.Session=t,(i=function(t,n){var i,r=this,s=n.getHeader("Content-Type"),o=n.parseHeader("Content-Disposition");function a(e,t){n.hasHeader(e)&&n.getHeader(e).toLowerCase().indexOf("100rel")>=0&&(r.rel100=t)}if(e.Utils.augment(this,e.ServerContext,[t,n]),e.Utils.augment(this,e.Session,[t.configuration.sessionDescriptionHandlerFactory]),o&&"render"===o.type&&(this.renderbody=n.body,this.rendertype=s),this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=n.from_tag,this.id=n.call_id+this.from_tag,this.request=n,this.contact=this.ua.contact.toString(),this.receiveNonInviteResponse=function(){},this.logger=t.getLogger("sip.inviteservercontext",this.id),this.ua.sessions[this.id]=this,n.hasHeader("expires")&&(i=1e3*n.getHeader("expires")),a("require",e.C.supported.REQUIRED),a("supported",e.C.supported.SUPPORTED),n.to_tag=e.Utils.newTag(),this.createDialog(n,"UAS",!0)){var u={extraHeaders:["Contact: "+r.contact]};r.rel100!==e.C.supported.REQUIRED&&r.progress(u),r.status=c.STATUS_WAITING_FOR_ANSWER,r.timers.userNoAnswerTimer=e.Timers.setTimeout(function(){n.reply(408),r.failed(n,e.C.causes.NO_ANSWER),r.terminated(n,e.C.causes.NO_ANSWER)},r.ua.configuration.noAnswerTimeout),i&&(r.timers.expiresTimer=e.Timers.setTimeout(function(){r.status===c.STATUS_WAITING_FOR_ANSWER&&(n.reply(487),r.failed(n,e.C.causes.EXPIRES),r.terminated(n,e.C.causes.EXPIRES))},i)),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}else n.reply(500,"Missing Contact header field")}).prototype=Object.create({},{reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);return this.logger.log("rejecting RTCSession"),e.ServerContext.prototype.reject.call(this,t),this.terminated()}},terminate:{writable:!0,value:function(t){var n,i=((t=t||{}).extraHeaders||[]).slice(),r=t.body,s=this;return this.status===c.STATUS_WAITING_FOR_ACK&&this.request.server_transaction.state!==e.Transactions.C.STATUS_TERMINATED?(n=this.dialog,this.receiveRequest=function(t){t.method===e.C.ACK&&(this.sendRequest(e.C.BYE,{extraHeaders:i,body:r}),n.terminate())},this.request.server_transaction.on("stateChanged",function(){this.state===e.Transactions.C.STATUS_TERMINATED&&this.dialog&&(this.request=new e.OutgoingRequest(e.C.BYE,this.dialog.remote_target,this.ua,{cseq:this.dialog.local_seqnum+=1,call_id:this.dialog.id.call_id,from_uri:this.dialog.local_uri,from_tag:this.dialog.id.local_tag,to_uri:this.dialog.remote_uri,to_tag:this.dialog.id.remote_tag,route_set:this.dialog.route_set},i,r),new e.RequestSender({request:this.request,onRequestTimeout:function(){s.onRequestTimeout()},onTransportError:function(){s.onTransportError()},receiveResponse:function(){}},this.ua).send(),n.terminate())}),this.emit("bye",this.request),this.terminated(),this.dialog=n,this.ua.dialogs[n.id.toString()]=n):this.status===c.STATUS_CONFIRMED?this.bye(t):this.reject(t),this}},progress:{writable:!0,value:function(t){var n,i=(t=t||{}).statusCode||180,r=t.reasonPhrase,s=(t.extraHeaders||[]).slice(),o=t.body;if(i<100||i>199)throw new TypeError("Invalid statusCode: "+i);if(this.isCanceled||this.status===c.STATUS_TERMINATED)return this;function a(){i=t.statusCode||183,this.status=c.STATUS_WAITING_FOR_PRACK,s.push("Contact: "+this.contact),s.push("Require: 100rel"),s.push("RSeq: "+Math.floor(1e4*Math.random())),this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).then(function(t){if(!this.isCanceled&&this.status!==c.STATUS_TERMINATED){this.early_sdp=t.body,this[this.hasOffer?"hasAnswer":"hasOffer"]=!0;var o=e.Timers.T1;this.timers.rel1xxTimer=e.Timers.setTimeout(function n(){this.request.reply(i,null,s,t),o*=2,this.timers.rel1xxTimer=e.Timers.setTimeout(n.bind(this),o)}.bind(this),o),this.timers.prackTimer=e.Timers.setTimeout(function(){this.status===c.STATUS_WAITING_FOR_PRACK&&(this.logger.log("no PRACK received, rejecting the call"),e.Timers.clearTimeout(this.timers.rel1xxTimer),this.request.reply(504),this.terminated(null,e.C.causes.NO_PRACK))}.bind(this),64*e.Timers.T1),n=this.request.reply(i,r,s,t),this.emit("progress",n,r)}}.bind(this),function(){this.request.reply(480),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))}return 100!==t.statusCode&&(this.rel100===e.C.supported.REQUIRED||this.rel100===e.C.supported.SUPPORTED&&t.rel100||this.rel100===e.C.supported.SUPPORTED&&this.ua.configuration.rel100===e.C.supported.REQUIRED)?(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type"))?(this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(a.apply(this)).catch(function(t){this.logger.warn("invalid description"),this.logger.warn(t),this.failed(null,e.C.causes.WEBRTC_ERROR),this.terminated(null,e.C.causes.WEBRTC_ERROR)}.bind(this))):a.apply(this)):function(){n=this.request.reply(i,r,s,o),this.emit("progress",n,r)}.apply(this),this}},accept:{writable:!0,value:function(t){t=t||{},this.onInfo=t.onInfo;var n=this,i=this.request,r=(t.extraHeaders||[]).slice(),s=function(t){var s;r.push("Contact: "+n.contact),r.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),n.hasOffer?n.hasAnswer=!0:n.hasOffer=!0,s=i.reply(200,null,r,t,function(){n.status=c.STATUS_WAITING_FOR_ACK,n.setInvite2xxTimer(i,t),n.setACKTimer()},function(){n.failed(null,e.C.causes.CONNECTION_ERROR),n.terminated(null,e.C.causes.CONNECTION_ERROR)}),n.status!==c.STATUS_TERMINATED&&n.accepted(s,e.Utils.getReasonPhrase(200))},o=function(t){t instanceof e.Exceptions.SessionDescriptionHandlerError&&(n.logger.log(t.message),n.logger.log(t.error)),n.status!==c.STATUS_TERMINATED&&(n.request.reply(480),n.failed(null,e.C.causes.WEBRTC_ERROR),n.terminated(null,e.C.causes.WEBRTC_ERROR))};if(this.status===c.STATUS_WAITING_FOR_PRACK)return this.status=c.STATUS_ANSWERED_WAITING_FOR_PRACK,this;if(this.status===c.STATUS_WAITING_FOR_ANSWER)this.status=c.STATUS_ANSWERED;else if(this.status!==c.STATUS_EARLY_MEDIA)throw new e.Exceptions.InvalidStateError(this.status);if(!this.createDialog(i,"UAS"))return i.reply(500,"Missing Contact header field"),this;if(e.Timers.clearTimeout(this.timers.userNoAnswerTimer),this.status===c.STATUS_EARLY_MEDIA)s({});else if(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),"0"!==this.request.getHeader("Content-Length")||this.request.getHeader("Content-Type")){if(!this.sessionDescriptionHandler.hasDescription(this.request.getHeader("Content-Type")))return void this.request.reply(415);this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(this.request.body,t.sessionDescriptionHandlerOptions,t.modifiers).then(function(){return this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers)}.bind(this)).catch(o).then(s)}else this.sessionDescriptionHandler.getDescription(t.sessionDescriptionHandlerOptions,t.modifiers).catch(o).then(s);return this}},receiveRequest:{writable:!0,value:function(n){function i(){var t,i;e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,t=n.getHeader("Content-Type"),(i=n.getHeader("Content-Disposition"))&&"render"===i.type&&(this.renderbody=n.body,this.rendertype=t),this.emit("confirmed",n)}switch(n.method){case e.C.CANCEL:this.status!==c.STATUS_WAITING_FOR_ANSWER&&this.status!==c.STATUS_WAITING_FOR_PRACK&&this.status!==c.STATUS_ANSWERED_WAITING_FOR_PRACK&&this.status!==c.STATUS_EARLY_MEDIA&&this.status!==c.STATUS_ANSWERED||(this.status=c.STATUS_CANCELED,this.request.reply(487),this.canceled(n),this.rejected(n,e.C.causes.CANCELED),this.failed(n,e.C.causes.CANCELED),this.terminated(n,e.C.causes.CANCELED));break;case e.C.ACK:this.status===c.STATUS_WAITING_FOR_ACK&&(this.sessionDescriptionHandler.hasDescription(n.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(n.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(i.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(n,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(n,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):i.apply(this));break;case e.C.PRACK:this.status===c.STATUS_WAITING_FOR_PRACK||this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK?this.hasAnswer?(e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),n.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA):(this.sessionDescriptionHandler=this.setupSessionDescriptionHandler(),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(n.getHeader("Content-Type"))?(this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(n.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){e.Timers.clearTimeout(this.timers.rel1xxTimer),e.Timers.clearTimeout(this.timers.prackTimer),n.reply(200),this.status===c.STATUS_ANSWERED_WAITING_FOR_PRACK&&(this.status=c.STATUS_EARLY_MEDIA,this.accept()),this.status=c.STATUS_EARLY_MEDIA}.bind(this),function(t){this.logger.warn(t),this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(n,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(n,e.C.causes.BAD_MEDIA_DESCRIPTION)}.bind(this))):(this.terminate({statusCode:"488",reasonPhrase:"Bad Media Description"}),this.failed(n,e.C.causes.BAD_MEDIA_DESCRIPTION),this.terminated(n,e.C.causes.BAD_MEDIA_DESCRIPTION))):this.status===c.STATUS_EARLY_MEDIA&&n.reply(200);break;default:t.prototype.receiveRequest.apply(this,[n])}}},setupSessionDescriptionHandler:{writable:!0,value:function(){return this.sessionDescriptionHandler?this.sessionDescriptionHandler:this.sessionDescriptionHandlerFactory(this,this.ua.configuration.sessionDescriptionHandlerFactoryOptions)}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteServerContext=i,(r=function(t,n,i,r){i=i||{},this.passedOptions=i,i.params=Object.create(i.params||Object.prototype);var s=(i.extraHeaders||[]).slice(),o=t.configuration.sessionDescriptionHandlerFactory;if(this.sessionDescriptionHandlerFactoryOptions=t.configuration.sessionDescriptionHandlerFactoryOptions||{},this.sessionDescriptionHandlerOptions=i.sessionDescriptionHandlerOptions||{},this.modifiers=r,this.inviteWithoutSdp=i.inviteWithoutSdp||!1,this.anonymous=i.anonymous||!1,this.renderbody=i.renderbody||null,this.rendertype=i.rendertype||"text/plain",this.from_tag=e.Utils.newTag(),i.params.from_tag=this.from_tag,this.contact=t.contact.toString({anonymous:this.anonymous,outbound:this.anonymous?!t.contact.temp_gruu:!t.contact.pub_gruu}),this.anonymous&&(i.params.from_displayName="Anonymous",i.params.from_uri="sip:anonymous@anonymous.invalid",s.push("P-Preferred-Identity: "+t.configuration.uri.toString()),s.push("Privacy: id")),s.push("Contact: "+this.contact),s.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.inviteWithoutSdp&&this.renderbody&&(s.push("Content-Type: "+this.rendertype),s.push("Content-Disposition: render;handling=optional")),t.configuration.rel100===e.C.supported.REQUIRED&&s.push("Require: 100rel"),t.configuration.replaces===e.C.supported.REQUIRED&&s.push("Require: replaces"),i.extraHeaders=s,e.Utils.augment(this,e.ClientContext,[t,e.C.INVITE,n,i]),e.Utils.augment(this,e.Session,[o]),this.status!==c.STATUS_NULL)throw new e.Exceptions.InvalidStateError(this.status);this.isCanceled=!1,this.received_100=!1,this.method=e.C.INVITE,this.receiveNonInviteResponse=this.receiveResponse,this.receiveResponse=this.receiveInviteResponse,this.logger=t.getLogger("sip.inviteclientcontext"),t.applicants[this]=this,this.id=this.request.call_id+this.from_tag,this.onInfo=i.onInfo,this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{invite:{writable:!0,value:function(){var t=this;return this.ua.sessions[this.id]=this,e.Utils.Promise.resolve().then(function(){this.inviteWithoutSdp?(this.request.body=t.renderbody,this.status=c.STATUS_INVITE_SENT,this.send()):(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.getDescription(this.sessionDescriptionHandlerOptions,this.modifiers).then(function(e){t.isCanceled||t.status===c.STATUS_TERMINATED||(t.hasOffer=!0,t.request.body=e,t.status=c.STATUS_INVITE_SENT,t.send())},function(n){n instanceof e.Exceptions.SessionDescriptionHandlerError&&(t.logger.log(n.message),t.logger.log(n.error)),t.status!==c.STATUS_TERMINATED&&(t.failed(null,e.C.causes.WEBRTC_ERROR),t.terminated(null,e.C.causes.WEBRTC_ERROR))}))}.bind(this)),this}},receiveInviteResponse:{writable:!0,value:function(t){var n,i=this,r=t.call_id+t.from_tag+t.to_tag,s=[],o={};if(this.status!==c.STATUS_TERMINATED&&t.method===e.C.INVITE){if(this.dialog&&t.status_code>=200&&t.status_code<=299){if(r!==this.dialog.id.toString()){if(!this.createDialog(t,"UAC",!0))return;return this.emit("ack",t.transaction.sendACK({body:e.Utils.generateFakeSDP(t.body)})),this.earlyDialogs[r].sendRequest(this,e.C.BYE),void(this.status!==c.STATUS_CONFIRMED&&(this.failed(t,e.C.causes.WEBRTC_ERROR),this.terminated(t,e.C.causes.WEBRTC_ERROR)))}if(this.status===c.STATUS_CONFIRMED)return void this.emit("ack",t.transaction.sendACK());if(!this.hasAnswer)return}if(this.dialog&&t.status_code<200){if(-1!==this.dialog.pracked.indexOf(t.getHeader("rseq"))||this.dialog.pracked[this.dialog.pracked.length-1]>=t.getHeader("rseq")&&this.dialog.pracked.length>0)return;if(!this.earlyDialogs[r]&&!this.createDialog(t,"UAC",!0))return;if(-1!==this.earlyDialogs[r].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[r].pracked[this.earlyDialogs[r].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[r].pracked.length>0)return;return s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[r].pracked.push(t.getHeader("rseq")),void this.earlyDialogs[r].sendRequest(this,e.C.PRACK,{extraHeaders:s,body:e.Utils.generateFakeSDP(t.body)})}if(this.isCanceled)t.status_code>=100&&t.status_code<200?(this.request.cancel(this.cancelReason,s),this.canceled(null)):t.status_code>=200&&t.status_code<299?(this.acceptAndTerminate(t),this.emit("bye",this.request)):t.status_code>=300&&(n=e.C.REASON_PHRASE[t.status_code]||e.C.causes.CANCELED,this.rejected(t,n),this.failed(t,n),this.terminated(t,n));else switch(!0){case/^100$/.test(t.status_code):this.received_100=!0,this.emit("progress",t);break;case/^1[0-9]{2}$/.test(t.status_code):if(!t.to_tag){this.logger.warn("1xx response received without to tag");break}if(t.hasHeader("contact")&&!this.createDialog(t,"UAC",!0))break;if(this.status=c.STATUS_1XX_RECEIVED,t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),t.hasHeader("require")&&-1!==t.getHeader("require").indexOf("100rel")){if(this.dialog||!this.earlyDialogs[r])break;if(-1!==this.earlyDialogs[r].pracked.indexOf(t.getHeader("rseq"))||this.earlyDialogs[r].pracked[this.earlyDialogs[r].pracked.length-1]>=t.getHeader("rseq")&&this.earlyDialogs[r].pracked.length>0)return;if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type")))if(this.hasOffer){if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.dialog.pracked.push(t.getHeader("rseq")),this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),i.sendRequest(e.C.PRACK,{extraHeaders:s,receiveResponse:function(){}}),i.status=c.STATUS_EARLY_MEDIA,i.emit("progress",t)},function(n){i.logger.warn(n),i.acceptAndTerminate(t,488,"Not Acceptable Here"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else{var a=this.earlyDialogs[r],u=a.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions);this.emit("SessionDescriptionHandler-created",u),a.pracked.push(t.getHeader("rseq")),u.setDescription(t.body,i.sessionDescriptionHandlerOptions,i.modifers).then(u.getDescription.bind(u,i.sessionDescriptionHandlerOptions,i.modifiers)).then(function(n){s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),a.sendRequest(i,e.C.PRACK,{extraHeaders:s,body:n}),i.status=c.STATUS_EARLY_MEDIA,i.emit("progress",t)}).catch(function(n){if(n instanceof e.Exceptions.SessionDescriptionHandlerError){if(a.pracked.push(t.getHeader("rseq")),i.status===c.STATUS_TERMINATED)return;i.failed(null,e.C.causes.WEBRTC_ERROR),i.terminated(null,e.C.causes.WEBRTC_ERROR)}else a.pracked.splice(a.pracked.indexOf(t.getHeader("rseq")),1),i.logger.warn("invalid description"),i.logger.warn(n)})}else s.push("RAck: "+t.getHeader("rseq")+" "+t.getHeader("cseq")),this.earlyDialogs[r].pracked.push(t.getHeader("rseq")),this.earlyDialogs[r].sendRequest(this,e.C.PRACK,{extraHeaders:s}),this.emit("progress",t)}else this.emit("progress",t);break;case/^2[0-9]{2}$/.test(t.status_code):if(this.request.cseq+" "+this.request.method!==t.getHeader("cseq"))break;if(t.hasHeader("P-Asserted-Identity")&&(this.assertedIdentity=new e.NameAddrHeader.parse(t.getHeader("P-Asserted-Identity"))),this.status===c.STATUS_EARLY_MEDIA&&this.dialog){this.status=c.STATUS_CONFIRMED,o={},this.renderbody&&(s.push("Content-Type: "+this.rendertype),o.extraHeaders=s,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o)),this.accepted(t);break}if(this.dialog)break;if(this.hasOffer)if(this.hasAnswer)this.renderbody&&(s.push("Content-Type: "+i.rendertype),o.extraHeaders=s,o.body=this.renderbody),this.emit("ack",t.transaction.sendACK(o));else{if(!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasAnswer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(function(){var e={};i.status=c.STATUS_CONFIRMED,i.renderbody&&(s.push("Content-Type: "+i.rendertype),e.extraHeaders=s,e.body=i.renderbody),i.emit("ack",t.transaction.sendACK(e)),i.accepted(t)},function(n){i.logger.warn(n),i.acceptAndTerminate(t,488,"Not Acceptable Here"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION)})}else if(this.earlyDialogs[r]&&this.earlyDialogs[r].sessionDescriptionHandler){if(this.hasOffer=!0,this.hasAnswer=!0,this.sessionDescriptionHandler=this.earlyDialogs[r].sessionDescriptionHandler,!this.createDialog(t,"UAC"))break;this.status=c.STATUS_CONFIRMED,this.emit("ack",t.transaction.sendACK()),this.accepted(t)}else{if(this.sessionDescriptionHandler=this.sessionDescriptionHandlerFactory(this,this.sessionDescriptionHandlerFactoryOptions),this.emit("SessionDescriptionHandler-created",this.sessionDescriptionHandler),!this.sessionDescriptionHandler.hasDescription(t.getHeader("Content-Type"))){this.acceptAndTerminate(t,400,"Missing session description"),this.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION);break}if(!this.createDialog(t,"UAC"))break;this.hasOffer=!0,this.sessionDescriptionHandler.setDescription(t.body,this.sessionDescriptionHandlerOptions,this.modifiers).then(this.sessionDescriptionHandler.getDescription.bind(this.sessionDescriptionHandler,this.sessionDescriptionHandlerOptions,this.modifiers)).then(function(e){i.isCanceled||i.status===c.STATUS_TERMINATED||(i.status=c.STATUS_CONFIRMED,i.hasAnswer=!0,i.emit("ack",t.transaction.sendACK({body:e})),i.accepted(t))}).catch(function(n){n instanceof e.Exceptions.SessionDescriptionHandlerError&&(i.logger.warn("invalid description"),i.logger.warn(n),i.acceptAndTerminate(t,488,"Invalid session description"),i.failed(t,e.C.causes.BAD_MEDIA_DESCRIPTION))})}break;default:n=e.Utils.sipErrorCause(t.status_code),this.rejected(t,n),this.failed(t,n),this.terminated(t,n)}}}},cancel:{writable:!0,value:function(t){if((t=t||{}).extraHeaders=(t.extraHeaders||[]).slice(),this.isCanceled)throw new e.Exceptions.InvalidStateError("CANCELED");if(this.status===c.STATUS_TERMINATED||this.status===c.STATUS_CONFIRMED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("canceling RTCSession"),this.isCanceled=!0;var n=e.Utils.getCancelReason(t.status_code,t.reason_phrase);return this.status===c.STATUS_NULL||this.status===c.STATUS_INVITE_SENT&&!this.received_100?this.cancelReason=n:this.status!==c.STATUS_INVITE_SENT&&this.status!==c.STATUS_1XX_RECEIVED&&this.status!==c.STATUS_EARLY_MEDIA||this.request.cancel(n,t.extraHeaders),this.canceled()}},terminate:{writable:!0,value:function(e){return this.status===c.STATUS_TERMINATED?this:(this.status===c.STATUS_WAITING_FOR_ACK||this.status===c.STATUS_CONFIRMED?this.bye(e):this.cancel(e),this)}},receiveRequest:{writable:!0,value:function(n){return n.method,e.C.CANCEL,n.method===e.C.ACK&&this.status===c.STATUS_WAITING_FOR_ACK&&(e.Timers.clearTimeout(this.timers.ackTimer),e.Timers.clearTimeout(this.timers.invite2xxTimer),this.status=c.STATUS_CONFIRMED,this.accepted()),t.prototype.receiveRequest.apply(this,[n])}},onTransportError:{writable:!0,value:function(){this.status!==c.STATUS_CONFIRMED&&this.status!==c.STATUS_TERMINATED&&this.failed(null,e.C.causes.CONNECTION_ERROR)}},onRequestTimeout:{writable:!0,value:function(){this.status===c.STATUS_CONFIRMED?this.terminated(null,e.C.causes.REQUEST_TIMEOUT):this.status!==c.STATUS_TERMINATED&&(this.failed(null,e.C.causes.REQUEST_TIMEOUT),this.terminated(null,e.C.causes.REQUEST_TIMEOUT))}}}),e.InviteClientContext=r,(o=function(t,n,i,r){if(this.options=r||{},this.extraHeaders=(this.options.extraHeaders||[]).slice(),void 0===t||void 0===n||void 0===i)throw new TypeError("Not enough arguments");if(e.Utils.augment(this,e.ClientContext,[t,e.C.REFER,n.remoteIdentity.uri.toString(),r]),this.applicant=n,i instanceof e.InviteServerContext||i instanceof e.InviteClientContext)this.target='"'+i.remoteIdentity.friendlyName+'" <'+i.dialog.remote_target.toString()+"?Replaces="+i.dialog.id.call_id+"%3Bto-tag%3D"+i.dialog.id.remote_tag+"%3Bfrom-tag%3D"+i.dialog.id.local_tag+">";else{try{this.target=e.Grammar.parse(i,"Refer_To").uri||i}catch(e){this.logger.debug(".refer() cannot parse Refer_To from",i),this.logger.debug("...falling through to normalizeTarget()")}if(this.target=this.ua.normalizeTarget(this.target),!this.target)throw new TypeError("Invalid target: "+i)}this.ua&&this.extraHeaders.push("Referred-By: <"+this.ua.configuration.uri+">"),this.extraHeaders.push("Contact: "+n.contact),this.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.extraHeaders.push("Refer-To: "+this.target),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener)}).prototype=Object.create({},{refer:{writable:!0,value:function(t){t=t||{};var n=(this.extraHeaders||[]).slice();return t.extraHeaders&&n.concat(t.extraHeaders),this.applicant.sendRequest(e.C.REFER,{extraHeaders:this.extraHeaders,receiveResponse:function(e){/^1[0-9]{2}$/.test(e.status_code)?this.emit("referRequestProgress",this):/^2[0-9]{2}$/.test(e.status_code)?this.emit("referRequestAccepted",this):/^[4-6][0-9]{2}$/.test(e.status_code)&&this.emit("referRequestRejected",this),t.receiveResponse&&t.receiveResponse(e)}.bind(this)}),this}},receiveNotify:{writable:!0,value:function(t){if(t.hasHeader("Content-Type")&&-1!==t.getHeader("Content-Type").search(/^message\/sipfrag/)){var n=e.Grammar.parse(t.body,"sipfrag");if(-1===n)return void t.reply(489,"Bad Event");switch(!0){case/^1[0-9]{2}$/.test(n.status_code):this.emit("referProgress",this);break;case/^2[0-9]{2}$/.test(n.status_code):this.emit("referAccepted",this),!this.options.activeAfterTransfer&&this.applicant.terminate&&this.applicant.terminate();break;default:this.emit("referRejected",this)}return t.reply(200),void this.emit("notify",t)}t.reply(489,"Bad Event")}}}),e.ReferClientContext=o,(s=function(t,n){if(e.Utils.augment(this,e.ServerContext,[t,n]),this.ua=t,this.status=c.STATUS_INVITE_RECEIVED,this.from_tag=n.from_tag,this.id=n.call_id+this.from_tag,this.request=n,this.contact=this.ua.contact.toString(),this.logger=t.getLogger("sip.referservercontext",this.id),!this.request.hasHeader("refer-to"))return this.logger.warn("Invalid REFER packet. A refer-to header is required. Rejecting refer."),void this.reject();this.referTo=this.request.parseHeader("refer-to"),this.referredSession=this.ua.findSession(n),this.cseq=Math.floor(1e4*Math.random()),this.call_id=this.request.call_id,this.from_uri=this.request.to.uri,this.from_tag=this.request.to.parameters.tag,this.remote_target=this.request.headers.Contact[0].parsed.uri,this.to_uri=this.request.from.uri,this.to_tag=this.request.from_tag,this.route_set=this.request.getHeaders("record-route"),this.receiveNonInviteResponse=function(){},this.request.hasHeader("referred-by")&&(this.referredBy=this.request.getHeader("referred-by")),this.referTo.uri.hasHeader("replaces")&&(this.replaces=this.referTo.uri.getHeader("replaces")),this.errorListener=this.onTransportError.bind(this),t.transport.on("transportError",this.errorListener),this.status=c.STATUS_WAITING_FOR_ANSWER}).prototype=Object.create({},{progress:{writable:!0,value:function(){if(this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);this.request.reply(100)}},reject:{writable:!0,value:function(t){if(this.status===c.STATUS_TERMINATED)throw new e.Exceptions.InvalidStateError(this.status);this.logger.log("Rejecting refer"),this.status=c.STATUS_TERMINATED,e.ServerContext.prototype.reject.call(this,t),this.emit("referRequestRejected",this)}},accept:{writable:!0,value:function(t,n){if(t=t||{},this.status!==c.STATUS_WAITING_FOR_ANSWER)throw new e.Exceptions.InvalidStateError(this.status);if(this.status=c.STATUS_ANSWERED,this.request.reply(202,"Accepted"),this.emit("referRequestAccepted",this),t.followRefer){this.logger.log("Accepted refer, attempting to automatically follow it");var i=this.referTo.uri;if(!i.scheme.match("^sips?$"))return this.logger.error("SIP.js can only automatically follow SIP refer target"),void this.reject();var r=t.inviteOptions||{},s=(r.extraHeaders||[]).slice();this.replaces&&s.push("Replaces: "+decodeURIComponent(this.replaces)),this.referredBy&&s.push("Referred-By: "+this.referredBy),r.extraHeaders=s,i.clearHeaders(),this.targetSession=this.ua.invite(i,r,n),this.emit("referInviteSent",this),this.targetSession.once("progress",function(){this.sendNotify("SIP/2.0 100 Trying"),this.emit("referProgress",this),this.referredSession&&this.referredSession.emit("referProgress",this)}.bind(this)),this.targetSession.once("accepted",function(){this.logger.log("Successfully followed the refer"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}.bind(this));var o=function(e){if(this.status!==c.STATUS_TERMINATED){if(this.logger.log("Refer was not successful. Resuming session"),e&&429===e.status_code)return this.logger.log("Alerting referrer that identity is required."),void this.sendNotify("SIP/2.0 429 Provide Referrer Identity");this.sendNotify("SIP/2.0 603 Declined"),this.status=c.STATUS_TERMINATED,this.emit("referRejected",this),this.referredSession&&this.referredSession.emit("referRejected")}};this.targetSession.once("rejected",o.bind(this)),this.targetSession.once("failed",o.bind(this))}else this.logger.log("Accepted refer, but did not automatically follow it"),this.sendNotify("SIP/2.0 200 OK"),this.emit("referAccepted",this),this.referredSession&&this.referredSession.emit("referAccepted",this)}},sendNotify:{writable:!0,value:function(t){if(this.status!==c.STATUS_ANSWERED)throw new e.Exceptions.InvalidStateError(this.status);if(-1===e.Grammar.parse(t,"sipfrag"))throw new Error("sipfrag body is required to send notify for refer");var n=new e.OutgoingRequest(e.C.NOTIFY,this.remote_target,this.ua,{cseq:this.cseq+=1,call_id:this.call_id,from_uri:this.from_uri,from_tag:this.from_tag,to_uri:this.to_uri,to_tag:this.to_tag,route_set:this.route_set},["Event: refer","Subscription-State: terminated","Content-Type: message/sipfrag"],t);new e.RequestSender({request:n,onRequestTimeout:function(){},onTransportError:function(){},receiveResponse:function(){}},this.ua).send()}}}),e.ReferServerContext=s}},function(e,t,n){"use strict";e.exports=function(e){var t;return(t=function(n,i,r){var s,o;if(void 0===i)throw new TypeError("Not enough arguments");if(this.logger=n.ua.getLogger("sip.invitecontext.dtmf",n.id),this.owner=n,this.direction=null,s=(r=r||{}).duration||null,o=r.interToneGap||null,"string"==typeof i)i=i.toUpperCase();else{if("number"!=typeof i)throw new TypeError("Invalid tone: "+i);i=i.toString()}if(!i.match(/^[0-9A-D#*]$/))throw new TypeError("Invalid tone: "+i);if(this.tone=i,s&&!e.Utils.isDecimal(s))throw new TypeError("Invalid tone duration: "+s);if(s?s<t.C.MIN_DURATION?(this.logger.warn('"duration" value is lower than the minimum allowed, setting it to '+t.C.MIN_DURATION+" milliseconds"),s=t.C.MIN_DURATION):s>t.C.MAX_DURATION?(this.logger.warn('"duration" value is greater than the maximum allowed, setting it to '+t.C.MAX_DURATION+" milliseconds"),s=t.C.MAX_DURATION):s=Math.abs(s):s=t.C.DEFAULT_DURATION,this.duration=s,o&&!e.Utils.isDecimal(o))throw new TypeError("Invalid interToneGap: "+o);o?o<t.C.MIN_INTER_TONE_GAP?(this.logger.warn('"interToneGap" value is lower than the minimum allowed, setting it to '+t.C.MIN_INTER_TONE_GAP+" milliseconds"),o=t.C.MIN_INTER_TONE_GAP):o=Math.abs(o):o=t.C.DEFAULT_INTER_TONE_GAP,this.interToneGap=o}).prototype=Object.create(e.EventEmitter.prototype),t.prototype.send=function(t){var n,i={};if(this.direction="outgoing",this.owner.status!==e.Session.C.STATUS_CONFIRMED&&this.owner.status!==e.Session.C.STATUS_WAITING_FOR_ACK)throw new e.Exceptions.InvalidStateError(this.owner.status);n=(t=t||{}).extraHeaders?t.extraHeaders.slice():[],i.contentType="application/dtmf-relay",i.body="Signal= "+this.tone+"\r\n",i.body+="Duration= "+this.duration,this.request=this.owner.dialog.sendRequest(this,e.C.INFO,{extraHeaders:n,body:i}),this.owner.emit("dtmf",this.request,this)},t.prototype.receiveResponse=function(t){var n;switch(!0){case/^1[0-9]{2}$/.test(t.status_code):break;case/^2[0-9]{2}$/.test(t.status_code):this.emit("succeeded",{originator:"remote",response:t});break;default:n=e.Utils.sipErrorCause(t.status_code),this.emit("failed",t,n)}},t.prototype.onRequestTimeout=function(){this.emit("failed",null,e.C.causes.REQUEST_TIMEOUT),this.owner.onRequestTimeout()},t.prototype.onTransportError=function(){this.emit("failed",null,e.C.causes.CONNECTION_ERROR),this.owner.onTransportError()},t.prototype.onDialogError=function(t){this.emit("failed",t,e.C.causes.DIALOG_ERROR),this.owner.onDialogError(t)},t.prototype.init_incoming=function(e){this.direction="incoming",this.request=e,e.reply(200),this.tone&&this.duration?this.owner.emit("dtmf",e,this):this.logger.warn("invalid INFO DTMF received, discarded")},t.C={MIN_DURATION:70,MAX_DURATION:6e3,DEFAULT_DURATION:100,MIN_INTER_TONE_GAP:50,DEFAULT_INTER_TONE_GAP:500},t}},function(e,t,n){"use strict";e.exports=function(e){e.Subscription=function(t,n,i,r){if(r=Object.create(r||Object.prototype),this.extraHeaders=r.extraHeaders=(r.extraHeaders||[]).slice(),this.id=null,this.state="init",!i)throw new TypeError("Event necessary to create a subscription.");this.event=i,"number"!=typeof r.expires?(t.logger.warn("expires must be a number. Using default of 3600."),this.expires=3600):this.expires=r.expires,this.requestedExpires=this.expires,r.extraHeaders.push("Event: "+this.event),r.extraHeaders.push("Expires: "+this.expires),r.body&&(this.body=r.body),this.contact=t.contact.toString(),r.extraHeaders.push("Contact: "+this.contact),r.extraHeaders.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),e.Utils.augment(this,e.ClientContext,[t,e.C.SUBSCRIBE,n,r]),this.logger=t.getLogger("sip.subscription"),this.dialog=null,this.timers={N:null,sub_duration:null},this.errorCodes=[404,405,410,416,480,481,482,483,484,485,489,501,604]},e.Subscription.prototype={subscribe:function(){return"active"===this.state?(this.refresh(),this):"notify_wait"===this.state?this:(e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N),this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]=this,this.send(),this.state="notify_wait",this)},refresh:function(){"terminated"!==this.state&&"pending"!==this.state&&"notify_wait"!==this.state&&this.dialog.sendRequest(this,e.C.SUBSCRIBE,{extraHeaders:this.extraHeaders,body:this.body})},receiveResponse:function(t){var n,i=e.Utils.getReasonPhrase(t.status_code);"notify_wait"===this.state&&t.status_code>=300||"notify_wait"!==this.state&&-1!==this.errorCodes.indexOf(t.status_code)?this.failed(t,null):/^2[0-9]{2}$/.test(t.status_code)?(this.emit("accepted",t,i),(n=t.getHeader("Expires"))&&n<=this.requestedExpires?(this.expires=n,this.timers.sub_duration=e.Timers.setTimeout(this.refresh.bind(this),900*n)):n?(this.logger.warn("Expires header in a 200-class response to SUBSCRIBE with a higher value than the one in the request"),this.failed(t,e.C.INVALID_EXPIRES_HEADER)):(this.logger.warn("Expires header missing in a 200-class response to SUBSCRIBE"),this.failed(t,e.C.EXPIRES_HEADER_MISSING))):t.statusCode>300&&(this.emit("failed",t,i),this.emit("rejected",t,i))},unsubscribe:function(){var t=[];this.state="terminated",t.push("Event: "+this.event),t.push("Expires: 0"),t.push("Contact: "+this.contact),t.push("Allow: "+e.UA.C.ALLOWED_METHODS.toString()),this.receiveResponse=function(){},this.dialog.sendRequest(this,this.method,{extraHeaders:t,body:this.body}),e.Timers.clearTimeout(this.timers.sub_duration),e.Timers.clearTimeout(this.timers.N),this.timers.N=e.Timers.setTimeout(this.timer_fire.bind(this),e.Timers.TIMER_N)},timer_fire:function(){"terminated"===this.state?(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]):"notify_wait"===this.state||"pending"===this.state?this.close():this.refresh()},close:function(){"notify_wait"===this.state?(this.state="terminated",e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),this.receiveResponse=function(){},delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event]):"terminated"!==this.state&&this.unsubscribe()},createConfirmedDialog:function(t,n){var i;return this.terminateDialog(),(i=new e.Dialog(this,t,n)).invite_seqnum=this.request.cseq,i.local_seqnum=this.request.cseq,!i.error&&(this.dialog=i,!0)},terminateDialog:function(){this.dialog&&(delete this.ua.subscriptions[this.id],this.dialog.terminate(),delete this.dialog)},receiveRequest:function(t){var n,i=this;function r(){n.expires&&(e.Timers.clearTimeout(i.timers.sub_duration),n.expires=Math.min(i.expires,Math.max(n.expires,0)),i.timers.sub_duration=e.Timers.setTimeout(i.refresh.bind(i),900*n.expires))}if(this.matchEvent(t))if(this.dialog||this.createConfirmedDialog(t,"UAS")&&(this.id=this.dialog.id.toString(),delete this.ua.earlySubscriptions[this.request.call_id+this.request.from.parameters.tag+this.event],this.ua.subscriptions[this.id]=this),n=t.parseHeader("Subscription-State"),t.reply(200,e.C.REASON_200),e.Timers.clearTimeout(this.timers.N),this.emit("notify",{request:t}),"terminated"!==this.state)switch(n.state){case"active":this.state="active",r();break;case"pending":"notify_wait"===this.state&&r(),this.state="pending";break;case"terminated":if(e.Timers.clearTimeout(this.timers.sub_duration),n.reason)switch(this.logger.log("terminating subscription with reason "+n.reason),n.reason){case"deactivated":case"timeout":return void this.subscribe();case"probation":case"giveup":return void(n.params&&n.params["retry-after"]?this.timers.sub_duration=e.Timers.setTimeout(i.subscribe.bind(i),n.params["retry-after"]):this.subscribe())}this.close()}else"terminated"===n.state&&(this.terminateDialog(),e.Timers.clearTimeout(this.timers.N),e.Timers.clearTimeout(this.timers.sub_duration),delete this.ua.subscriptions[this.id]);else t.reply(489)},failed:function(e,t){return this.close(),this.emit("failed",e,t),this.emit("rejected",e,t),this},onDialogError:function(t){this.failed(t,e.C.causes.DIALOG_ERROR)},matchEvent:function(e){var t;return e.hasHeader("Event")?e.hasHeader("Subscription-State")?(t=e.parseHeader("event").event,this.event===t||(this.logger.warn("event match failed"),e.reply(481,"Event Match Failed"),!1)):(this.logger.warn("missing Subscription-State header"),!1):(this.logger.warn("missing Event header"),!1)}}}},function(e,t,n){"use strict";e.exports=function(e){var t;((t=function(t,n,i,r){if(this.options=r=r||{},this.options.extraHeaders=(r.extraHeaders||[]).slice(),this.options.contentType=r.contentType||"text/plain","number"!=typeof r.expires||r.expires%1!=0?this.options.expires=3600:this.options.expires=Number(r.expires),"boolean"!=typeof r.unpublishOnClose?this.options.unpublishOnClose=!0:this.options.unpublishOnClose=r.unpublishOnClose,null==n||""===n)throw new e.Exceptions.MethodParameterError("Publish","Target",n);if(this.target=t.normalizeTarget(n),null==i||""===i)throw new e.Exceptions.MethodParameterError("Publish","Event",i);this.event=i,e.ClientContext.call(this,t,e.C.PUBLISH,this.target,this.options),this.logger=this.ua.getLogger("sip.publish"),this.pubRequestBody=null,this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null,this.publish_refresh_timer=null,t.on("transportCreated",function(e){e.on("transportError",this.onTransportError.bind(this))}.bind(this))}).prototype=Object.create(e.ClientContext.prototype)).constructor=t,t.prototype.publish=function(t){if(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),null!=t&&""!==t)this.options.body=t,this.pubRequestBody=this.options.body,0===this.pubRequestExpires&&(this.pubRequestExpires=this.options.expires,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]||(this.ua.publishers[this.target.toString()+":"+this.event]=this);else{if(this.pubRequestBody=null,null===this.pubRequestEtag)throw new e.Exceptions.MethodParameterError("Publish","Body",t);if(0===this.pubRequestExpires)throw new e.Exceptions.MethodParameterError("Publish","Expire",this.pubRequestExpires)}this.sendPublishRequest()},t.prototype.unpublish=function(){this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,null!==this.pubRequestEtag&&this.sendPublishRequest()},t.prototype.close=function(){this.options.unpublishOnClose?this.unpublish():(this.request=null,e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestExpires=0,this.pubRequestEtag=null),this.ua.publishers[this.target.toString()+":"+this.event]&&delete this.ua.publishers[this.target.toString()+":"+this.event]},t.prototype.sendPublishRequest=function(){var t;(t=Object.create(this.options||Object.prototype)).extraHeaders=(this.options.extraHeaders||[]).slice(),t.extraHeaders.push("Event: "+this.event),t.extraHeaders.push("Expires: "+this.pubRequestExpires),null!==this.pubRequestEtag&&t.extraHeaders.push("SIP-If-Match: "+this.pubRequestEtag),this.request=new e.OutgoingRequest(e.C.PUBLISH,this.target,this.ua,this.options.params,t.extraHeaders),null!==this.pubRequestBody&&(this.request.body={},this.request.body.body=this.pubRequestBody,this.request.body.contentType=this.options.contentType),this.send()},t.prototype.receiveResponse=function(t){var n,i,r=e.Utils.getReasonPhrase(t.status_code);switch(!0){case/^1[0-9]{2}$/.test(t.status_code):this.emit("progress",t,r);break;case/^2[0-9]{2}$/.test(t.status_code):t.hasHeader("SIP-ETag")?this.pubRequestEtag=t.getHeader("SIP-ETag"):this.logger.warn("SIP-ETag header missing in a 200-class response to PUBLISH"),t.hasHeader("Expires")?"number"==typeof(n=Number(t.getHeader("Expires")))&&n>=0&&n<=this.pubRequestExpires?this.pubRequestExpires=n:this.logger.warn("Bad Expires header in a 200-class response to PUBLISH"):this.logger.warn("Expires header missing in a 200-class response to PUBLISH"),0!==this.pubRequestExpires?(this.publish_refresh_timer=e.Timers.setTimeout(this.publish.bind(this),900*this.pubRequestExpires),this.emit("published",t,r)):this.emit("unpublished",t,r);break;case/^412$/.test(t.status_code):null!==this.pubRequestEtag&&0!==this.pubRequestExpires?(this.logger.warn("412 response to PUBLISH, recovering"),this.pubRequestEtag=null,this.emit("progress",t,r),this.publish(this.options.body)):(this.logger.warn("412 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r));break;case/^423$/.test(t.status_code):0!==this.pubRequestExpires&&t.hasHeader("Min-Expires")?"number"==typeof(i=Number(t.getHeader("Min-Expires")))||i>this.pubRequestExpires?(this.logger.warn("423 code in response to PUBLISH, adjusting the Expires value and trying to recover"),this.pubRequestExpires=i,this.emit("progress",t,r),this.publish(this.options.body)):(this.logger.warn("Bad 423 response Min-Expires header received for PUBLISH"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r)):(this.logger.warn("423 response to PUBLISH, recovery failed"),this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r));break;default:this.pubRequestExpires=0,this.emit("failed",t,r),this.emit("unpublished",t,r)}0===this.pubRequestExpires&&(e.Timers.clearTimeout(this.publish_refresh_timer),this.pubRequestBody=null,this.pubRequestEtag=null)},t.prototype.onRequestTimeout=function(){e.ClientContext.prototype.onRequestTimeout.call(this),this.emit("unpublished",null,e.C.causes.REQUEST_TIMEOUT)},t.prototype.onTransportError=function(){e.ClientContext.prototype.onTransportError.call(this),this.emit("unpublished",null,e.C.causes.CONNECTION_ERROR)},e.PublishContext=t}},function(e,t,n){"use strict";(function(t){e.exports=function(e,i){var r,s={STATUS_INIT:0,STATUS_STARTING:1,STATUS_READY:2,STATUS_USER_CLOSED:3,STATUS_NOT_READY:4,CONFIGURATION_ERROR:1,NETWORK_ERROR:2,ALLOWED_METHODS:["ACK","CANCEL","INVITE","MESSAGE","BYE","OPTIONS","INFO","NOTIFY","REFER"],ACCEPTED_BODY_TYPES:["application/sdp","application/dtmf-relay"],MAX_FORWARDS:70,TAG_LENGTH:10};function o(t){if(t instanceof Function)return t.initialize||(t.initialize=function(){return e.Utils.Promise.resolve()}),t}((r=function(t){var n=this;function i(e){return n.emit.bind(n,e)}s.ACCEPTED_BODY_TYPES=s.ACCEPTED_BODY_TYPES.toString(),this.log=new e.LoggerFactory,this.logger=this.getLogger("sip.ua"),this.cache={credentials:{}},this.configuration={},this.dialogs={},this.applicants={},this.data={},this.sessions={},this.subscriptions={},this.earlySubscriptions={},this.publishers={},this.transport=null,this.contact=null,this.status=s.STATUS_INIT,this.error=null,this.transactions={nist:{},nict:{},ist:{},ict:{}},Object.defineProperties(this,{transactionsCount:{get:function(){var e,t=["nist","nict","ist","ict"],n=0;for(e in t)n+=Object.keys(this.transactions[t[e]]).length;return n}},nictTransactionsCount:{get:function(){return Object.keys(this.transactions.nict).length}},nistTransactionsCount:{get:function(){return Object.keys(this.transactions.nist).length}},ictTransactionsCount:{get:function(){return Object.keys(this.transactions.ict).length}},istTransactionsCount:{get:function(){return Object.keys(this.transactions.ist).length}}}),void 0===t?t={}:("string"==typeof t||t instanceof String)&&(t={uri:t}),t.log&&(t.log.hasOwnProperty("builtinEnabled")&&(this.log.builtinEnabled=t.log.builtinEnabled),t.log.hasOwnProperty("level")&&(this.log.level=t.log.level),t.log.hasOwnProperty("connector")&&(this.log.connector=t.log.connector));try{this.loadConfig(t)}catch(e){throw this.status=s.STATUS_NOT_READY,this.error=s.CONFIGURATION_ERROR,e}this.registerContext=new e.RegisterContext(this),this.registerContext.on("failed",i("registrationFailed")),this.registerContext.on("registered",i("registered")),this.registerContext.on("unregistered",i("unregistered")),this.configuration.autostart&&this.start()}).prototype=Object.create(e.EventEmitter.prototype)).register=function(e){return this.configuration.register=!0,this.registerContext.register(e),this},r.prototype.unregister=function(e){this.configuration.register=!1;var t=this.registerContext;return this.transport.afterConnected(t.unregister.bind(t,e)),this},r.prototype.isRegistered=function(){return this.registerContext.registered},r.prototype.invite=function(t,n,i){var r=new e.InviteClientContext(this,t,n,i);return this.transport.afterConnected(function(){r.invite(),this.emit("inviteSent",r)}.bind(this)),r},r.prototype.subscribe=function(t,n,i){var r=new e.Subscription(this,t,n,i);return this.transport.afterConnected(r.subscribe.bind(r)),r},r.prototype.publish=function(t,n,i,r){var s=new e.PublishContext(this,t,n,r);return this.transport.afterConnected(s.publish.bind(s,i)),s},r.prototype.message=function(t,n,i){if(void 0===n)throw new TypeError("Not enough arguments");return(i=Object.create(i||Object.prototype)).contentType||(i.contentType="text/plain"),i.body=n,this.request(e.C.MESSAGE,t,i)},r.prototype.request=function(t,n,i){var r=new e.ClientContext(this,t,n,i);return this.transport.afterConnected(r.send.bind(r)),r},r.prototype.stop=function(){var e,n,r,o,a=this;if(this.logger.log("user requested closure..."),this.status===s.STATUS_USER_CLOSED)return this.logger.warn("UA already closed"),this;for(e in this.logger.log("closing registerContext"),this.registerContext.close(),this.sessions)this.logger.log("closing session "+e),this.sessions[e].terminate();for(n in this.subscriptions)this.logger.log("unsubscribing from subscription "+n),this.subscriptions[n].close();for(n in this.earlySubscriptions)this.logger.log("unsubscribing from early subscription "+n),this.earlySubscriptions[n].close();for(o in this.publishers)this.logger.log("unpublish "+o),this.publishers[o].close();for(r in this.applicants)this.applicants[r].close();return this.status=s.STATUS_USER_CLOSED,0===this.nistTransactionsCount&&0===this.nictTransactionsCount?this.transport.disconnect():this.on("transactionDestroyed",function e(){0===a.nistTransactionsCount&&0===a.nictTransactionsCount&&(a.removeListener("transactionDestroyed",e),a.transport.disconnect())}),"function"==typeof i.removeEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||i.removeEventListener("unload",this.environListener)),this},r.prototype.start=function(){if(this.logger.log("user requested startup..."),this.status===s.STATUS_INIT){if(this.status=s.STATUS_STARTING,!this.configuration.transportConstructor)throw new e.Exceptions.TransportError("Transport constructor not set");this.transport=new this.configuration.transportConstructor(this.getLogger("sip.transport"),this.configuration.transportOptions),this.setTransportListeners(),this.emit("transportCreated",this.transport),this.transport.connect()}else this.status===s.STATUS_USER_CLOSED?(this.logger.log("resuming"),this.status=s.STATUS_READY,this.transport.connect()):this.status===s.STATUS_STARTING?this.logger.log("UA is in STARTING status, not opening new connection"):this.status===s.STATUS_READY?this.logger.log("UA is in READY status, not resuming"):this.logger.error("Connection is down. Auto-Recovery system is trying to connect");return this.configuration.autostop&&"function"==typeof i.addEventListener&&(t.chrome&&t.chrome.app&&t.chrome.app.runtime||(this.environListener=this.stop.bind(this),i.addEventListener("unload",this.environListener))),this},r.prototype.normalizeTarget=function(t){return e.Utils.normalizeTarget(t,this.configuration.hostportParams)},r.prototype.saveCredentials=function(e){return this.cache.credentials[e.realm]=this.cache.credentials[e.realm]||{},this.cache.credentials[e.realm][e.uri]=e,this},r.prototype.getCredentials=function(e){var t,n;return t=e.ruri.host,this.cache.credentials[t]&&this.cache.credentials[t][e.ruri]&&((n=this.cache.credentials[t][e.ruri]).method=e.method),n},r.prototype.getLogger=function(e,t){return this.log.getLogger(e,t)},r.prototype.onTransportError=function(){this.status!==s.STATUS_USER_CLOSED&&(this.error&&this.error===s.NETWORK_ERROR||(this.status=s.STATUS_NOT_READY,this.error=s.NETWORK_ERROR))},r.prototype.setTransportListeners=function(){this.transport.on("connected",this.onTransportConnected.bind(this)),this.transport.on("message",this.onTransportReceiveMsg.bind(this)),this.transport.on("transportError",this.onTransportError.bind(this))},r.prototype.onTransportConnected=function(){this.configuration.register&&this.configuration.authenticationFactory.initialize().then(function(){this.registerContext.onTransportConnected()}.bind(this))},r.prototype.onTransportReceiveMsg=function(t){var n;if(t=e.Parser.parseMessage(t,this),this.status===e.UA.C.STATUS_USER_CLOSED&&t instanceof e.IncomingRequest)this.logger.warn("UA received message when status = USER_CLOSED - aborting");else if(e.sanityCheck(t,this,this.transport))if(t instanceof e.IncomingRequest)t.transport=this.transport,this.receiveRequest(t);else if(t instanceof e.IncomingResponse)switch(t.method){case e.C.INVITE:(n=this.transactions.ict[t.via_branch])&&n.receiveResponse(t);break;case e.C.ACK:break;default:(n=this.transactions.nict[t.via_branch])&&n.receiveResponse(t)}},r.prototype.newTransaction=function(e){this.transactions[e.type][e.id]=e,this.emit("newTransaction",{transaction:e})},r.prototype.destroyTransaction=function(e){delete this.transactions[e.type][e.id],this.emit("transactionDestroyed",{transaction:e})},r.prototype.receiveRequest=function(t){var n,i,r,o,a,c,u=t.method;function h(e){return e&&e.user===t.ruri.user}if(!(h(this.configuration.uri)||h(this.contact.uri)||h(this.contact.pub_gruu)||h(this.contact.temp_gruu)))return this.logger.warn("Request-URI does not point to us"),void(t.method!==e.C.ACK&&t.reply_sl(404));if(t.ruri.scheme!==e.C.SIPS){if(!e.Transactions.checkTransaction(this,t))if(u===e.C.OPTIONS?(new e.Transactions.NonInviteServerTransaction(t,this),t.reply(200,null,["Allow: "+e.UA.C.ALLOWED_METHODS.toString(),"Accept: "+s.ACCEPTED_BODY_TYPES])):u===e.C.MESSAGE?((r=new e.ServerContext(this,t)).body=t.body,r.content_type=t.getHeader("Content-Type")||"text/plain",t.reply(200,null),this.emit("message",r)):u!==e.C.INVITE&&u!==e.C.ACK&&new e.ServerContext(this,t),t.to_tag)(n=this.findDialog(t))?(u===e.C.INVITE&&new e.Transactions.InviteServerTransaction(t,this),n.receiveRequest(t)):u===e.C.NOTIFY?(i=this.findSession(t),o=this.findEarlySubscription(t),i?i.receiveRequest(t):o?o.receiveRequest(t):(this.logger.warn("received NOTIFY request for a non existent session or subscription"),t.reply(481,"Subscription does not exist"))):u!==e.C.ACK&&t.reply(481);else switch(u){case e.C.INVITE:if(a=this.configuration.replaces!==e.C.supported.UNSUPPORTED&&t.parseHeader("replaces")){if(!(c=this.dialogs[a.call_id+a.replaces_to_tag+a.replaces_from_tag]))return void t.reply_sl(481,null);if(c.owner.status===e.Session.C.STATUS_TERMINATED)return void t.reply_sl(603,null);if(c.state===e.Dialog.C.STATUS_CONFIRMED&&a.early_only)return void t.reply_sl(486,null)}(i=new e.InviteServerContext(this,t)).replacee=c&&c.owner,this.emit("invite",i);break;case e.C.BYE:t.reply(481);break;case e.C.CANCEL:(i=this.findSession(t))?i.receiveRequest(t):this.logger.warn("received CANCEL request for a non existent session");break;case e.C.ACK:break;case e.C.NOTIFY:this.configuration.allowLegacyNotifications&&this.listeners("notify").length>0?(t.reply(200,null),this.emit("notify",{request:t})):t.reply(481,"Subscription does not exist");break;case e.C.REFER:if(this.logger.log("Received an out of dialog refer"),this.configuration.allowOutOfDialogRefers){this.logger.log("Allow out of dialog refers is enabled on the UA");var d=new e.ReferServerContext(this,t);this.listeners("outOfDialogReferRequested").length?this.emit("outOfDialogReferRequested",d):(this.logger.log("No outOfDialogReferRequest listeners, automatically accepting and following the out of dialog refer"),d.accept({followRefer:!0}));break}t.reply(405);break;default:t.reply(405)}}else t.reply_sl(416)},r.prototype.findSession=function(e){return this.sessions[e.call_id+e.from_tag]||this.sessions[e.call_id+e.to_tag]||null},r.prototype.findDialog=function(e){return this.dialogs[e.call_id+e.from_tag+e.to_tag]||this.dialogs[e.call_id+e.to_tag+e.from_tag]||null},r.prototype.findEarlySubscription=function(e){return this.earlySubscriptions[e.call_id+e.to_tag+e.getHeader("event")]||null},r.prototype.loadConfig=function(t){var i,r,s,a,c,u={viaHost:e.Utils.createRandomToken(12)+".invalid",uri:new e.URI("sip","anonymous."+e.Utils.createRandomToken(6),"anonymous.invalid",null,null),custom:{},displayName:"",password:null,registerExpires:600,register:!0,registrarServer:null,transportConstructor:n(29)(e),transportOptions:{},userAgentString:e.C.USER_AGENT,noAnswerTimeout:60,hackViaTcp:!1,hackIpInContact:!1,hackWssInTransport:!1,hackAllowUnregisteredOptionTags:!1,sessionDescriptionHandlerFactoryOptions:{constraints:{},peerConnectionOptions:{}},contactName:e.Utils.createRandomToken(8),contactTransport:"ws",forceRport:!1,autostart:!0,autostop:!0,rel100:e.C.supported.UNSUPPORTED,dtmfType:e.C.dtmfType.INFO,replaces:e.C.supported.UNSUPPORTED,sessionDescriptionHandlerFactory:n(30)(e).defaultFactory,authenticationFactory:o(function(t){return new e.DigestAuthentication(t)}),allowLegacyNotifications:!1,allowOutOfDialogRefers:!1};function h(e,n){var i=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==i){var r=t.hasOwnProperty(e);t.hasOwnProperty(i)&&(n.warn(i+" is deprecated, please use "+e),r&&n.warn(e+" overriding "+i)),t[e]=r?t[e]:t[i]}}var d=this.getConfigurationCheck();for(i in d.mandatory){if(h(i,this.logger),!t.hasOwnProperty(i))throw new e.Exceptions.ConfigurationError(i);if(r=t[i],void 0===(s=d.mandatory[i](r)))throw new e.Exceptions.ConfigurationError(i,r);u[i]=s}for(i in d.optional)if(h(i,this.logger),t.hasOwnProperty(i)){if((r=t[i])instanceof Array&&0===r.length)continue;if(null===r||""===r||void 0===r)continue;if("number"==typeof r&&isNaN(r))continue;if(void 0===(s=d.optional[i](r)))throw new e.Exceptions.ConfigurationError(i,r);u[i]=s}0===u.displayName&&(u.displayName="0"),u.instanceId||(u.instanceId=e.Utils.newUUID()),u.sipjsId=e.Utils.createRandomToken(5),(a=u.uri.clone()).user=null,u.hostportParams=a.toRaw().replace(/^sip:/i,""),u.authorizationUser||(u.authorizationUser=u.uri.user),u.registrarServer||((c=u.uri.clone()).user=null,u.registrarServer=c),u.noAnswerTimeout=1e3*u.noAnswerTimeout,u.hackIpInContact&&("boolean"==typeof u.hackIpInContact?u.viaHost=e.Utils.getRandomTestNetIP():"string"==typeof u.hackIpInContact&&(u.viaHost=u.hackIpInContact)),u.hackWssInTransport&&(u.contactTransport="wss"),this.contact={pub_gruu:null,temp_gruu:null,uri:new e.URI("sip",u.contactName,u.viaHost,null,{transport:u.contactTransport}),toString:function(e){var t=(e=e||{}).anonymous||null,n=e.outbound||null,i="<";return i+=t?(this.temp_gruu||"sip:anonymous@anonymous.invalid;transport="+u.contactTransport).toString():(this.pub_gruu||this.uri).toString(),n&&(i+=";ob"),i+=">"}};var l={};for(i in u)l[i]=u[i];for(i in Object.assign(this.configuration,l),this.logger.log("configuration parameters after validation:"),u)switch(i){case"uri":case"registrarServer":case"sessionDescriptionHandlerFactory":this.logger.log("· "+i+": "+u[i]);break;case"password":this.logger.log("· "+i+": NOT SHOWN");break;case"transportConstructor":this.logger.log("· "+i+": "+u[i].name);break;default:this.logger.log("· "+i+": "+JSON.stringify(u[i]))}},r.prototype.getConfigurationCheck=function(){return{mandatory:{},optional:{uri:function(t){var n;return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(n=e.URI.parse(t))&&n.user?n:void 0},transportConstructor:function(e){if(e instanceof Function)return e},transportOptions:function(e){if("object"==typeof e)return e},authorizationUser:function(t){return-1===e.Grammar.parse('"'+t+'"',"quoted_string")?void 0:t},displayName:function(t){return-1===e.Grammar.parse('"'+t+'"',"displayName")?void 0:t},dtmfType:function(t){switch(t){case e.C.dtmfType.RTP:return e.C.dtmfType.RTP;case e.C.dtmfType.INFO:default:return e.C.dtmfType.INFO}},hackViaTcp:function(e){if("boolean"==typeof e)return e},hackIpInContact:function(t){return"boolean"==typeof t?t:"string"==typeof t&&-1!==e.Grammar.parse(t,"host")?t:void 0},hackWssInTransport:function(e){if("boolean"==typeof e)return e},hackAllowUnregisteredOptionTags:function(e){if("boolean"==typeof e)return e},contactTransport:function(e){if("string"==typeof e)return e},forceRport:function(e){if("boolean"==typeof e)return e},instanceId:function(t){if("string"==typeof t)return/^uuid:/i.test(t)&&(t=t.substr(5)),-1===e.Grammar.parse(t,"uuid")?void 0:t},noAnswerTimeout:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n},password:function(e){return String(e)},rel100:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},replaces:function(t){return t===e.C.supported.REQUIRED?e.C.supported.REQUIRED:t===e.C.supported.SUPPORTED?e.C.supported.SUPPORTED:e.C.supported.UNSUPPORTED},register:function(e){if("boolean"==typeof e)return e},registerExpires:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n},registrarServer:function(t){var n;if("string"==typeof t)return/^sip:/i.test(t)||(t=e.C.SIP+":"+t),(n=e.URI.parse(t))?n.user?void 0:n:void 0},userAgentString:function(e){if("string"==typeof e)return e},autostart:function(e){if("boolean"==typeof e)return e},autostop:function(e){if("boolean"==typeof e)return e},sessionDescriptionHandlerFactory:function(e){if(e instanceof Function)return e},sessionDescriptionHandlerFactoryOptions:function(e){if("object"==typeof e)return e},authenticationFactory:o,allowLegacyNotifications:function(e){if("boolean"==typeof e)return e},custom:function(e){if("object"==typeof e)return e},contactName:function(e){if("string"==typeof e)return e}}}},r.C=s,e.UA=r}}).call(this,n(28))},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";(function(t){e.exports=function(e){var n,i={STATUS_CONNECTING:0,STATUS_OPEN:1,STATUS_CLOSING:2,STATUS_CLOSED:3},r=(t.window||t).WebSocket;return(n=function(t,n){n=e.Utils.defaultOptions({},n),this.logger=t,this.ws=null,this.server=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.connectionTimeout=null,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.reconnectionAttempts=0,this.reconnectTimer=null,this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null,this.status=i.STATUS_CONNECTING,this.configuration={},this.loadConfig(n)}).prototype=Object.create(e.Transport.prototype,{isConnected:{writable:!0,value:function(){return this.status===i.STATUS_OPEN}},sendPromise:{writable:!0,value:function(t,n){if(n=n||{},!this.statusAssert(i.STATUS_OPEN,n.force))return this.onError("unable to send message - WebSocket not open"),e.Utils.Promise.reject();var r=t.toString();return this.ws?(!0===this.configuration.traceSip&&this.logger.log("sending WebSocket message:\n\n"+r+"\n"),this.ws.send(r),e.Utils.Promise.resolve({msg:r})):(this.onError("unable to send message - WebSocket does not exist"),e.Utils.Promise.reject())}},disconnectPromise:{writable:!0,value:function(t){return this.disconnectionPromise?this.disconnectionPromise:(t=t||{},this.statusTransition(i.STATUS_CLOSING,t.force)?(this.disconnectionPromise=new e.Utils.Promise(function(n,i){this.disconnectDeferredResolve=n,this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws?(this.stopSendingKeepAlives(),this.logger.log("closing WebSocket "+this.server.ws_uri),this.ws.close(t.code,t.reason)):i("Attempted to disconnect but the websocket doesn't exist")}.bind(this)),this.disconnectionPromise):e.Utils.Promise.reject("Failed status transition - attempted to disconnect a socket that was not open"))}},connectPromise:{writable:!0,value:function(t){return this.connectionPromise?this.connectionPromise:(t=t||{},this.server=this.server||this.getNextWsServer(t.force),this.connectionPromise=new e.Utils.Promise(function(n,s){if((this.status===i.STATUS_OPEN||this.status===i.STATUS_CLOSING)&&!t.force)return this.logger.warn("WebSocket "+this.server.ws_uri+" is already connected"),void s("Failed status check - attempted to open a connection but already open/closing");this.connectDeferredResolve=n,this.status=i.STATUS_CONNECTING,this.logger.log("connecting to WebSocket "+this.server.ws_uri),this.disposeWs();try{this.ws=new r(this.server.ws_uri,"sip")}catch(e){return this.ws=null,this.status=i.STATUS_CLOSED,this.onError("error connecting to WebSocket "+this.server.ws_uri+":"+e),void s("Failed to create a websocket")}this.ws?(this.connectionTimeout=e.Timers.setTimeout(function(){this.onError("took too long to connect - exceeded time set in configuration.connectionTimeout: "+this.configuration.connectionTimeout+"s")}.bind(this),1e3*this.configuration.connectionTimeout),this.boundOnOpen=this.onOpen.bind(this),this.boundOnMessage=this.onMessage.bind(this),this.boundOnClose=this.onClose.bind(this),this.boundOnError=this.onError.bind(this),this.ws.addEventListener("open",this.boundOnOpen),this.ws.addEventListener("message",this.boundOnMessage),this.ws.addEventListener("close",this.boundOnClose),this.ws.addEventListener("error",this.boundOnError)):s("Unexpected instance websocket not set")}.bind(this)),this.connectionPromise)}},onOpen:{writable:!0,value:function(){this.status=i.STATUS_OPEN,this.emit("connected"),e.Timers.clearTimeout(this.connectionTimeout),this.logger.log("WebSocket "+this.server.ws_uri+" connected"),null!==this.reconnectTimer&&(e.Timers.clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.reconnectionAttempts=0,this.disconnectionPromise=null,this.disconnectDeferredResolve=null,this.startSendingKeepAlives(),this.connectDeferredResolve?this.connectDeferredResolve({overrideEvent:!0}):this.logger.warn("Unexpected websocket.onOpen with no connectDeferredResolve")}},onClose:{writable:!0,value:function(t){if(this.logger.log("WebSocket disconnected (code: "+t.code+(t.reason?"| reason: "+t.reason:"")+")"),this.emit("disconnected",{code:t.code,reason:t.reason}),this.status!==i.STATUS_CLOSING&&(this.logger.warn("WebSocket abrupt disconnection"),this.emit("transportError")),this.stopSendingKeepAlives(),e.Timers.clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.connectionPromise=null,this.connectDeferredResolve=null,this.disconnectDeferredResolve)return this.disconnectDeferredResolve({overrideEvent:!0}),this.statusTransition(i.STATUS_CLOSED),void(this.disconnectDeferredResolve=null);this.status=i.STATUS_CLOSED,this.reconnect()}},disposeWs:{writable:!0,value:function(){this.ws&&(this.ws.removeEventListener("open",this.boundOnOpen),this.ws.removeEventListener("message",this.boundOnMessage),this.ws.removeEventListener("close",this.boundOnClose),this.ws.removeEventListener("error",this.boundOnError),this.boundOnOpen=null,this.boundOnMessage=null,this.boundOnClose=null,this.boundOnError=null,this.ws=null)}},onMessage:{writable:!0,value:function(e){var t=e.data;if(/^(\r\n)+$/.test(t))return this.clearKeepAliveTimeout(),void(!0===this.configuration.traceSip&&this.logger.log("received WebSocket message with CRLF Keep Alive response"));if(t){if("string"!=typeof t){try{t=String.fromCharCode.apply(null,new Uint8Array(t))}catch(e){return void this.logger.warn("received WebSocket binary message failed to be converted into string, message discarded")}!0===this.configuration.traceSip&&this.logger.log("received WebSocket binary message:\n\n"+t+"\n")}else!0===this.configuration.traceSip&&this.logger.log("received WebSocket text message:\n\n"+t+"\n");this.emit("message",t)}else this.logger.warn("received empty message, message discarded")}},onError:{writable:!0,value:function(e){this.logger.warn("Transport error: "+e),this.emit("transportError")}},reconnect:{writable:!0,value:function(){if(this.reconnectionAttempts>0&&this.logger.log("Reconnection attempt "+this.reconnectionAttempts+" failed"),this.noAvailableServers())return this.logger.warn("no available ws servers left - going to closed state"),this.status=i.STATUS_CLOSED,this.emit("closed"),void this.resetServerErrorStatus();this.isConnected()&&(this.logger.warn("attempted to reconnect while connected - forcing disconnect"),this.disconnect({force:!0})),this.reconnectionAttempts+=1,this.reconnectionAttempts>this.configuration.maxReconnectionAttempts?(this.logger.warn("maximum reconnection attempts for WebSocket "+this.server.ws_uri),this.logger.log("transport "+this.server.ws_uri+" failed | connection state set to 'error'"),this.server.isError=!0,this.emit("transportError"),this.server=this.getNextWsServer(),this.reconnectionAttempts=0,this.reconnect()):(this.logger.log("trying to reconnect to WebSocket "+this.server.ws_uri+" (reconnection attempt "+this.reconnectionAttempts+")"),this.reconnectTimer=e.Timers.setTimeout(function(){this.connect(),this.reconnectTimer=null}.bind(this),1===this.reconnectionAttempts?0:1e3*this.configuration.reconnectionTimeout))}},resetServerErrorStatus:{writable:!0,value:function(){var e,t=this.configuration.wsServers.length;for(e=0;e<t;e++)this.configuration.wsServers[e].isError=!1}},getNextWsServer:{writable:!0,value:function(e){if(!this.noAvailableServers()){var t,n,i,r=[];for(n=this.configuration.wsServers.length,t=0;t<n;t++)(i=this.configuration.wsServers[t]).isError&&!e||(0===r.length?r.push(i):i.weight>r[0].weight?r=[i]:i.weight===r[0].weight&&r.push(i));return r[t=Math.floor(Math.random()*r.length)]}this.logger.warn("attempted to get next ws server but there are no available ws servers left")}},noAvailableServers:{writable:!0,value:function(){var e;for(e in this.configuration.wsServers)if(!this.configuration.wsServers[e].isError)return!1;return!0}},sendKeepAlive:{writable:!0,value:function(){if(!this.keepAliveDebounceTimeout)return this.keepAliveDebounceTimeout=e.Timers.setTimeout(function(){this.emit("keepAliveDebounceTimeout"),this.clearKeepAliveTimeout()}.bind(this),1e3*this.configuration.keepAliveDebounce),this.send("\r\n\r\n")}},clearKeepAliveTimeout:{writable:!0,value:function(){e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveDebounceTimeout=null}},startSendingKeepAlives:{writable:!0,value:function(){var t,n;this.configuration.keepAliveInterval&&!this.keepAliveInterval&&(this.keepAliveInterval=e.Timers.setInterval(function(){this.sendKeepAlive(),this.startSendingKeepAlives()}.bind(this),(t=this.configuration.keepAliveInterval,n=.8*t,1e3*(Math.random()*(t-n)+n))))}},stopSendingKeepAlives:{writable:!0,value:function(){e.Timers.clearInterval(this.keepAliveInterval),e.Timers.clearTimeout(this.keepAliveDebounceTimeout),this.keepAliveInterval=null,this.keepAliveDebounceTimeout=null}},statusAssert:{writable:!0,value:function(e,t){return e===this.status||(t?(this.logger.warn("Attempted to assert "+Object.keys(i)[this.status]+" as "+Object.keys(i)[e]+"- continuing with option: 'force'"),!0):(this.logger.warn("Tried to assert "+Object.keys(i)[e]+" but is currently "+Object.keys(i)[this.status]),!1))}},statusTransition:{writable:!0,value:function(e,t){return this.logger.log("Attempting to transition status from "+Object.keys(i)[this.status]+" to "+Object.keys(i)[e]),e===i.STATUS_OPEN&&this.statusAssert(i.STATUS_CONNECTING,t)||e===i.STATUS_CLOSING&&this.statusAssert(i.STATUS_OPEN,t)||e===i.STATUS_CLOSED&&this.statusAssert(i.STATUS_CLOSING,t)?(this.status=e,!0):(this.logger.warn("Status transition failed - result: no-op - reason: either gave an nonexistent status or attempted illegal transition"),!1)}},loadConfig:{writable:!0,value:function(t){var n,i,r,s={wsServers:[{scheme:"WSS",sip_uri:"<sip:edge.sip.onsip.com;transport=ws;lr>",weight:0,ws_uri:"wss://edge.sip.onsip.com",isError:!1}],connectionTimeout:5,maxReconnectionAttempts:3,reconnectionTimeout:4,keepAliveInterval:0,keepAliveDebounce:10,traceSip:!1};function o(e,n){var i=e.replace(/([a-z][A-Z])/g,function(e){return e[0]+"_"+e[1].toLowerCase()});if(e!==i){var r=t.hasOwnProperty(e);t.hasOwnProperty(i)&&(n.warn(i+" is deprecated, please use "+e),r&&n.warn(e+" overriding "+i)),t[e]=r?t[e]:t[i]}}var a=this.getConfigurationCheck();for(n in a.mandatory){if(o(n,this.logger),!t.hasOwnProperty(n))throw new e.Exceptions.ConfigurationError(n);if(i=t[n],void 0===(r=a.mandatory[n](i)))throw new e.Exceptions.ConfigurationError(n,i);s[n]=r}for(n in a.optional)if(o(n,this.logger),t.hasOwnProperty(n)){if((i=t[n])instanceof Array&&0===i.length)continue;if(null===i||""===i||void 0===i)continue;if("number"==typeof i&&isNaN(i))continue;if(void 0===(r=a.optional[n](i)))throw new e.Exceptions.ConfigurationError(n,i);s[n]=r}var c={};for(n in s)c[n]={value:s[n]};for(n in Object.defineProperties(this.configuration,c),this.logger.log("configuration parameters after validation:"),s)this.logger.log("· "+n+": "+JSON.stringify(s[n]))}},getConfigurationCheck:{writable:!0,value:function(){return{mandatory:{},optional:{wsServers:function(t){var n,i,r;if("string"==typeof t)t=[{ws_uri:t}];else{if(!(t instanceof Array))return;for(i=t.length,n=0;n<i;n++)"string"==typeof t[n]&&(t[n]={ws_uri:t[n]})}if(0===t.length)return!1;for(i=t.length,n=0;n<i;n++){if(!t[n].ws_uri)return;if(t[n].weight&&!Number(t[n].weight))return;if(-1===(r=e.Grammar.parse(t[n].ws_uri,"absoluteURI")))return;if(["wss","ws","udp"].indexOf(r.scheme)<0)return;t[n].sip_uri="<sip:"+r.host+(r.port?":"+r.port:"")+";transport="+r.scheme.replace(/^wss$/i,"ws")+";lr>",t[n].weight||(t[n].weight=0),t[n].isError=!1,t[n].scheme=r.scheme.toUpperCase()}return t},keepAliveInterval:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n},keepAliveDebounce:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n},traceSip:function(e){if("boolean"==typeof e)return e},connectionTimeout:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n},maxReconnectionAttempts:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>=0)return n},reconnectionTimeout:function(t){var n;if(e.Utils.isDecimal(t)&&(n=Number(t))>0)return n}}}}}}),n.C=i,e.Web.Transport=n,n}}).call(this,n(28))},function(e,t,n){"use strict";(function(t){e.exports=function(e){var i=function(e,n,i){this.options=i||{},this.logger=e,this.observer=n,this.dtmfSender=null,this.shouldAcquireMedia=!0,this.CONTENT_TYPE="application/sdp",this.C={},this.C.DIRECTION={NULL:null,SENDRECV:"sendrecv",SENDONLY:"sendonly",RECVONLY:"recvonly",INACTIVE:"inactive"},this.logger.log("SessionDescriptionHandlerOptions: "+JSON.stringify(this.options)),this.direction=this.C.DIRECTION.NULL,this.modifiers=this.options.modifiers||[],Array.isArray(this.modifiers)||(this.modifiers=[this.modifiers]);var r=t.window||t;this.WebRTC={MediaStream:r.MediaStream,getUserMedia:r.navigator.mediaDevices.getUserMedia.bind(r.navigator.mediaDevices),RTCPeerConnection:r.RTCPeerConnection},this.iceGatheringDeferred=null,this.iceGatheringTimeout=!1,this.iceGatheringTimer=null,this.initPeerConnection(this.options.peerConnectionOptions),this.constraints=this.checkAndDefaultConstraints(this.options.constraints)};return i.defaultFactory=function(e,t){var r=e.ua.getLogger("sip.invitecontext.sessionDescriptionHandler",e.id),s=new(n(31))(e,t);return new i(r,s,t)},i.prototype=Object.create(e.SessionDescriptionHandler.prototype,{close:{writable:!0,value:function(){this.logger.log("closing PeerConnection"),this.peerConnection&&"closed"!==this.peerConnection.signalingState&&(this.peerConnection.getSenders?this.peerConnection.getSenders().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getLocalStreams which is deprecated"),this.peerConnection.getLocalStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.peerConnection.getReceivers?this.peerConnection.getReceivers().forEach(function(e){e.track&&e.track.stop()}):(this.logger.warn("Using getRemoteStreams which is deprecated"),this.peerConnection.getRemoteStreams().forEach(function(e){e.getTracks().forEach(function(e){e.stop()})})),this.resetIceGatheringComplete(),this.peerConnection.close())}},getDescription:{writable:!0,value:function(t,n){(t=t||{}).peerConnectionOptions&&this.initPeerConnection(t.peerConnectionOptions);var i=Object.assign({},this.constraints,t.constraints);return i=this.checkAndDefaultConstraints(i),JSON.stringify(i)!==JSON.stringify(this.constraints)&&(this.constraints=i,this.shouldAcquireMedia=!0),n=n||[],Array.isArray(n)||(n=[n]),n=n.concat(this.modifiers),e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return this.createOfferOrAnswer(t.RTCOfferOptions,n)}.bind(this)).then(function(e){return this.emit("getDescription",e),{body:e.sdp,contentType:this.CONTENT_TYPE}}.bind(this))}},hasDescription:{writable:!0,value:function(e){return e===this.CONTENT_TYPE}},holdModifier:{writable:!0,value:function(t){return/a=(sendrecv|sendonly|recvonly|inactive)/.test(t.sdp)?(t.sdp=t.sdp.replace(/a=sendrecv\r\n/g,"a=sendonly\r\n"),t.sdp=t.sdp.replace(/a=recvonly\r\n/g,"a=inactive\r\n")):t.sdp=t.sdp.replace(/(m=[^\r]*\r\n)/g,"$1a=sendonly\r\n"),e.Utils.Promise.resolve(t)}},setDescription:{writable:!0,value:function(t,n,i){var r=this,s=this;(n=n||{}).peerConnectionOptions&&this.initPeerConnection(n.peerConnectionOptions),i=i||[],Array.isArray(i)||(i=[i]),i=i.concat(this.modifiers);var o={type:this.hasOffer("local")?"answer":"offer",sdp:t};return e.Utils.Promise.resolve().then(function(){if(this.shouldAcquireMedia&&this.options.alwaysAcquireMediaFirst)return this.acquire(this.constraints).then(function(){this.shouldAcquireMedia=!1}.bind(this))}.bind(this)).then(function(){return e.Utils.reducePromises(i,o)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var n=new e.Exceptions.SessionDescriptionHandlerError("setDescription",t,"The modifiers did not resolve successfully");throw r.logger.error(n.message),s.emit("peerConnection-setRemoteDescriptionFailed",n),n}).then(function(e){return s.emit("setDescription",e),s.peerConnection.setRemoteDescription(e)}).catch(function(s){if(s instanceof e.Exceptions.SessionDescriptionHandlerError)throw s;if(/^m=video.+$/gm.test(t)&&!n.disableAudioFallback)return n.disableAudioFallback=!0,r.setDescription(t,n,[e.Web.Modifiers.stripVideo].concat(i));var o=new e.Exceptions.SessionDescriptionHandlerError("setDescription",s);throw r.logger.error(o.error),r.emit("peerConnection-setRemoteDescriptionFailed",o),o}).then(function(){s.peerConnection.getReceivers?s.emit("setRemoteDescription",s.peerConnection.getReceivers()):s.emit("setRemoteDescription",s.peerConnection.getRemoteStreams()),s.emit("confirmed",s)})}},sendDtmf:{writable:!0,value:function(e,t){if(!this.dtmfSender&&this.hasBrowserGetSenderSupport()){var n=this.peerConnection.getSenders();n.length>0&&(this.dtmfSender=n[0].dtmf)}if(!this.dtmfSender&&this.hasBrowserTrackSupport()){var i=this.peerConnection.getLocalStreams();if(i.length>0){var r=i[0].getAudioTracks();r.length>0&&(this.dtmfSender=this.peerConnection.createDTMFSender(r[0]))}}if(!this.dtmfSender)return!1;try{this.dtmfSender.insertDTMF(e,t.duration,t.interToneGap)}catch(e){if("InvalidStateError"===e.type||"InvalidCharacterError"===e.type)return this.logger.error(e),!1;throw e}return this.logger.log("DTMF sent via RTP: "+e.toString()),!0}},getDirection:{writable:!0,value:function(){return this.direction}},createOfferOrAnswer:{writable:!0,value:function(t,n){var i,r=this,s=this,o=this.peerConnection;return t=t||{},i=s.hasOffer("remote")?"createAnswer":"createOffer",o[i](t).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var n=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-"+i+"Failed");throw r.emit("peerConnection-"+i+"Failed",n),n}).then(function(t){return e.Utils.reducePromises(n,s.createRTCSessionDescriptionInit(t))}).then(function(e){return s.resetIceGatheringComplete(),o.setLocalDescription(e)}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var n=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t,"peerConnection-SetLocalDescriptionFailed");throw r.emit("peerConnection-SetLocalDescriptionFailed",n),n}).then(function(){return s.waitForIceGatheringComplete()}).then(function(){var t=s.createRTCSessionDescriptionInit(s.peerConnection.localDescription);return e.Utils.reducePromises(n,t)}).then(function(e){return s.setDirection(e.sdp),e}).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var n=new e.Exceptions.SessionDescriptionHandlerError("createOfferOrAnswer",t);throw r.logger.error(n),n})}},createRTCSessionDescriptionInit:{writable:!0,value:function(e){return{type:e.type,sdp:e.sdp}}},addDefaultIceCheckingTimeout:{writable:!0,value:function(e){return void 0===e.iceCheckingTimeout&&(e.iceCheckingTimeout=5e3),e}},addDefaultIceServers:{writable:!0,value:function(e){return e.iceServers||(e.iceServers=[{urls:"stun:stun.l.google.com:19302"}]),e}},checkAndDefaultConstraints:{writable:!0,value:function(e){var t={audio:!0,video:!this.options.alwaysAcquireMediaFirst};return e=e||t,0===Object.keys(e).length&&e.constructor===Object?t:e}},hasBrowserTrackSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.addTrack)}},hasBrowserGetSenderSupport:{writable:!0,value:function(){return Boolean(this.peerConnection.getSenders)}},initPeerConnection:{writable:!0,value:function(t){var n=this;t=t||{},(t=this.addDefaultIceCheckingTimeout(t)).rtcConfiguration=t.rtcConfiguration||{},t.rtcConfiguration=this.addDefaultIceServers(t.rtcConfiguration),this.logger.log("initPeerConnection"),this.peerConnection&&(this.logger.log("Already have a peer connection for this session. Tearing down."),this.resetIceGatheringComplete(),this.peerConnection.close()),this.peerConnection=new this.WebRTC.RTCPeerConnection(t.rtcConfiguration),this.logger.log("New peer connection created"),"ontrack"in this.peerConnection?this.peerConnection.addEventListener("track",function(e){n.logger.log("track added"),n.observer.trackAdded(),n.emit("addTrack",e)}):(this.logger.warn("Using onaddstream which is deprecated"),this.peerConnection.onaddstream=function(e){n.logger.log("stream added"),n.emit("addStream",e)}),this.peerConnection.onicecandidate=function(e){n.emit("iceCandidate",e),e.candidate?n.logger.log("ICE candidate received: "+(null===e.candidate.candidate?null:e.candidate.candidate.trim())):null===e.candidate&&(n.logger.log("ICE candidate gathering complete"),n.triggerIceGatheringComplete())},this.peerConnection.onicegatheringstatechange=function(){switch(n.logger.log("RTCIceGatheringState changed: "+this.iceGatheringState),this.iceGatheringState){case"gathering":n.emit("iceGathering",this),!n.iceGatheringTimer&&t.iceCheckingTimeout&&(n.iceGatheringTimeout=!1,n.iceGatheringTimer=e.Timers.setTimeout(function(){n.logger.log("RTCIceChecking Timeout Triggered after "+t.iceCheckingTimeout+" milliseconds"),n.iceGatheringTimeout=!0,n.triggerIceGatheringComplete()},t.iceCheckingTimeout));break;case"complete":n.triggerIceGatheringComplete()}},this.peerConnection.oniceconnectionstatechange=function(){var e;switch(this.iceConnectionState){case"new":e="iceConnection";break;case"checking":e="iceConnectionChecking";break;case"connected":e="iceConnectionConnected";break;case"completed":e="iceConnectionCompleted";break;case"failed":e="iceConnectionFailed";break;case"disconnected":e="iceConnectionDisconnected";break;case"closed":e="iceConnectionClosed";break;default:return void n.logger.warn("Unknown iceConnection state:",this.iceConnectionState)}n.emit(e,this)}}},acquire:{writable:!0,value:function(t){var n=this;return t=this.checkAndDefaultConstraints(t),new e.Utils.Promise(function(e,n){this.logger.log("acquiring local media"),this.emit("userMediaRequest",t),t.audio||t.video?this.WebRTC.getUserMedia(t).then(function(t){this.observer.trackAdded(),this.emit("userMedia",t),e(t)}.bind(this)).catch(function(e){this.emit("userMediaFailed",e),n(e)}.bind(this)):e([])}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"unable to acquire streams");throw n.logger.error(i.message),n.logger.error(i.error),i}).then(function(t){this.logger.log("acquired local media streams");try{return this.peerConnection.removeTrack&&this.peerConnection.getSenders().forEach(function(e){this.peerConnection.removeTrack(e)},this),t}catch(t){return e.Utils.Promise.reject(t)}}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error removing streams");throw n.logger.error(i.message),n.logger.error(i.error),i}).then(function(t){try{(t=[].concat(t)).forEach(function(e){this.peerConnection.addTrack?e.getTracks().forEach(function(t){this.peerConnection.addTrack(t,e)},this):this.peerConnection.addStream(e)},this)}catch(t){return e.Utils.Promise.reject(t)}return e.Utils.Promise.resolve()}.bind(this)).catch(function(t){if(t instanceof e.Exceptions.SessionDescriptionHandlerError)throw t;var i=new e.Exceptions.SessionDescriptionHandlerError("acquire",t,"error adding stream");throw n.logger.error(i.message),n.logger.error(i.error),i})}},hasOffer:{writable:!0,value:function(e){var t="have-"+e+"-offer";return this.peerConnection.signalingState===t}},isIceGatheringComplete:{writable:!0,value:function(){return"complete"===this.peerConnection.iceGatheringState||this.iceGatheringTimeout}},resetIceGatheringComplete:{writable:!0,value:function(){this.iceGatheringTimeout=!1,this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.reject(),this.iceGatheringDeferred=null)}},setDirection:{writable:!0,value:function(e){var t=e.match(/a=(sendrecv|sendonly|recvonly|inactive)/);if(null===t)return this.direction=this.C.DIRECTION.NULL,void this.observer.directionChanged();var n=t[1];switch(n){case this.C.DIRECTION.SENDRECV:case this.C.DIRECTION.SENDONLY:case this.C.DIRECTION.RECVONLY:case this.C.DIRECTION.INACTIVE:this.direction=n;break;default:this.direction=this.C.DIRECTION.NULL}this.observer.directionChanged()}},triggerIceGatheringComplete:{writable:!0,value:function(){this.isIceGatheringComplete()&&(this.emit("iceGatheringComplete",this),this.iceGatheringTimer&&(e.Timers.clearTimeout(this.iceGatheringTimer),this.iceGatheringTimer=null),this.iceGatheringDeferred&&(this.iceGatheringDeferred.resolve(),this.iceGatheringDeferred=null))}},waitForIceGatheringComplete:{writable:!0,value:function(){return this.isIceGatheringComplete()?e.Utils.Promise.resolve():(this.isIceGatheringDeferred||(this.iceGatheringDeferred=e.Utils.defer()),this.iceGatheringDeferred.promise)}}}),i}}).call(this,n(28))},function(e,t,n){"use strict";var i=function(e,t){this.session=e||{},this.options=t||{}};i.prototype={trackAdded:function(){this.session.emit("trackAdded")},directionChanged:function(){this.session.emit("directionChanged")}},e.exports=i},function(e,t,n){"use strict";e.exports=function(e){var t,n=[],i=[],r=[];function s(t,n,i){for(var r,s=e.Utils.buildStatusLine(t),o=n.getHeaders("via"),a=o.length,c=0;c<a;c++)s+="Via: "+o[c]+"\r\n";r=n.getHeader("To"),n.to_tag||(r+=";tag="+e.Utils.newTag()),s+="To: "+r+"\r\n",s+="From: "+n.getHeader("From")+"\r\n",s+="Call-ID: "+n.call_id+"\r\n",s+="CSeq: "+n.cseq+" "+n.method+"\r\n",s+="\r\n",i.send(s)}n.push(function(e,t,n){if(!e.ruri||"sip"!==e.ruri.scheme)return s(416,e,n),!1}),n.push(function(e,t,n){if(!e.to_tag&&e.call_id.substr(0,5)===t.configuration.sipjsId)return s(482,e,n),!1}),n.push(function(t,n,i){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return s(400,t,i),!1}),n.push(function(t,n,i){var r,o,a=t.from_tag,c=t.call_id,u=t.cseq;if(!t.to_tag)if(t.method===e.C.INVITE){if(r=n.transactions.ist[t.via_branch])return;for(o in n.transactions.ist)if((r=n.transactions.ist[o]).request.from_tag===a&&r.request.call_id===c&&r.request.cseq===u)return s(482,t,i),!1}else{if(r=n.transactions.nist[t.via_branch])return;for(o in n.transactions.nist)if((r=n.transactions.nist[o]).request.from_tag===a&&r.request.call_id===c&&r.request.cseq===u)return s(482,t,i),!1}}),i.push(function(e,t){if(e.getHeaders("via").length>1)return t.getLogger("sip.sanitycheck").warn("More than one Via header field present in the response. Dropping the response"),!1}),i.push(function(e,t){var n=t.configuration.viaHost;if(e.via.host!==n||void 0!==e.via.port)return t.getLogger("sip.sanitycheck").warn("Via sent-by in the response does not match UA Via host value. Dropping the response"),!1}),i.push(function(t,n){if(e.Utils.str_utf8_length(t.body)<t.getHeader("content-length"))return n.getLogger("sip.sanitycheck").warn("Message body length is lower than the value in Content-Length header field. Dropping the response"),!1}),r.push(function(e,t){for(var n=["from","to","call_id","cseq","via"],i=n.length;i--;)if(!e.hasHeader(n[i]))return t.getLogger("sip.sanitycheck").warn("Missing mandatory header field : "+n[i]+". Dropping the response"),!1}),t=function(t,s,o){var a;for(a=r.length;a--;)if(!1===r[a](t,s,o))return!1;if(t instanceof e.IncomingRequest){for(a=n.length;a--;)if(!1===n[a](t,s,o))return!1}else if(t instanceof e.IncomingResponse)for(a=i.length;a--;)if(!1===i[a](t,s,o))return!1;return!0},e.sanityCheck=t}},function(e,t,n){"use strict";var i=n(34);e.exports=function(e){var t;return(t=function(e){this.logger=e.getLogger("sipjs.digestauthentication"),this.username=e.configuration.authorizationUser,this.password=e.configuration.password,this.cnonce=null,this.nc=0,this.ncHex="00000000",this.response=null}).prototype.authenticate=function(t,n){if(this.algorithm=n.algorithm,this.realm=n.realm,this.nonce=n.nonce,this.opaque=n.opaque,this.stale=n.stale,this.algorithm){if("MD5"!==this.algorithm)return this.logger.warn('challenge with Digest algorithm different than "MD5", authentication aborted'),!1}else this.algorithm="MD5";if(!this.realm)return this.logger.warn("challenge without Digest realm, authentication aborted"),!1;if(!this.nonce)return this.logger.warn("challenge without Digest nonce, authentication aborted"),!1;if(n.qop)if(n.qop.indexOf("auth")>-1)this.qop="auth";else{if(!(n.qop.indexOf("auth-int")>-1))return this.logger.warn('challenge without Digest qop different than "auth" or "auth-int", authentication aborted'),!1;this.qop="auth-int"}else this.qop=null;return this.method=t.method,this.uri=t.ruri,this.cnonce=e.createRandomToken(12),this.nc+=1,this.updateNcHex(),4294967296===this.nc&&(this.nc=1,this.ncHex="00000001"),this.calculateResponse(),!0},t.prototype.calculateResponse=function(){var e,t;e=i(this.username+":"+this.realm+":"+this.password),"auth"===this.qop?(t=i(this.method+":"+this.uri),this.response=i(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth:"+t)):"auth-int"===this.qop?(t=i(this.method+":"+this.uri+":"+i(this.body?this.body:"")),this.response=i(e+":"+this.nonce+":"+this.ncHex+":"+this.cnonce+":auth-int:"+t)):null===this.qop&&(t=i(this.method+":"+this.uri),this.response=i(e+":"+this.nonce+":"+t))},t.prototype.toString=function(){var e=[];if(!this.response)throw new Error("response field does not exist, cannot generate Authorization header");return e.push("algorithm="+this.algorithm),e.push('username="'+this.username+'"'),e.push('realm="'+this.realm+'"'),e.push('nonce="'+this.nonce+'"'),e.push('uri="'+this.uri+'"'),e.push('response="'+this.response+'"'),this.opaque&&e.push('opaque="'+this.opaque+'"'),this.qop&&(e.push("qop="+this.qop),e.push('cnonce="'+this.cnonce+'"'),e.push("nc="+this.ncHex)),"Digest "+e.join(", ")},t.prototype.updateNcHex=function(){var e=Number(this.nc).toString(16);this.ncHex="00000000".substr(0,8-e.length)+e},t}},function(e,t,n){var i;e.exports=(i=n(35),function(e){var t=i,n=t.lib,r=n.WordArray,s=n.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0}();var c=o.MD5=s.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,t){for(var n=0;n<16;n++){var i=t+n,r=e[i];e[i]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var s=this._hash.words,o=e[t+0],c=e[t+1],p=e[t+2],f=e[t+3],m=e[t+4],g=e[t+5],v=e[t+6],T=e[t+7],y=e[t+8],S=e[t+9],b=e[t+10],C=e[t+11],E=e[t+12],_=e[t+13],R=e[t+14],w=e[t+15],A=s[0],I=s[1],k=s[2],D=s[3];A=u(A,I,k,D,o,7,a[0]),D=u(D,A,I,k,c,12,a[1]),k=u(k,D,A,I,p,17,a[2]),I=u(I,k,D,A,f,22,a[3]),A=u(A,I,k,D,m,7,a[4]),D=u(D,A,I,k,g,12,a[5]),k=u(k,D,A,I,v,17,a[6]),I=u(I,k,D,A,T,22,a[7]),A=u(A,I,k,D,y,7,a[8]),D=u(D,A,I,k,S,12,a[9]),k=u(k,D,A,I,b,17,a[10]),I=u(I,k,D,A,C,22,a[11]),A=u(A,I,k,D,E,7,a[12]),D=u(D,A,I,k,_,12,a[13]),k=u(k,D,A,I,R,17,a[14]),A=h(A,I=u(I,k,D,A,w,22,a[15]),k,D,c,5,a[16]),D=h(D,A,I,k,v,9,a[17]),k=h(k,D,A,I,C,14,a[18]),I=h(I,k,D,A,o,20,a[19]),A=h(A,I,k,D,g,5,a[20]),D=h(D,A,I,k,b,9,a[21]),k=h(k,D,A,I,w,14,a[22]),I=h(I,k,D,A,m,20,a[23]),A=h(A,I,k,D,S,5,a[24]),D=h(D,A,I,k,R,9,a[25]),k=h(k,D,A,I,f,14,a[26]),I=h(I,k,D,A,y,20,a[27]),A=h(A,I,k,D,_,5,a[28]),D=h(D,A,I,k,p,9,a[29]),k=h(k,D,A,I,T,14,a[30]),A=d(A,I=h(I,k,D,A,E,20,a[31]),k,D,g,4,a[32]),D=d(D,A,I,k,y,11,a[33]),k=d(k,D,A,I,C,16,a[34]),I=d(I,k,D,A,R,23,a[35]),A=d(A,I,k,D,c,4,a[36]),D=d(D,A,I,k,m,11,a[37]),k=d(k,D,A,I,T,16,a[38]),I=d(I,k,D,A,b,23,a[39]),A=d(A,I,k,D,_,4,a[40]),D=d(D,A,I,k,o,11,a[41]),k=d(k,D,A,I,f,16,a[42]),I=d(I,k,D,A,v,23,a[43]),A=d(A,I,k,D,S,4,a[44]),D=d(D,A,I,k,E,11,a[45]),k=d(k,D,A,I,w,16,a[46]),A=l(A,I=d(I,k,D,A,p,23,a[47]),k,D,o,6,a[48]),D=l(D,A,I,k,T,10,a[49]),k=l(k,D,A,I,R,15,a[50]),I=l(I,k,D,A,g,21,a[51]),A=l(A,I,k,D,E,6,a[52]),D=l(D,A,I,k,f,10,a[53]),k=l(k,D,A,I,b,15,a[54]),I=l(I,k,D,A,c,21,a[55]),A=l(A,I,k,D,y,6,a[56]),D=l(D,A,I,k,w,10,a[57]),k=l(k,D,A,I,v,15,a[58]),I=l(I,k,D,A,_,21,a[59]),A=l(A,I,k,D,m,6,a[60]),D=l(D,A,I,k,C,10,a[61]),k=l(k,D,A,I,p,15,a[62]),I=l(I,k,D,A,S,21,a[63]),s[0]=s[0]+A|0,s[1]=s[1]+I|0,s[2]=s[2]+k|0,s[3]=s[3]+D|0},_doFinalize:function(){var t=this._data,n=t.words,i=8*this._nDataBytes,r=8*t.sigBytes;n[r>>>5]|=128<<24-r%32;var s=e.floor(i/4294967296),o=i;n[15+(r+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),n[14+(r+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(n.length+1),this._process();for(var a=this._hash,c=a.words,u=0;u<4;u++){var h=c[u];c[u]=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8)}return a},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,n,i,r,s,o){var a=e+(t&n|~t&i)+r+o;return(a<<s|a>>>32-s)+t}function h(e,t,n,i,r,s,o){var a=e+(t&i|n&~i)+r+o;return(a<<s|a>>>32-s)+t}function d(e,t,n,i,r,s,o){var a=e+(t^n^i)+r+o;return(a<<s|a>>>32-s)+t}function l(e,t,n,i,r,s,o){var a=e+(n^(t|~i))+r+o;return(a<<s|a>>>32-s)+t}t.MD5=s._createHelper(c),t.HmacMD5=s._createHmacHelper(c)}(Math),i.MD5)},function(e,t,n){var i;e.exports=i=i||function(e,t){var n=Object.create||function(){function e(){}return function(t){var n;return e.prototype=t,n=new e,e.prototype=null,n}}(),i={},r=i.lib={},s=r.Base={extend:function(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},o=r.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,i=this.sigBytes,r=e.sigBytes;if(this.clamp(),i%4)for(var s=0;s<r;s++){var o=n[s>>>2]>>>24-s%4*8&255;t[i+s>>>2]|=o<<24-(i+s)%4*8}else for(s=0;s<r;s+=4)t[i+s>>>2]=n[s>>>2];return this.sigBytes+=r,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n,i=[],r=function(t){t=t;var n=987654321,i=4294967295;return function(){var r=((n=36969*(65535&n)+(n>>16)&i)<<16)+(t=18e3*(65535&t)+(t>>16)&i)&i;return r/=4294967296,(r+=.5)*(e.random()>.5?1:-1)}},s=0;s<t;s+=4){var a=r(4294967296*(n||e.random()));n=987654071*a(),i.push(4294967296*a()|0)}return new o.init(i,t)}}),a=i.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,i=[],r=0;r<n;r++){var s=t[r>>>2]>>>24-r%4*8&255;i.push((s>>>4).toString(16)),i.push((15&s).toString(16))}return i.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i+=2)n[i>>>3]|=parseInt(e.substr(i,2),16)<<24-i%8*4;return new o.init(n,t/2)}},u=a.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,i=[],r=0;r<n;r++){var s=t[r>>>2]>>>24-r%4*8&255;i.push(String.fromCharCode(s))}return i.join("")},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>2]|=(255&e.charCodeAt(i))<<24-i%4*8;return new o.init(n,t)}},h=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(u.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return u.parse(unescape(encodeURIComponent(e)))}},d=r.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=h.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,i=n.words,r=n.sigBytes,s=this.blockSize,a=r/(4*s),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,u=e.min(4*c,r);if(c){for(var h=0;h<c;h+=s)this._doProcessBlock(i,h);var d=i.splice(0,c);n.sigBytes-=u}return new o.init(d,u)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),l=(r.Hasher=d.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){d.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new l.HMAC.init(e,n).finalize(t)}}}),i.algo={});return i}(Math)},function(e,t,n){"use strict";var i=n(37);e.exports=function(e){return{parse:function(t,n){var r={startRule:n,SIP:e};try{i.parse(t,r)}catch(e){r.data=-1}return r.data}}}},function(e,t,n){"use strict";function i(e,t,n,r){this.message=e,this.expected=t,this.found=n,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,i)}!function(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}(i,Error),i.buildMessage=function(e,t){var n={literal:function(e){return'"'+r(e.text)+'"'},class:function(e){var t,n="";for(t=0;t<e.parts.length;t++)n+=e.parts[t]instanceof Array?s(e.parts[t][0])+"-"+s(e.parts[t][1]):s(e.parts[t]);return"["+(e.inverted?"^":"")+n+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function i(e){return e.charCodeAt(0).toString(16).toUpperCase()}function r(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}function s(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+i(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+i(e)})}return"Expected "+function(e){var t,i,r,s=new Array(e.length);for(t=0;t<e.length;t++)s[t]=(r=e[t],n[r.type](r));if(s.sort(),s.length>0){for(t=1,i=1;t<s.length;t++)s[t-1]!==s[t]&&(s[i]=s[t],i++);s.length=i}switch(s.length){case 1:return s[0];case 2:return s[0]+" or "+s[1];default:return s.slice(0,-1).join(", ")+", or "+s[s.length-1]}}(e)+" but "+function(e){return e?'"'+r(e)+'"':"end of input"}(t)+" found."},e.exports={SyntaxError:i,parse:function(e,t){t=void 0!==t?t:{};var n,r={},s={Contact:119,Name_Addr_Header:156,Record_Route:176,Request_Response:81,SIP_URI:45,Subscription_State:186,Supported:191,Require:182,Via:194,absoluteURI:84,Call_ID:118,Content_Disposition:130,Content_Length:135,Content_Type:136,CSeq:146,displayName:122,Event:149,From:151,host:52,Max_Forwards:154,Min_SE:213,Proxy_Authenticate:157,quoted_string:40,Refer_To:178,Replaces:179,Session_Expires:210,stun_URI:217,To:192,turn_URI:223,uuid:226,WWW_Authenticate:209,challenge:158,sipfrag:230,Referred_By:231},o=119,a=["\r\n",v("\r\n",!1),/^[0-9]/,T([["0","9"]],!1,!1),/^[a-zA-Z]/,T([["a","z"],["A","Z"]],!1,!1),/^[0-9a-fA-F]/,T([["0","9"],["a","f"],["A","F"]],!1,!1),/^[\0-\xFF]/,T([["\0","ÿ"]],!1,!1),/^["]/,T(['"'],!1,!1)," ",v(" ",!1),"\t",v("\t",!1),/^[a-zA-Z0-9]/,T([["a","z"],["A","Z"],["0","9"]],!1,!1),";",v(";",!1),"/",v("/",!1),"?",v("?",!1),":",v(":",!1),"@",v("@",!1),"&",v("&",!1),"=",v("=",!1),"+",v("+",!1),"$",v("$",!1),",",v(",",!1),"-",v("-",!1),"_",v("_",!1),".",v(".",!1),"!",v("!",!1),"~",v("~",!1),"*",v("*",!1),"'",v("'",!1),"(",v("(",!1),")",v(")",!1),"%",v("%",!1),function(){return" "},function(){return":"},/^[!-~]/,T([["!","~"]],!1,!1),/^[\x80-\uFFFF]/,T([["","￿"]],!1,!1),/^[\x80-\xBF]/,T([["","¿"]],!1,!1),/^[a-f]/,T([["a","f"]],!1,!1),"`",v("`",!1),"<",v("<",!1),">",v(">",!1),"\\",v("\\",!1),"[",v("[",!1),"]",v("]",!1),"{",v("{",!1),"}",v("}",!1),function(){return"*"},function(){return"/"},function(){return"="},function(){return"("},function(){return")"},function(){return">"},function(){return"<"},function(){return","},function(){return";"},function(){return":"},function(){return'"'},/^[!-']/,T([["!","'"]],!1,!1),/^[*-[]/,T([["*","["]],!1,!1),/^[\]-~]/,T([["]","~"]],!1,!1),function(e){return e},/^[#-[]/,T([["#","["]],!1,!1),/^[\0-\t]/,T([["\0","\t"]],!1,!1),/^[\x0B-\f]/,T([["\v","\f"]],!1,!1),/^[\x0E-\x7F]/,T([["",""]],!1,!1),function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port},function(){t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params,"SIP_URI"===t.startRule&&(t.data=t.data.uri)},"sips",v("sips",!0),"sip",v("sip",!0),function(e){t.data.scheme=e},function(){t.data.user=decodeURIComponent(m().slice(0,-1))},function(){t.data.password=m()},function(){return t.data.host=m(),t.data.host},function(){return t.data.host_type="domain",m()},/^[a-zA-Z0-9_\-]/,T([["a","z"],["A","Z"],["0","9"],"_","-"],!1,!1),/^[a-zA-Z0-9\-]/,T([["a","z"],["A","Z"],["0","9"],"-"],!1,!1),function(){return t.data.host_type="IPv6",m()},"::",v("::",!1),function(){return t.data.host_type="IPv6",m()},function(){return t.data.host_type="IPv4",m()},"25",v("25",!1),/^[0-5]/,T([["0","5"]],!1,!1),"2",v("2",!1),/^[0-4]/,T([["0","4"]],!1,!1),"1",v("1",!1),/^[1-9]/,T([["1","9"]],!1,!1),function(e){return e=parseInt(e.join("")),t.data.port=e,e},"transport=",v("transport=",!0),"udp",v("udp",!0),"tcp",v("tcp",!0),"sctp",v("sctp",!0),"tls",v("tls",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.transport=e.toLowerCase()},"user=",v("user=",!0),"phone",v("phone",!0),"ip",v("ip",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.user=e.toLowerCase()},"method=",v("method=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.method=e},"ttl=",v("ttl=",!0),function(e){t.data.params||(t.data.params={}),t.data.params.ttl=e},"maddr=",v("maddr=",!0),function(e){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.maddr=e},"lr",v("lr",!0),function(){t.data.uri_params||(t.data.uri_params={}),t.data.uri_params.lr=void 0},function(e,n){t.data.uri_params||(t.data.uri_params={}),n=null===n?void 0:n[1],t.data.uri_params[e.toLowerCase()]=n},function(e,n){e=e.join("").toLowerCase(),n=n.join(""),t.data.uri_headers||(t.data.uri_headers={}),t.data.uri_headers[e]?t.data.uri_headers[e].push(n):t.data.uri_headers[e]=[n]},function(){"Refer_To"===t.startRule&&(t.data.uri=new t.SIP.URI(t.data.scheme,t.data.user,t.data.host,t.data.port,t.data.uri_params,t.data.uri_headers),delete t.data.scheme,delete t.data.user,delete t.data.host,delete t.data.host_type,delete t.data.port,delete t.data.uri_params)},"//",v("//",!1),function(){t.data.scheme=m()},v("SIP",!0),function(){t.data.sip_version=m()},"INVITE",v("INVITE",!1),"ACK",v("ACK",!1),"VXACH",v("VXACH",!1),"OPTIONS",v("OPTIONS",!1),"BYE",v("BYE",!1),"CANCEL",v("CANCEL",!1),"REGISTER",v("REGISTER",!1),"SUBSCRIBE",v("SUBSCRIBE",!1),"NOTIFY",v("NOTIFY",!1),"REFER",v("REFER",!1),"PUBLISH",v("PUBLISH",!1),function(){return t.data.method=m(),t.data.method},function(e){t.data.status_code=parseInt(e.join(""))},function(){t.data.reason_phrase=m()},function(){t.data=m()},function(){var e,n;for(n=t.data.multi_header.length,e=0;e<n;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:u,offset:g().start.offset,parsed:e})},function(e){'"'===(e=m().trim())[0]&&(e=e.substring(1,e.length-1)),t.data.displayName=e},"q",v("q",!0),function(e){t.data.params||(t.data.params={}),t.data.params.q=e},"expires",v("expires",!0),function(e){t.data.params||(t.data.params={}),t.data.params.expires=e},function(e){return parseInt(e.join(""))},"0",v("0",!1),function(){return parseFloat(m())},function(e,n){t.data.params||(t.data.params={}),n=null===n?void 0:n[1],t.data.params[e.toLowerCase()]=n},"render",v("render",!0),"session",v("session",!0),"icon",v("icon",!0),"alert",v("alert",!0),function(){"Content_Disposition"===t.startRule&&(t.data.type=m().toLowerCase())},"handling",v("handling",!0),"optional",v("optional",!0),"required",v("required",!0),function(e){t.data=parseInt(e.join(""))},function(){t.data=m()},"text",v("text",!0),"image",v("image",!0),"audio",v("audio",!0),"video",v("video",!0),"application",v("application",!0),"message",v("message",!0),"multipart",v("multipart",!0),"x-",v("x-",!0),function(e){t.data.value=parseInt(e.join(""))},function(e){t.data=e},function(e){t.data.event=e.toLowerCase()},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"tag",v("tag",!0),function(e){t.data.tag=e},function(e){t.data=parseInt(e.join(""))},function(e){t.data=e},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},"digest",v("Digest",!0),"realm",v("realm",!0),function(e){t.data.realm=e},"domain",v("domain",!0),"nonce",v("nonce",!0),function(e){t.data.nonce=e},"opaque",v("opaque",!0),function(e){t.data.opaque=e},"stale",v("stale",!0),"true",v("true",!0),function(){t.data.stale=!0},"false",v("false",!0),function(){t.data.stale=!1},"algorithm",v("algorithm",!0),"md5",v("MD5",!0),"md5-sess",v("MD5-sess",!0),function(e){t.data.algorithm=e.toUpperCase()},"qop",v("qop",!0),"auth-int",v("auth-int",!0),"auth",v("auth",!0),function(e){t.data.qop||(t.data.qop=[]),t.data.qop.push(e.toLowerCase())},function(e){t.data.value=parseInt(e.join(""))},function(){var e,n;for(n=t.data.multi_header.length,e=0;e<n;e++)if(null===t.data.multi_header[e].parsed){t.data=null;break}null!==t.data?t.data=t.data.multi_header:t.data=-1},function(){var e;t.data.multi_header||(t.data.multi_header=[]);try{e=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),delete t.data.uri,delete t.data.displayName,delete t.data.params}catch(t){e=null}t.data.multi_header.push({position:u,offset:g().start.offset,parsed:e})},function(){t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params)},function(){t.data.replaces_from_tag&&t.data.replaces_to_tag||(t.data=-1)},function(){t.data={call_id:t.data}},"from-tag",v("from-tag",!0),function(e){t.data.replaces_from_tag=e},"to-tag",v("to-tag",!0),function(e){t.data.replaces_to_tag=e},"early-only",v("early-only",!0),function(){t.data.early_only=!0},function(e,t){return t},function(e,t){return function(e,t){return[e].concat(t)}(e,t)},function(e){"Require"===t.startRule&&(t.data=e||[])},function(e){t.data.value=parseInt(e.join(""))},"active",v("active",!0),"pending",v("pending",!0),"terminated",v("terminated",!0),function(){t.data.state=m()},"reason",v("reason",!0),function(e){void 0!==e&&(t.data.reason=e)},function(e){void 0!==e&&(t.data.expires=e)},"retry_after",v("retry_after",!0),function(e){void 0!==e&&(t.data.retry_after=e)},"deactivated",v("deactivated",!0),"probation",v("probation",!0),"rejected",v("rejected",!0),"timeout",v("timeout",!0),"giveup",v("giveup",!0),"noresource",v("noresource",!0),"invariant",v("invariant",!0),function(e){"Supported"===t.startRule&&(t.data=e||[])},function(){var e=t.data.tag;t.data=new t.SIP.NameAddrHeader(t.data.uri,t.data.displayName,t.data.params),e&&t.data.setParam("tag",e)},"ttl",v("ttl",!0),function(e){t.data.ttl=e},"maddr",v("maddr",!0),function(e){t.data.maddr=e},"received",v("received",!0),function(e){t.data.received=e},"branch",v("branch",!0),function(e){t.data.branch=e},"rport",v("rport",!0),function(){"undefined"!=typeof response_port&&(t.data.rport=response_port.join(""))},function(e){t.data.protocol=e},v("UDP",!0),v("TCP",!0),v("TLS",!0),v("SCTP",!0),function(e){t.data.transport=e},function(){t.data.host=m()},function(e){t.data.port=parseInt(e.join(""))},function(e){return parseInt(e.join(""))},function(e){"Session_Expires"===t.startRule&&(t.data.deltaSeconds=e)},"refresher",v("refresher",!1),"uas",v("uas",!1),"uac",v("uac",!1),function(e){"Session_Expires"===t.startRule&&(t.data.refresher=e)},function(e){"Min_SE"===t.startRule&&(t.data=e)},"stuns",v("stuns",!0),"stun",v("stun",!0),function(e){t.data.scheme=e},function(e){t.data.host=e},"?transport=",v("?transport=",!1),"turns",v("turns",!0),"turn",v("turn",!0),function(){t.data.transport=transport},function(){t.data=m()},"Referred-By",v("Referred-By",!1),"b",v("b",!1),"cid",v("cid",!1)],c=[E('2 ""6 7!'),E('4"""5!7#'),E('4$""5!7%'),E('4&""5!7\''),E(";'.# &;("),E('4(""5!7)'),E('4*""5!7+'),E('2,""6,7-'),E('2.""6.7/'),E('40""5!71'),E('22""6273. &24""6475.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),E(";).# &;,"),E('2F""6F7G.} &2H""6H7I.q &2J""6J7K.e &2L""6L7M.Y &2N""6N7O.M &2P""6P7Q.A &2R""6R7S.5 &2T""6T7U.) &2V""6V7W'),E('%%2X""6X7Y/5#;#/,$;#/#$+#)(#\'#("\'#&\'#/"!&,)'),E('%%$;$0#*;$&/,#; /#$+")("\'#&\'#." &"/=#$;$/&#0#*;$&&&#/\'$8":Z" )("\'#&\'#'),E(';.." &"'),E("%$;'.# &;(0)*;'.# &;(&/?#28\"\"6879/0$;//'$8#:[# )(#'#(\"'#&'#"),E('%%$;2/&#0#*;2&&&#/g#$%$;.0#*;.&/,#;2/#$+")("\'#&\'#0=*%$;.0#*;.&/,#;2/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),E('4\\""5!7].# &;3'),E('4^""5!7_'),E('4`""5!7a'),E(';!.) &4b""5!7c'),E('%$;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G. &2J""6J7K.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),E('%$;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O/#0*;). &2F""6F7G.} &2L""6L7M.q &2X""6X7Y.e &2P""6P7Q.Y &2H""6H7I.M &2@""6@7A.A &2d""6d7e.5 &2R""6R7S.) &2N""6N7O&&&#/"!&,)'),E('2T""6T7U.ã &2V""6V7W.× &2f""6f7g.Ë &2h""6h7i.¿ &2:""6:7;.³ &2D""6D7E.§ &22""6273. &28""6879. &2j""6j7k. &;&.} &24""6475.q &2l""6l7m.e &2n""6n7o.Y &26""6677.M &2>""6>7?.A &2p""6p7q.5 &2r""6r7s.) &;\'.# &;('),E('%$;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s/Ĵ#0ı*;).ī &2F""6F7G.ğ &2J""6J7K.ē &2L""6L7M.ć &2X""6X7Y.û &2P""6P7Q.ï &2H""6H7I.ã &2@""6@7A.× &2d""6d7e.Ë &2R""6R7S.¿ &2N""6N7O.³ &2T""6T7U.§ &2V""6V7W. &2f""6f7g. &2h""6h7i. &28""6879.w &2j""6j7k.k &;&.e &24""6475.Y &2l""6l7m.M &2n""6n7o.A &26""6677.5 &2p""6p7q.) &2r""6r7s&&&#/"!&,)'),E("%;//?#2P\"\"6P7Q/0$;//'$8#:t# )(#'#(\"'#&'#"),E("%;//?#24\"\"6475/0$;//'$8#:u# )(#'#(\"'#&'#"),E("%;//?#2>\"\"6>7?/0$;//'$8#:v# )(#'#(\"'#&'#"),E("%;//?#2T\"\"6T7U/0$;//'$8#:w# )(#'#(\"'#&'#"),E("%;//?#2V\"\"6V7W/0$;//'$8#:x# )(#'#(\"'#&'#"),E('%2h""6h7i/0#;//\'$8":y" )("\'#&\'#'),E('%;//6#2f""6f7g/\'$8":z" )("\'#&\'#'),E("%;//?#2D\"\"6D7E/0$;//'$8#:{# )(#'#(\"'#&'#"),E("%;//?#22\"\"6273/0$;//'$8#:|# )(#'#(\"'#&'#"),E("%;//?#28\"\"6879/0$;//'$8#:}# )(#'#(\"'#&'#"),E("%;//0#;&/'$8\":~\" )(\"'#&'#"),E("%;&/0#;//'$8\":~\" )(\"'#&'#"),E("%;=/T#$;G.) &;K.# &;F0/*;G.) &;K.# &;F&/,$;>/#$+#)(#'#(\"'#&'#"),E('4""5!7.A &4""5!7.5 &4""5!7.) &;3.# &;.'),E("%%;//Q#;&/H$$;J.# &;K0)*;J.# &;K&/,$;&/#$+$)($'#(#'#(\"'#&'#/\"!&,)"),E("%;//]#;&/T$%$;J.# &;K0)*;J.# &;K&/\"!&,)/1$;&/($8$:$!!)($'#(#'#(\"'#&'#"),E(';..G &2L""6L7M.; &4""5!7./ &4""5!7.# &;3'),E('%2j""6j7k/J#4""5!7.5 &4""5!7.) &4""5!7/#$+")("\'#&\'#'),E("%;N/M#28\"\"6879/>$;O.\" &\"/0$;S/'$8$:$ )($'#(#'#(\"'#&'#"),E("%;N/d#28\"\"6879/U$;O.\" &\"/G$;S/>$;_/5$;l.\" &\"/'$8&:& )(&'#(%'#($'#(#'#(\"'#&'#"),E('%3""5$7.) &3""5#7/\' 8!:!! )'),E('%;P/]#%28""6879/,#;R/#$+")("\'#&\'#." &"/6$2:""6:7;/\'$8#:# )(#\'#("\'#&\'#'),E("$;+.) &;-.# &;Q/2#0/*;+.) &;-.# &;Q&&&#"),E('2<""6<7=.q &2>""6>7?.e &2@""6@7A.Y &2B""6B7C.M &2D""6D7E.A &22""6273.5 &26""6677.) &24""6475'),E('%$;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E0e*;+._ &;-.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E&/& 8!:! )'),E('%;T/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),E("%;U.) &;\\.# &;X/& 8!:! )"),E('%$%;V/2#2J""6J7K/#$+")("\'#&\'#0<*%;V/2#2J""6J7K/#$+")("\'#&\'#&/D#;W/;$2J""6J7K." &"/\'$8#:# )(#\'#("\'#&\'#'),E('$4""5!7/,#0)*4""5!7&&&#'),E('%4$""5!7%/?#$4""5!70)*4""5!7&/#$+")("\'#&\'#'),E('%2l""6l7m/?#;Y/6$2n""6n7o/\'$8#:# )(#\'#("\'#&\'#'),E('%%;Z/³#28""6879/¤$;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+-)(-\'#(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ސ &%2""67/¤#;Z/$28""6879/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+,)(,\'#(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.۹ &%2""67/#;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ٺ &%2""67/t#;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ؓ &%2""67/\\#;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+&)(&\'#(%\'#($\'#(#\'#("\'#&\'#.ׄ &%2""67/D#;Z/;$28""6879/,$;[/#$+$)($\'#(#\'#("\'#&\'#.֍ &%2""67/,#;[/#$+")("\'#&\'#.ծ &%2""67/,#;Z/#$+")("\'#&\'#.Տ &%;Z/#2""67/$;Z/$28""6879/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$++)(+\'#(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ӈ &%;Z/ª#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$2""67/t$;Z/k$28""6879/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+*)(*\'#()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.а &%;Z/¹#%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/k$2""67/\\$;Z/S$28""6879/D$;Z/;$28""6879/,$;[/#$+))()\'#((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ί &%;Z/È#%28""6879/,#;Z/#$+")("\'#&\'#." &"/¡$%28""6879/,#;Z/#$+")("\'#&\'#." &"/z$%28""6879/,#;Z/#$+")("\'#&\'#." &"/S$2""67/D$;Z/;$28""6879/,$;[/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.˕ &%;Z/×#%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;[/#$+\')(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.ȑ &%;Z/þ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/×$%28""6879/,#;Z/#$+")("\'#&\'#." &"/°$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/b$%28""6879/,#;Z/#$+")("\'#&\'#." &"/;$2""67/,$;Z/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#.Ħ &%;Z/Ĝ#%28""6879/,#;Z/#$+")("\'#&\'#." &"/õ$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Î$%28""6879/,#;Z/#$+")("\'#&\'#." &"/§$%28""6879/,#;Z/#$+")("\'#&\'#." &"/$%28""6879/,#;Z/#$+")("\'#&\'#." &"/Y$%28""6879/,#;Z/#$+")("\'#&\'#." &"/2$2""67/#$+()((\'#(\'\'#(&\'#(%\'#($\'#(#\'#("\'#&\'#/& 8!: ! )'),E('%;#/M#;#." &"/?$;#." &"/1$;#." &"/#$+$)($\'#(#\'#("\'#&\'#'),E("%;Z/;#28\"\"6879/,$;Z/#$+#)(#'#(\"'#&'#.# &;\\"),E("%;]/o#2J\"\"6J7K/`$;]/W$2J\"\"6J7K/H$;]/?$2J\"\"6J7K/0$;]/'$8':¡' )(''#(&'#(%'#($'#(#'#(\"'#&'#"),E('%2¢""6¢7£/2#4¤""5!7¥/#$+")("\'#&\'#. &%2¦""6¦7§/;#4¨""5!7©/,$;!/#$+#)(#\'#("\'#&\'#.j &%2ª""6ª7«/5#;!/,$;!/#$+#)(#\'#("\'#&\'#.B &%4¬""5!7­/,#;!/#$+")("\'#&\'#.# &;!'),E('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:®!! )'),E('$%22""6273/,#;`/#$+")("\'#&\'#0<*%22""6273/,#;`/#$+")("\'#&\'#&'),E(";a.A &;b.; &;c.5 &;d./ &;e.) &;f.# &;g"),E('%3¯""5*7°/a#3±""5#7².G &3³""5#7´.; &3µ""5$7¶./ &3·""5#7¸.# &;6/($8":¹"! )("\'#&\'#'),E('%3º""5%7»/I#3¼""5%7½./ &3¾""5"7¿.# &;6/($8":À"! )("\'#&\'#'),E('%3Á""5\'7Â/1#;/($8":Ã"! )("\'#&\'#'),E('%3Ä""5$7Å/1#;ð/($8":Æ"! )("\'#&\'#'),E('%3Ç""5&7È/1#;T/($8":É"! )("\'#&\'#'),E('%3Ê""5"7Ë/N#%2>""6>7?/,#;6/#$+")("\'#&\'#." &"/\'$8":Ì" )("\'#&\'#'),E('%;h/P#%2>""6>7?/,#;i/#$+")("\'#&\'#." &"/)$8":Í""! )("\'#&\'#'),E('%$;j/&#0#*;j&&&#/"!&,)'),E('%$;j/&#0#*;j&&&#/"!&,)'),E(";k.) &;+.# &;-"),E('2l""6l7m.e &2n""6n7o.Y &24""6475.M &28""6879.A &2<""6<7=.5 &2@""6@7A.) &2B""6B7C'),E('%26""6677/n#;m/e$$%2<""6<7=/,#;m/#$+")("\'#&\'#0<*%2<""6<7=/,#;m/#$+")("\'#&\'#&/#$+#)(#\'#("\'#&\'#'),E('%;n/A#2>""6>7?/2$;o/)$8#:Î#"" )(#\'#("\'#&\'#'),E("$;p.) &;+.# &;-/2#0/*;p.) &;+.# &;-&&&#"),E("$;p.) &;+.# &;-0/*;p.) &;+.# &;-&"),E('2l""6l7m.e &2n""6n7o.Y &24""6475.M &26""6677.A &28""6879.5 &2@""6@7A.) &2B""6B7C'),E(";.# &;r"),E("%;/G#;'/>$;s/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),E(";M.# &;t"),E("%;/E#28\"\"6879/6$;u.# &;x/'$8#:Ï# )(#'#(\"'#&'#"),E('%;v.# &;w/J#%26""6677/,#;/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),E('%2Ð""6Ð7Ñ/:#;/1$;w." &"/#$+#)(#\'#("\'#&\'#'),E('%24""6475/,#;{/#$+")("\'#&\'#'),E("%;z/3#$;y0#*;y&/#$+\")(\"'#&'#"),E(";*.) &;+.# &;-"),E(';+. &;-. &22""6273.} &26""6677.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),E('%;|/e#$%24""6475/,#;|/#$+")("\'#&\'#0<*%24""6475/,#;|/#$+")("\'#&\'#&/#$+")("\'#&\'#'),E('%$;~0#*;~&/e#$%22""6273/,#;}/#$+")("\'#&\'#0<*%22""6273/,#;}/#$+")("\'#&\'#&/#$+")("\'#&\'#'),E("$;~0#*;~&"),E(';+.w &;-.q &28""6879.e &2:""6:7;.Y &2<""6<7=.M &2>""6>7?.A &2@""6@7A.5 &2B""6B7C.) &2D""6D7E'),E('%%;"/#$;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K0M*;".G &;!.A &2@""6@7A.5 &2F""6F7G.) &2J""6J7K&/#$+")("\'#&\'#/& 8!:Ò! )'),E(";.# &;"),E('%%;O/2#2:""6:7;/#$+")("\'#&\'#." &"/,#;S/#$+")("\'#&\'#." &"'),E('$;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A/#0*;+. &;-.} &2B""6B7C.q &2D""6D7E.e &22""6273.Y &28""6879.M &2:""6:7;.A &2<""6<7=.5 &2>""6>7?.) &2@""6@7A&&&#'),E("$;y0#*;y&"),E('%3""5#7Ó/q#24""6475/b$$;!/&#0#*;!&&&#/L$2J""6J7K/=$$;!/&#0#*;!&&&#/\'$8%:Ô% )(%\'#($\'#(#\'#("\'#&\'#'),E('2Õ""6Õ7Ö'),E('2×""6×7Ø'),E('2Ù""6Ù7Ú'),E('2Û""6Û7Ü'),E('2Ý""6Ý7Þ'),E('2ß""6ß7à'),E('2á""6á7â'),E('2ã""6ã7ä'),E('2å""6å7æ'),E('2ç""6ç7è'),E('2é""6é7ê'),E("%;.Y &;.S &;.M &;.G &;.A &;.; &;.5 &;./ &;.) &;.# &;6/& 8!:ë! )"),E("%;/G#;'/>$;/5$;'/,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),E("%;/' 8!:ì!! )"),E("%;!/5#;!/,$;!/#$+#)(#'#(\"'#&'#"),E("%$;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(0G*;*.A &;+.; &;-.5 &;3./ &;4.) &;'.# &;(&/& 8!:í! )"),E("%;¶/Y#$%;A/,#;¶/#$+\")(\"'#&'#06*%;A/,#;¶/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E('%;9/N#%2:""6:7;/,#;9/#$+")("\'#&\'#." &"/\'$8":î" )("\'#&\'#'),E("%;:.c &%;/Y#$%;A/,#;/#$+\")(\"'#&'#06*%;A/,#;/#$+\")(\"'#&'#&/#$+\")(\"'#&'#/& 8!:ï! )"),E("%;L.# &;/]#$%;B/,#;/#$+\")(\"'#&'#06*%;B/,#;/#$+\")(\"'#&'#&/'$8\":ð\" )(\"'#&'#"),E("%;.\" &\"/>#;@/5$;M/,$;?/#$+$)($'#(#'#(\"'#&'#"),E("%%;6/Y#$%;./,#;6/#$+\")(\"'#&'#06*%;./,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#.# &;H/' 8!:ñ!! )"),E(";.) &;.# &; "),E("%3ò\"\"5!7ó/:#;</1$;/($8#:ô#! )(#'#(\"'#&'#"),E("%3õ\"\"5'7ö/:#;</1$;/($8#:÷#! )(#'#(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:ø!! )"),E('%2ù""6ù7ú/o#%2J""6J7K/M#;!." &"/?$;!." &"/1$;!." &"/#$+$)($\'#(#\'#("\'#&\'#." &"/\'$8":û" )("\'#&\'#'),E('%;6/J#%;</,#;¡/#$+")("\'#&\'#." &"/)$8":ü""! )("\'#&\'#'),E(";6.) &;T.# &;H"),E("%;£/Y#$%;B/,#;¤/#$+\")(\"'#&'#06*%;B/,#;¤/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E('%3ý""5&7þ.G &3ÿ""5\'7Ā.; &3ā""5$7Ă./ &3ă""5%7Ą.# &;6/& 8!:ą! )'),E(";¥.# &; "),E('%3Ć""5(7ć/M#;</D$3Ĉ""5(7ĉ./ &3Ċ""5(7ċ.# &;6/#$+#)(#\'#("\'#&\'#'),E("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:Č!! )"),E("%;©/& 8!:č! )"),E("%;ª/k#;;/b$;¯/Y$$%;B/,#;°/#$+\")(\"'#&'#06*%;B/,#;°/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),E(";«.# &;¬"),E('3Ď""5$7ď.S &3Đ""5%7đ.G &3Ē""5%7ē.; &3Ĕ""5%7ĕ./ &3Ė""5+7ė.# &;­'),E('3Ę""5\'7ę./ &3Ě""5)7ě.# &;­'),E(";6.# &;®"),E('%3Ĝ""5"7ĝ/,#;6/#$+")("\'#&\'#'),E(";­.# &;6"),E("%;6/5#;</,$;±/#$+#)(#'#(\"'#&'#"),E(";6.# &;H"),E("%;³/5#;./,$;/#$+#)(#'#(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:Ğ!! )"),E("%;/' 8!:ğ!! )"),E('%;¶/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ġ"!!)("\'#&\'#'),E('%%;7/e#$%2J""6J7K/,#;7/#$+")("\'#&\'#0<*%2J""6J7K/,#;7/#$+")("\'#&\'#&/#$+")("\'#&\'#/"!&,)'),E("%;L.# &;/]#$%;B/,#;¸/#$+\")(\"'#&'#06*%;B/,#;¸/#$+\")(\"'#&'#&/'$8\":ġ\" )(\"'#&'#"),E(";¹.# &; "),E("%3Ģ\"\"5#7ģ/:#;</1$;6/($8#:Ĥ#! )(#'#(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:ĥ!! )"),E("%;/' 8!:Ħ!! )"),E("%$;0#*;&/x#;@/o$;M/f$;?/]$$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8%:ħ% )(%'#($'#(#'#(\"'#&'#"),E(";¾"),E("%3Ĩ\"\"5&7ĩ/k#;./b$;Á/Y$$%;A/,#;Á/#$+\")(\"'#&'#06*%;A/,#;Á/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#.# &;¿"),E("%;6/k#;./b$;À/Y$$%;A/,#;À/#$+\")(\"'#&'#06*%;A/,#;À/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),E("%;6/;#;</2$;6.# &;H/#$+#)(#'#(\"'#&'#"),E(";Â.G &;Ä.A &;Æ.; &;È.5 &;É./ &;Ê.) &;Ë.# &;À"),E("%3Ī\"\"5%7ī/5#;</,$;Ã/#$+#)(#'#(\"'#&'#"),E("%;I/' 8!:Ĭ!! )"),E("%3ĭ\"\"5&7Į/#;</$;D/$;Å/|$$%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#0C*%$;'/&#0#*;'&&&#/,#;Å/#$+\")(\"'#&'#&/,$;E/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),E(";t.# &;w"),E("%3į\"\"5%7İ/5#;</,$;Ç/#$+#)(#'#(\"'#&'#"),E("%;I/' 8!:ı!! )"),E("%3Ĳ\"\"5&7ĳ/:#;</1$;I/($8#:Ĵ#! )(#'#(\"'#&'#"),E('%3ĵ""5%7Ķ/]#;</T$%3ķ""5$7ĸ/& 8!:Ĺ! ).4 &%3ĺ""5%7Ļ/& 8!:ļ! )/#$+#)(#\'#("\'#&\'#'),E('%3Ľ""5)7ľ/R#;</I$3Ŀ""5#7ŀ./ &3Ł""5(7ł.# &;6/($8#:Ń#! )(#\'#("\'#&\'#'),E('%3ń""5#7Ņ/#;</$;D/$%;Ì/e#$%2D""6D7E/,#;Ì/#$+")("\'#&\'#0<*%2D""6D7E/,#;Ì/#$+")("\'#&\'#&/#$+")("\'#&\'#/,$;E/#$+%)(%\'#($\'#(#\'#("\'#&\'#'),E('%3ņ""5(7Ň./ &3ň""5$7ŉ.# &;6/\' 8!:Ŋ!! )'),E("%;6/Y#$%;A/,#;6/#$+\")(\"'#&'#06*%;A/,#;6/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E("%;Ï/G#;./>$;Ï/5$;./,$;/#$+%)(%'#($'#(#'#(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:ŋ!! )"),E("%;Ñ/]#$%;A/,#;Ñ/#$+\")(\"'#&'#06*%;A/,#;Ñ/#$+\")(\"'#&'#&/'$8\":Ō\" )(\"'#&'#"),E("%;/]#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/'$8\":ō\" )(\"'#&'#"),E('%;L.O &;.I &%;@." &"/:#;t/1$;?." &"/#$+#)(#\'#("\'#&\'#/]#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/\'$8":Ŏ" )("\'#&\'#'),E("%;Ô/]#$%;B/,#;Õ/#$+\")(\"'#&'#06*%;B/,#;Õ/#$+\")(\"'#&'#&/'$8\":ŏ\" )(\"'#&'#"),E("%;/& 8!:Ő! )"),E('%3ő""5(7Œ/:#;</1$;6/($8#:œ#! )(#\'#("\'#&\'#.g &%3Ŕ""5&7ŕ/:#;</1$;6/($8#:Ŗ#! )(#\'#("\'#&\'#.: &%3ŗ""5*7Ř/& 8!:ř! ).# &; '),E('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:Ŝ!! )'),E("%;Ø/Y#$%;A/,#;Ø/#$+\")(\"'#&'#06*%;A/,#;Ø/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E("%;/Y#$%;B/,#; /#$+\")(\"'#&'#06*%;B/,#; /#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E("%$;!/&#0#*;!&&&#/' 8!:ŝ!! )"),E("%;Û/Y#$%;B/,#;Ü/#$+\")(\"'#&'#06*%;B/,#;Ü/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E('%3Ş""5&7ş.; &3Š""5\'7š./ &3Ţ""5*7ţ.# &;6/& 8!:Ť! )'),E("%3ť\"\"5&7Ŧ/:#;</1$;Ý/($8#:ŧ#! )(#'#(\"'#&'#.} &%3õ\"\"5'7ö/:#;</1$;/($8#:Ũ#! )(#'#(\"'#&'#.P &%3ũ\"\"5+7Ū/:#;</1$;/($8#:ū#! )(#'#(\"'#&'#.# &; "),E('3Ŭ""5+7ŭ.k &3Ů""5)7ů._ &3Ű""5(7ű.S &3Ų""5\'7ų.G &3Ŵ""5&7ŵ.; &3Ŷ""5*7ŷ./ &3Ÿ""5)7Ź.# &;6'),E(';1." &"'),E('%%;6/k#$%;A/2#;6/)$8":Ś""$ )("\'#&\'#0<*%;A/2#;6/)$8":Ś""$ )("\'#&\'#&/)$8":ś""! )("\'#&\'#." &"/\' 8!:ź!! )'),E("%;L.# &;/]#$%;B/,#;á/#$+\")(\"'#&'#06*%;B/,#;á/#$+\")(\"'#&'#&/'$8\":Ż\" )(\"'#&'#"),E(";¹.# &; "),E("%;ã/Y#$%;A/,#;ã/#$+\")(\"'#&'#06*%;A/,#;ã/#$+\")(\"'#&'#&/#$+\")(\"'#&'#"),E("%;ê/k#;./b$;í/Y$$%;B/,#;ä/#$+\")(\"'#&'#06*%;B/,#;ä/#$+\")(\"'#&'#&/#$+$)($'#(#'#(\"'#&'#"),E(";å.; &;æ.5 &;ç./ &;è.) &;é.# &; "),E("%3ż\"\"5#7Ž/:#;</1$;ð/($8#:ž#! )(#'#(\"'#&'#"),E("%3ſ\"\"5%7ƀ/:#;</1$;T/($8#:Ɓ#! )(#'#(\"'#&'#"),E("%3Ƃ\"\"5(7ƃ/F#;</=$;\\.) &;Y.# &;X/($8#:Ƅ#! )(#'#(\"'#&'#"),E("%3ƅ\"\"5&7Ɔ/:#;</1$;6/($8#:Ƈ#! )(#'#(\"'#&'#"),E('%3ƈ""5%7Ɖ/O#%;</3#$;!0#*;!&/#$+")("\'#&\'#." &"/\'$8":Ɗ" )("\'#&\'#'),E("%;ë/G#;;/>$;6/5$;;/,$;ì/#$+%)(%'#($'#(#'#(\"'#&'#"),E('%3""5#7Ó.# &;6/\' 8!:Ƌ!! )'),E('%3±""5#7ƌ.G &3³""5#7ƍ.; &3·""5#7Ǝ./ &3µ""5$7Ə.# &;6/\' 8!:Ɛ!! )'),E('%;î/D#%;C/,#;ï/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),E("%;U.) &;\\.# &;X/& 8!:Ƒ! )"),E('%%;!." &"/[#;!." &"/M$;!." &"/?$;!." &"/1$;!." &"/#$+%)(%\'#($\'#(#\'#("\'#&\'#/\' 8!:ƒ!! )'),E('%%;!/?#;!." &"/1$;!." &"/#$+#)(#\'#("\'#&\'#/\' 8!:Ɠ!! )'),E(";¾"),E('%;/^#$%;B/,#;ó/#$+")("\'#&\'#06*%;B/,#;ó/#$+")("\'#&\'#&/($8":Ɣ"!!)("\'#&\'#'),E(";ô.# &; "),E('%2ƕ""6ƕ7Ɩ/L#;</C$2Ɨ""6Ɨ7Ƙ.) &2ƙ""6ƙ7ƚ/($8#:ƛ#! )(#\'#("\'#&\'#'),E('%;/^#$%;B/,#; /#$+")("\'#&\'#06*%;B/,#; /#$+")("\'#&\'#&/($8":Ɯ"!!)("\'#&\'#'),E("%;6/5#;0/,$;÷/#$+#)(#'#(\"'#&'#"),E("$;2.) &;4.# &;.0/*;2.) &;4.# &;.&"),E("$;%0#*;%&"),E("%;ú/;#28\"\"6879/,$;û/#$+#)(#'#(\"'#&'#"),E('%3Ɲ""5%7ƞ.) &3Ɵ""5$7Ơ/\' 8!:ơ!! )'),E('%;ü/J#%28""6879/,#;^/#$+")("\'#&\'#." &"/#$+")("\'#&\'#'),E("%;\\.) &;X.# &;/' 8!:Ƣ!! )"),E(';".S &;!.M &2F""6F7G.A &2J""6J7K.5 &2H""6H7I.) &2N""6N7O'),E('2L""6L7M. &2B""6B7C. &2<""6<7=.} &2R""6R7S.q &2T""6T7U.e &2V""6V7W.Y &2P""6P7Q.M &2@""6@7A.A &2D""6D7E.5 &22""6273.) &2>""6>7?'),E('%;Ā/b#28""6879/S$;û/J$%2ƣ""6ƣ7Ƥ/,#;ì/#$+")("\'#&\'#." &"/#$+$)($\'#(#\'#("\'#&\'#'),E('%3ƥ""5%7Ʀ.) &3Ƨ""5$7ƨ/\' 8!:ơ!! )'),E('%;ì/O#3±""5#7².6 &3³""5#7´.* &$;+0#*;+&/\'$8":Ʃ" )("\'#&\'#'),E("%;Ą/#2F\"\"6F7G/x$;ă/o$2F\"\"6F7G/`$;ă/W$2F\"\"6F7G/H$;ă/?$2F\"\"6F7G/0$;ą/'$8):ƪ) )()'#(('#(''#(&'#(%'#($'#(#'#(\"'#&'#"),E("%;#/>#;#/5$;#/,$;#/#$+$)($'#(#'#(\"'#&'#"),E("%;ă/,#;ă/#$+\")(\"'#&'#"),E("%;ă/5#;ă/,$;ă/#$+#)(#'#(\"'#&'#"),E("%;/U#;'/L$;/C$;'/:$;/1$; .\" &\"/#$+&)(&'#(%'#($'#(#'#(\"'#&'#"),E('%2ƫ""6ƫ7Ƭ.) &2ƭ""6ƭ7Ʈ/w#;0/n$;Ĉ/e$$%;B/2#;ĉ.# &; /#$+")("\'#&\'#0<*%;B/2#;ĉ.# &; /#$+")("\'#&\'#&/#$+$)($\'#(#\'#("\'#&\'#'),E(";.# &;L"),E("%2Ư\"\"6Ư7ư/5#;</,$;Ċ/#$+#)(#'#(\"'#&'#"),E("%;D/S#;,/J$2:\"\"6:7;/;$;,.# &;T/,$;E/#$+%)(%'#($'#(#'#(\"'#&'#")],u=0,h=0,d=[{line:1,column:1}],l=0,p=[],f=0;if("startRule"in t){if(!(t.startRule in s))throw new Error("Can't start parsing from rule \""+t.startRule+'".');o=s[t.startRule]}function m(){return e.substring(h,u)}function g(){return S(h,u)}function v(e,t){return{type:"literal",text:e,ignoreCase:t}}function T(e,t,n){return{type:"class",parts:e,inverted:t,ignoreCase:n}}function y(t){var n,i=d[t];if(i)return i;for(n=t-1;!d[n];)n--;for(i={line:(i=d[n]).line,column:i.column};n<t;)10===e.charCodeAt(n)?(i.line++,i.column=1):i.column++,n++;return d[t]=i,i}function S(e,t){var n=y(e),i=y(t);return{start:{offset:e,line:n.line,column:n.column},end:{offset:t,line:i.line,column:i.column}}}function b(e){u<l||(u>l&&(l=u,p=[]),p.push(e))}function C(e,t,n){return new i(i.buildMessage(e,t),e,t,n)}function E(e){var t,n=new Array(e.length);for(t=0;t<e.length;t++)n[t]=e.charCodeAt(t)-32;return n}if(t.data={},(n=function t(n){for(var i,s,o=c[n],d=0,l=[],p=o.length,m=[],g=[];;){for(;d<p;)switch(o[d]){case 0:g.push(a[o[d+1]]),d+=2;break;case 1:g.push(void 0),d++;break;case 2:g.push(null),d++;break;case 3:g.push(r),d++;break;case 4:g.push([]),d++;break;case 5:g.push(u),d++;break;case 6:g.pop(),d++;break;case 7:u=g.pop(),d++;break;case 8:g.length-=o[d+1],d+=2;break;case 9:g.splice(-2,1),d++;break;case 10:g[g.length-2].push(g.pop()),d++;break;case 11:g.push(g.splice(g.length-o[d+1],o[d+1])),d+=2;break;case 12:g.push(e.substring(g.pop(),u)),d++;break;case 13:m.push(p),l.push(d+3+o[d+1]+o[d+2]),g[g.length-1]?(p=d+3+o[d+1],d+=3):(p=d+3+o[d+1]+o[d+2],d+=3+o[d+1]);break;case 14:m.push(p),l.push(d+3+o[d+1]+o[d+2]),g[g.length-1]===r?(p=d+3+o[d+1],d+=3):(p=d+3+o[d+1]+o[d+2],d+=3+o[d+1]);break;case 15:m.push(p),l.push(d+3+o[d+1]+o[d+2]),g[g.length-1]!==r?(p=d+3+o[d+1],d+=3):(p=d+3+o[d+1]+o[d+2],d+=3+o[d+1]);break;case 16:g[g.length-1]!==r?(m.push(p),l.push(d),p=d+2+o[d+1],d+=2):d+=2+o[d+1];break;case 17:m.push(p),l.push(d+3+o[d+1]+o[d+2]),e.length>u?(p=d+3+o[d+1],d+=3):(p=d+3+o[d+1]+o[d+2],d+=3+o[d+1]);break;case 18:m.push(p),l.push(d+4+o[d+2]+o[d+3]),e.substr(u,a[o[d+1]].length)===a[o[d+1]]?(p=d+4+o[d+2],d+=4):(p=d+4+o[d+2]+o[d+3],d+=4+o[d+2]);break;case 19:m.push(p),l.push(d+4+o[d+2]+o[d+3]),e.substr(u,a[o[d+1]].length).toLowerCase()===a[o[d+1]]?(p=d+4+o[d+2],d+=4):(p=d+4+o[d+2]+o[d+3],d+=4+o[d+2]);break;case 20:m.push(p),l.push(d+4+o[d+2]+o[d+3]),a[o[d+1]].test(e.charAt(u))?(p=d+4+o[d+2],d+=4):(p=d+4+o[d+2]+o[d+3],d+=4+o[d+2]);break;case 21:g.push(e.substr(u,o[d+1])),u+=o[d+1],d+=2;break;case 22:g.push(a[o[d+1]]),u+=a[o[d+1]].length,d+=2;break;case 23:g.push(r),0===f&&b(a[o[d+1]]),d+=2;break;case 24:h=g[g.length-1-o[d+1]],d+=2;break;case 25:h=u,d++;break;case 26:for(i=o.slice(d+4,d+4+o[d+3]),s=0;s<o[d+3];s++)i[s]=g[g.length-1-i[s]];g.splice(g.length-o[d+2],o[d+2],a[o[d+1]].apply(null,i)),d+=4+o[d+3];break;case 27:g.push(t(o[d+1])),d+=2;break;case 28:f++,d++;break;case 29:f--,d++;break;default:throw new Error("Invalid opcode: "+o[d]+".")}if(!(m.length>0))break;p=m.pop(),d=l.pop()}return g[0]}(o))!==r&&u===e.length)return n;throw n!==r&&u<e.length&&b({type:"end"}),C(p,l<e.length?e.charAt(l):null,l<e.length?S(l,l+1):S(l,l))}}},function(e,t,n){"use strict";e.exports=function(e){function t(e,t){var n,i,r=[],s=e.split(/\r\n/);for(n=0;n<s.length;){var o=s[n];if(/^m=(?:audio|video)/.test(o))i={index:n,stripped:[]},r.push(i);else if(i){var a=/^a=rtpmap:(\d+) ([^/]+)\//.exec(o);if(a&&t===a[2]){s.splice(n,1),i.stripped.push(a[1]);continue}}n++}for(n=0;n<r.length;n++){for(var c=s[r[n].index].split(" "),u=3;u<c.length;)-1===r[n].stripped.indexOf(c[u])?u++:c.splice(u,1);s[r[n].index]=c.join(" ")}return s.join("\r\n")}return{stripTcpCandidates:function(t){return t.sdp=t.sdp.replace(/^a=candidate:\d+ \d+ tcp .*?\r\n/gim,""),e.Utils.Promise.resolve(t)},stripTelephoneEvent:function(n){return n.sdp=t(n.sdp,"telephone-event"),e.Utils.Promise.resolve(n)},cleanJitsiSdpImageattr:function(t){return t.sdp=t.sdp.replace(/^(a=imageattr:.*?)(x|y)=\[0-/gm,"$1$2=[1:"),e.Utils.Promise.resolve(t)},stripG722:function(n){return n.sdp=t(n.sdp,"G722"),e.Utils.Promise.resolve(n)},stripRtpPayload:function(n){return function(i){return i.sdp=t(i.sdp,n),e.Utils.Promise.resolve(i)}},stripVideo:function(t){return t.sdp=function(e,t){var n=new RegExp("m="+t+".*$","gm"),i=new RegExp("^a=group:.*$","gm");if(n.test(e)){var r,s=(e=e.split(/^m=/gm).filter(function(e){return e.substr(0,t.length)!==t||((r=e.match(/^a=mid:.*$/gm))&&(r=r[0].match(/:.+$/g)[0].substr(1)),!1)}).join("m=")).match(i);if(s&&1===s.length){s=s[0];var o=new RegExp(" *"+r+"[^ ]*","g");s=s.replace(o,""),e=e.split(i).join(s)}}return e}(t.sdp,"video"),e.Utils.Promise.resolve(t)},addMidLines:function(t){var n=t.sdp;if(-1===n.search(/^a=mid.*$/gm)){var i=n.match(/^m=.*$/gm);n=n.split(/^m=.*$/gm),i.forEach(function(e,t){i[t]=e+"\na=mid:"+t}),n.forEach(function(e,t){i[t]&&(n[t]=e+i[t])}),n=n.join(""),t.sdp=n}return e.Utils.Promise.resolve(t)}}}},function(e,t,n){"use strict";(function(t){e.exports=function(e){var n={STATUS_NULL:0,STATUS_NEW:1,STATUS_CONNECTING:2,STATUS_CONNECTED:3,STATUS_COMPLETED:4},i=function(i){if(i.media.remote.video?this.video=!0:this.video=!1,i.media.remote.audio?this.audio=!0:this.audio=!1,!this.audio&&!this.video)throw new Error("At least one remote audio or video element is required for Simple.");this.options=i;var r=t.navigator.userAgent.toLowerCase(),s=!1,o=!1;r.indexOf("safari")>-1&&r.indexOf("chrome")<0?s=!0:r.indexOf("firefox")>-1&&r.indexOf("chrome")<0&&(o=!0);var a={};return s&&(a.modifiers=[e.Web.Modifiers.stripG722]),o&&(a.alwaysAcquireMediaFirst=!0),this.options.ua.uri||(this.anonymous=!0),this.ua=new e.UA({uri:this.options.ua.uri,authorizationUser:this.options.ua.authorizationUser,password:this.options.ua.password,displayName:this.options.ua.displayName,userAgentString:this.options.ua.userAgentString,register:!0,sessionDescriptionHandlerFactoryOptions:a,transportOptions:{traceSip:this.options.ua.traceSip,wsServers:this.options.ua.wsServers}}),this.state=n.STATUS_NULL,this.logger=this.ua.getLogger("sip.simple"),this.ua.on("registered",function(){this.emit("registered",this.ua)}.bind(this)),this.ua.on("unregistered",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("failed",function(){this.emit("unregistered",this.ua)}.bind(this)),this.ua.on("invite",function(e){if(this.state!==n.STATUS_NULL&&this.state!==n.STATUS_COMPLETED)return this.logger.warn("Rejecting incoming call. Simple only supports 1 call at a time"),void e.reject();this.session=e,this.setupSession(),this.emit("ringing",this.session)}.bind(this)),this.ua.on("message",function(e){this.emit("message",e)}.bind(this)),this};return i.prototype=Object.create(e.EventEmitter.prototype),i.C=n,i.prototype.call=function(e){if(this.ua&&this.checkRegistration()){if(this.state===n.STATUS_NULL||this.state===n.STATUS_COMPLETED)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.autoplay=!0,this.options.media.local.video.volume=0),this.session=this.ua.invite(e,{sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}}),this.setupSession(),this.session;this.logger.warn("Cannot make more than a single call with Simple")}else this.logger.warn("A registered UA is required for calling")},i.prototype.answer=function(){if(this.state===n.STATUS_NEW||this.state===n.STATUS_CONNECTING)return this.options.media.remote.audio&&(this.options.media.remote.audio.autoplay=!0),this.options.media.remote.video&&(this.options.media.remote.video.autoplay=!0),this.session.accept({sessionDescriptionHandlerOptions:{constraints:{audio:this.audio,video:this.video}}});this.logger.warn("No call to answer")},i.prototype.reject=function(){if(this.state===n.STATUS_NEW||this.state===n.STATUS_CONNECTING)return this.session.reject();this.logger.warn("Call is already answered")},i.prototype.hangup=function(){if(this.state===n.STATUS_CONNECTED||this.state===n.STATUS_CONNECTING||this.state===n.STATUS_NEW)return this.state!==n.STATUS_CONNECTED?this.session.cancel():this.session.bye();this.logger.warn("No active call to hang up on")},i.prototype.hold=function(){if(this.state===n.STATUS_CONNECTED&&!this.session.local_hold)return this.mute(),this.logger.log("Placing session on hold"),this.session.hold();this.logger.warn("Cannot put call on hold")},i.prototype.unhold=function(){if(this.state===n.STATUS_CONNECTED&&this.session.local_hold)return this.unmute(),this.logger.log("Placing call off hold"),this.session.unhold();this.logger.warn("Cannot unhold a call that is not on hold")},i.prototype.mute=function(){this.state===n.STATUS_CONNECTED?(this.logger.log("Muting Audio"),this.toggleMute(!0),this.emit("mute",this)):this.logger.warn("An acitve call is required to mute audio")},i.prototype.unmute=function(){this.state===n.STATUS_CONNECTED?(this.logger.log("Unmuting Audio"),this.toggleMute(!1),this.emit("unmute",this)):this.logger.warn("An active call is required to unmute audio")},i.prototype.sendDTMF=function(e){this.state===n.STATUS_CONNECTED?(this.logger.log("Sending DTMF tone: "+e),this.session.dtmf(e)):this.logger.warn("An active call is required to send a DTMF tone")},i.prototype.message=function(e,t){this.ua&&this.checkRegistration()?e&&t?this.ua.message(e,t):this.logger.warn("A destination and message are required to send a message"):this.logger.warn("A registered UA is required to send a message")},i.prototype.checkRegistration=function(){return this.anonymous||this.ua&&this.ua.isRegistered()},i.prototype.setupRemoteMedia=function(){var e,n=this.session.sessionDescriptionHandler.peerConnection;n.getReceivers?(e=new t.window.MediaStream,n.getReceivers().forEach(function(t){var n=t.track;n&&e.addTrack(n)})):e=n.getRemoteStreams()[0],this.video?(this.options.media.remote.video.srcObject=e,this.options.media.remote.video.play().catch(function(){this.logger.log("play was rejected")}.bind(this))):this.audio&&(this.options.media.remote.audio.srcObject=e,this.options.media.remote.audio.play().catch(function(){this.logger.log("play was rejected")}.bind(this)))},i.prototype.setupLocalMedia=function(){if(this.video&&this.options.media.local&&this.options.media.local.video){var e,n=this.session.sessionDescriptionHandler.peerConnection;n.getSenders?(e=new t.window.MediaStream,n.getSenders().forEach(function(t){var n=t.track;n&&"video"===n.kind&&e.addTrack(n)})):e=n.getLocalStreams()[0],this.options.media.local.video.srcObject=e,this.options.media.local.video.volume=0,this.options.media.local.video.play()}},i.prototype.cleanupMedia=function(){this.video&&(this.options.media.remote.video.srcObject=null,this.options.media.remote.video.pause(),this.options.media.local&&this.options.media.local.video&&(this.options.media.local.video.srcObject=null,this.options.media.local.video.pause())),this.audio&&(this.options.media.remote.audio.srcObject=null,this.options.media.remote.audio.pause())},i.prototype.setupSession=function(){this.state=n.STATUS_NEW,this.emit("new",this.session),this.session.on("progress",this.onProgress.bind(this)),this.session.on("accepted",this.onAccepted.bind(this)),this.session.on("rejected",this.onEnded.bind(this)),this.session.on("failed",this.onFailed.bind(this)),this.session.on("terminated",this.onEnded.bind(this))},i.prototype.destroyMedia=function(){this.session.sessionDescriptionHandler.close()},i.prototype.toggleMute=function(e){var t=this.session.sessionDescriptionHandler.peerConnection;t.getSenders?t.getSenders().forEach(function(t){t.track&&(t.track.enabled=!e)}):t.getLocalStreams().forEach(function(t){t.getAudioTracks().forEach(function(t){t.enabled=!e}),t.getVideoTracks().forEach(function(t){t.enabled=!e})})},i.prototype.onAccepted=function(){this.state=n.STATUS_CONNECTED,this.emit("connected",this.session),this.setupLocalMedia(),this.setupRemoteMedia(),this.session.sessionDescriptionHandler.on("addTrack",function(){this.logger.log("A track has been added, triggering new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.sessionDescriptionHandler.on("addStream",function(){this.logger.log("A stream has been added, trigger new remoteMedia setup"),this.setupRemoteMedia()}.bind(this)),this.session.on("hold",function(){this.emit("hold",this.session)}.bind(this)),this.session.on("unhold",function(){this.emit("unhold",this.session)}.bind(this)),this.session.on("dtmf",function(e){this.emit("dtmf",e)}.bind(this)),this.session.on("bye",this.onEnded.bind(this))},i.prototype.onProgress=function(){this.state=n.STATUS_CONNECTING,this.emit("connecting",this.session)},i.prototype.onFailed=function(){this.onEnded()},i.prototype.onEnded=function(){this.state=n.STATUS_COMPLETED,this.emit("ended",this.session),this.cleanupMedia()},i}}).call(this,n(28))},function(e,t,n){"use strict";(function(t){var i=t.window||t;function r(e,t){if(null!=e){var n=t.charAt(0).toUpperCase()+t.slice(1),i=[t,"webkit"+n,"moz"+n];for(var r in i){var s=e[i[r]];if(s)return s.bind(e)}}}e.exports={WebSocket:i.WebSocket,Transport:n(10),open:i.open,Promise:i.Promise,timers:i,console:i.console||{debug:function(){},log:function(){},warn:function(){},error:function(){}},addEventListener:r(i,"addEventListener"),removeEventListener:r(i,"removeEventListener")}}).call(this,n(28))}])},e.exports=i()},function(e,t,n){var i,r;(function(){(function(){(function(){var e=[].slice;this.ActionCable={INTERNAL:{message_types:{welcome:"welcome",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},WebSocket:window.WebSocket,logger:window.console,createConsumer:function(e){var t;return null==e&&(e=null!=(t=this.getConfig("url"))?t:this.INTERNAL.default_mount_path),new s.Consumer(this.createWebSocketURL(e))},getConfig:function(e){var t;return null!=(t=document.head.querySelector("meta[name='action-cable-"+e+"']"))?t.getAttribute("content"):void 0},createWebSocketURL:function(e){var t;return e&&!/^wss?:/i.test(e)?((t=document.createElement("a")).href=e,t.href=t.href,t.protocol=t.protocol.replace("http","ws"),t.href):e},startDebugging:function(){return this.debugging=!0},stopDebugging:function(){return this.debugging=null},log:function(){var t,n;if(t=1<=arguments.length?e.call(arguments,0):[],this.debugging)return t.push(Date.now()),(n=this.logger).log.apply(n,["[ActionCable]"].concat(e.call(t)))}}}).call(this)}).call(this);var s=this.ActionCable;(function(){(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};s.ConnectionMonitor=function(){var t,n,i;function r(t){this.connection=t,this.visibilityDidChange=e(this.visibilityDidChange,this),this.reconnectAttempts=0}return r.pollInterval={min:3,max:30},r.staleThreshold=6,r.prototype.start=function(){if(!this.isRunning())return this.startedAt=n(),delete this.stoppedAt,this.startPolling(),document.addEventListener("visibilitychange",this.visibilityDidChange),s.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms")},r.prototype.stop=function(){if(this.isRunning())return this.stoppedAt=n(),this.stopPolling(),document.removeEventListener("visibilitychange",this.visibilityDidChange),s.log("ConnectionMonitor stopped")},r.prototype.isRunning=function(){return null!=this.startedAt&&null==this.stoppedAt},r.prototype.recordPing=function(){return this.pingedAt=n()},r.prototype.recordConnect=function(){return this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,s.log("ConnectionMonitor recorded connect")},r.prototype.recordDisconnect=function(){return this.disconnectedAt=n(),s.log("ConnectionMonitor recorded disconnect")},r.prototype.startPolling=function(){return this.stopPolling(),this.poll()},r.prototype.stopPolling=function(){return clearTimeout(this.pollTimeout)},r.prototype.poll=function(){return this.pollTimeout=setTimeout((e=this,function(){return e.reconnectIfStale(),e.poll()}),this.getPollInterval());var e},r.prototype.getPollInterval=function(){var e,n,i,r;return i=(r=this.constructor.pollInterval).min,n=r.max,e=5*Math.log(this.reconnectAttempts+1),Math.round(1e3*t(e,i,n))},r.prototype.reconnectIfStale=function(){if(this.connectionIsStale())return s.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+i(this.disconnectedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?s.log("ConnectionMonitor skipping reopening recent disconnect"):(s.log("ConnectionMonitor reopening"),this.connection.reopen())},r.prototype.connectionIsStale=function(){var e;return i(null!=(e=this.pingedAt)?e:this.startedAt)>this.constructor.staleThreshold},r.prototype.disconnectedRecently=function(){return this.disconnectedAt&&i(this.disconnectedAt)<this.constructor.staleThreshold},r.prototype.visibilityDidChange=function(){if("visible"===document.visibilityState)return setTimeout((e=this,function(){if(e.connectionIsStale()||!e.connection.isOpen())return s.log("ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = "+document.visibilityState),e.connection.reopen()}),200);var e},n=function(){return(new Date).getTime()},i=function(e){return(n()-e)/1e3},t=function(e,t,n){return Math.max(t,Math.min(n,e))},r}()}).call(this),function(){var e,t,n,i,r,o=[].slice,a=function(e,t){return function(){return e.apply(t,arguments)}},c=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};i=s.INTERNAL,t=i.message_types,n=i.protocols,r=2<=n.length?o.call(n,0,e=n.length-1):(e=0,[]),n[e++],s.Connection=function(){function e(e){this.consumer=e,this.open=a(this.open,this),this.subscriptions=this.consumer.subscriptions,this.monitor=new s.ConnectionMonitor(this),this.disconnected=!0}return e.reopenDelay=500,e.prototype.send=function(e){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(e)),!0)},e.prototype.open=function(){return this.isActive()?(s.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(s.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+n),null!=this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new s.WebSocket(this.consumer.url,n),this.installEventHandlers(),this.monitor.start(),!0)},e.prototype.close=function(e){var t;if((null!=e?e:{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return null!=(t=this.webSocket)?t.close():void 0},e.prototype.reopen=function(){var e;if(s.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(t){return e=t,s.log("Failed to reopen WebSocket",e)}finally{s.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},e.prototype.getProtocol=function(){var e;return null!=(e=this.webSocket)?e.protocol:void 0},e.prototype.isOpen=function(){return this.isState("open")},e.prototype.isActive=function(){return this.isState("open","connecting")},e.prototype.isProtocolSupported=function(){var e;return e=this.getProtocol(),c.call(r,e)>=0},e.prototype.isState=function(){var e,t;return t=1<=arguments.length?o.call(arguments,0):[],e=this.getState(),c.call(t,e)>=0},e.prototype.getState=function(){var e,t;for(t in WebSocket)if(WebSocket[t]===(null!=(e=this.webSocket)?e.readyState:void 0))return t.toLowerCase();return null},e.prototype.installEventHandlers=function(){var e,t;for(e in this.events)t=this.events[e].bind(this),this.webSocket["on"+e]=t},e.prototype.uninstallEventHandlers=function(){var e;for(e in this.events)this.webSocket["on"+e]=function(){}},e.prototype.events={message:function(e){var n,i,r;if(this.isProtocolSupported())switch(n=(r=JSON.parse(e.data)).identifier,i=r.message,r.type){case t.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case t.ping:return this.monitor.recordPing();case t.confirmation:return this.subscriptions.notify(n,"connected");case t.rejection:return this.subscriptions.reject(n);default:return this.subscriptions.notify(n,"received",i)}},open:function(){if(s.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return s.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function(e){if(s.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function(){return s.log("WebSocket onerror event")}},e}()}.call(this),function(){var e=[].slice;s.Subscriptions=function(){function t(e){this.consumer=e,this.subscriptions=[]}return t.prototype.create=function(e,t){var n,i,r;return i="object"==typeof(n=e)?n:{channel:n},r=new s.Subscription(this.consumer,i,t),this.add(r)},t.prototype.add=function(e){return this.subscriptions.push(e),this.consumer.ensureActiveConnection(),this.notify(e,"initialized"),this.sendCommand(e,"subscribe"),e},t.prototype.remove=function(e){return this.forget(e),this.findAll(e.identifier).length||this.sendCommand(e,"unsubscribe"),e},t.prototype.reject=function(e){var t,n,i,r,s;for(r=[],t=0,n=(i=this.findAll(e)).length;t<n;t++)s=i[t],this.forget(s),this.notify(s,"rejected"),r.push(s);return r},t.prototype.forget=function(e){var t;return this.subscriptions=function(){var n,i,r,s;for(s=[],n=0,i=(r=this.subscriptions).length;n<i;n++)(t=r[n])!==e&&s.push(t);return s}.call(this),e},t.prototype.findAll=function(e){var t,n,i,r,s;for(r=[],t=0,n=(i=this.subscriptions).length;t<n;t++)(s=i[t]).identifier===e&&r.push(s);return r},t.prototype.reload=function(){var e,t,n,i,r;for(i=[],e=0,t=(n=this.subscriptions).length;e<t;e++)r=n[e],i.push(this.sendCommand(r,"subscribe"));return i},t.prototype.notifyAll=function(){var t,n,i,r,s,o,a;for(n=arguments[0],t=2<=arguments.length?e.call(arguments,1):[],o=[],i=0,r=(s=this.subscriptions).length;i<r;i++)a=s[i],o.push(this.notify.apply(this,[a,n].concat(e.call(t))));return o},t.prototype.notify=function(){var t,n,i,r,s,o,a;for(o=arguments[0],n=arguments[1],t=3<=arguments.length?e.call(arguments,2):[],s=[],i=0,r=(a="string"==typeof o?this.findAll(o):[o]).length;i<r;i++)o=a[i],s.push("function"==typeof o[n]?o[n].apply(o,t):void 0);return s},t.prototype.sendCommand=function(e,t){var n;return n=e.identifier,this.consumer.send({command:t,identifier:n})},t}()}.call(this),function(){s.Subscription=function(){var e;function t(t,n,i){this.consumer=t,null==n&&(n={}),this.identifier=JSON.stringify(n),e(this,i)}return t.prototype.perform=function(e,t){return null==t&&(t={}),t.action=e,this.send(t)},t.prototype.send=function(e){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(e)})},t.prototype.unsubscribe=function(){return this.consumer.subscriptions.remove(this)},e=function(e,t){var n,i;if(null!=t)for(n in t)i=t[n],e[n]=i;return e},t}()}.call(this),function(){s.Consumer=function(){function e(e){this.url=e,this.subscriptions=new s.Subscriptions(this),this.connection=new s.Connection(this)}return e.prototype.send=function(e){return this.connection.send(e)},e.prototype.connect=function(){return this.connection.open()},e.prototype.disconnect=function(){return this.connection.close({allowReconnect:!1})},e.prototype.ensureActiveConnection=function(){if(!this.connection.isActive())return this.connection.open()},e}()}.call(this)}).call(this),e.exports?e.exports=s:void 0===(r="function"==typeof(i=s)?i.call(t,n,t,e):i)||(e.exports=r)}).call(this)},function(e,t){function n(t,i){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,i)}e.exports=n},function(e,t,n){var i=n(2);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=i(e)););return e}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){var i=function(e){"use strict";var t,n=Object.prototype,i=n.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},s=r.iterator||"@@iterator",o=r.asyncIterator||"@@asyncIterator",a=r.toStringTag||"@@toStringTag";function c(e,t,n,i){var r=t&&t.prototype instanceof m?t:m,s=Object.create(r.prototype),o=new A(i||[]);return s._invoke=function(e,t,n){var i=h;return function(r,s){if(i===l)throw new Error("Generator is already running");if(i===p){if("throw"===r)throw s;return k()}for(n.method=r,n.arg=s;;){var o=n.delegate;if(o){var a=_(o,n);if(a){if(a===f)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===h)throw i=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=l;var c=u(e,t,n);if("normal"===c.type){if(i=n.done?p:d,c.arg===f)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(i=p,n.method="throw",n.arg=c.arg)}}}(e,n,o),s}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var h="suspendedStart",d="suspendedYield",l="executing",p="completed",f={};function m(){}function g(){}function v(){}var T={};T[s]=function(){return this};var y=Object.getPrototypeOf,S=y&&y(y(I([])));S&&S!==n&&i.call(S,s)&&(T=S);var b=v.prototype=m.prototype=Object.create(T);function C(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function E(e){var t;this._invoke=function(n,r){function s(){return new Promise(function(t,s){!function t(n,r,s,o){var a=u(e[n],e,r);if("throw"!==a.type){var c=a.arg,h=c.value;return h&&"object"==typeof h&&i.call(h,"__await")?Promise.resolve(h.__await).then(function(e){t("next",e,s,o)},function(e){t("throw",e,s,o)}):Promise.resolve(h).then(function(e){c.value=e,s(c)},function(e){return t("throw",e,s,o)})}o(a.arg)}(n,r,t,s)})}return t=t?t.then(s,s):s()}}function _(e,n){var i=e.iterator[n.method];if(i===t){if(n.delegate=null,"throw"===n.method){if(e.iterator.return&&(n.method="return",n.arg=t,_(e,n),"throw"===n.method))return f;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var r=u(i,e.iterator,n.arg);if("throw"===r.type)return n.method="throw",n.arg=r.arg,n.delegate=null,f;var s=r.arg;return s?s.done?(n[e.resultName]=s.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,f):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,f)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function I(e){if(e){var n=e[s];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,o=function n(){for(;++r<e.length;)if(i.call(e,r))return n.value=e[r],n.done=!1,n;return n.value=t,n.done=!0,n};return o.next=o}}return{next:k}}function k(){return{value:t,done:!0}}return g.prototype=b.constructor=v,v.constructor=g,v[a]=g.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,a in e||(e[a]="GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},C(E.prototype),E.prototype[o]=function(){return this},e.AsyncIterator=E,e.async=function(t,n,i,r){var s=new E(c(t,n,i,r));return e.isGeneratorFunction(n)?s:s.next().then(function(e){return e.done?e.value:s.next()})},C(b),b[a]="Generator",b[s]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var i=t.pop();if(i in e)return n.value=i,n.done=!1,n}return n.done=!0,n}},e.values=I,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(w),!e)for(var n in this)"t"===n.charAt(0)&&i.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function r(i,r){return a.type="throw",a.arg=e,n.next=i,r&&(n.method="next",n.arg=t),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=i.call(o,"catchLoc"),u=i.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,f):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),w(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var i=n.completion;if("throw"===i.type){var r=i.arg;w(n)}return r}}throw new Error("illegal catch attempt")},delegateYield:function(e,n,i){return this.delegate={iterator:I(e),resultName:n,nextLoc:i},"next"===this.method&&(this.arg=t),f}},e}(e.exports);try{regeneratorRuntime=i}catch(e){Function("r","regeneratorRuntime = r")(i)}},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==a.return||a.return()}finally{if(r)throw s}}return n}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t){e.exports=function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}},function(e,t){e.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(e,t,n){"use strict";n.r(t);var i={};n.r(i),n.d(i,"shimGetUserMedia",function(){return Y}),n.d(i,"shimGetDisplayMedia",function(){return z}),n.d(i,"shimMediaStream",function(){return J}),n.d(i,"shimOnTrack",function(){return Z}),n.d(i,"shimGetSendersWithDtmf",function(){return X}),n.d(i,"shimGetStats",function(){return Q}),n.d(i,"shimSenderReceiverGetStats",function(){return ee}),n.d(i,"shimAddTrackRemoveTrackWithNative",function(){return te}),n.d(i,"shimAddTrackRemoveTrack",function(){return ne}),n.d(i,"shimPeerConnection",function(){return ie}),n.d(i,"fixNegotiationNeeded",function(){return re});var r={};n.r(r),n.d(r,"shimGetUserMedia",function(){return ae}),n.d(r,"shimGetDisplayMedia",function(){return ce}),n.d(r,"shimPeerConnection",function(){return ue}),n.d(r,"shimReplaceTrack",function(){return he});var s={};n.r(s),n.d(s,"shimGetUserMedia",function(){return de}),n.d(s,"shimGetDisplayMedia",function(){return le}),n.d(s,"shimOnTrack",function(){return pe}),n.d(s,"shimPeerConnection",function(){return fe}),n.d(s,"shimSenderGetStats",function(){return me}),n.d(s,"shimReceiverGetStats",function(){return ge}),n.d(s,"shimRemoveStream",function(){return ve}),n.d(s,"shimRTCDataChannel",function(){return Te});var o={};n.r(o),n.d(o,"shimLocalStreamsAPI",function(){return ye}),n.d(o,"shimRemoteStreamsAPI",function(){return Se}),n.d(o,"shimCallbacksAPI",function(){return be}),n.d(o,"shimGetUserMedia",function(){return Ce}),n.d(o,"shimConstraints",function(){return Ee}),n.d(o,"shimRTCIceServerUrls",function(){return _e}),n.d(o,"shimTrackEventTransceiver",function(){return Re}),n.d(o,"shimCreateOfferLegacy",function(){return we});var a={};n.r(a),n.d(a,"shimRTCIceCandidate",function(){return ke}),n.d(a,"shimMaxMessageSize",function(){return De}),n.d(a,"shimSendThrowTypeError",function(){return xe}),n.d(a,"shimConnectionState",function(){return Oe}),n.d(a,"removeAllowExtmapMixed",function(){return Pe});var c={};n.r(c),n.d(c,"hasAudio",function(){return Xe}),n.d(c,"hasVideo",function(){return Qe}),n.d(c,"disableAudio",function(){return et}),n.d(c,"enableAudio",function(){return tt}),n.d(c,"stopTrack",function(){return nt}),n.d(c,"stopStream",function(){return it}),n.d(c,"getScreenTracks",function(){return at}),n.d(c,"getCameraTracks",function(){return ct}),n.d(c,"stopCamera",function(){return ut}),n.d(c,"disableCamera",function(){return ht}),n.d(c,"enableCamera",function(){return dt}),n.d(c,"toggleCamera",function(){return lt}),n.d(c,"getCanvasTracks",function(){return pt}),n.d(c,"isScreenStream",function(){return ft}),n.d(c,"isCanvasStream",function(){return mt}),n.d(c,"isCameraStream",function(){return gt}),n.d(c,"isCanvasPresentationStream",function(){return vt}),n.d(c,"isPresentationStream",function(){return Tt}),n.d(c,"hasCameraVideo",function(){return yt}),n.d(c,"captureStream",function(){return St});var u=n(7),h=n.n(u),d=n(0),l=n.n(d),p=n(1),f=n.n(p),m={error:function(){var e;return(e=console).error.apply(e,arguments)},warn:function(){var e;return(e=console).warn.apply(e,arguments)},info:function(){var e;return(e=console).log.apply(e,arguments)},debug:function(){var e;return console.debug?(e=console).debug.apply(e,arguments):null}},g=function(){function e(t,n){l()(this,e),this.uri=t,this.token=n.replace(/\W+/g,""),this.cache={users:[]},this.onError=null,this._handleError=this._handleError.bind(this)}return f()(e,[{key:"_request",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return fetch(new Request(this.uri+e),t).then(function(e){var t=e.headers.get("content-type");if(t&&-1!==t.indexOf("application/json")&&e.ok)return e.json();if(e.ok)return e.text();throw new Error("ComApiError: ".concat(e.status))})}},{key:"_objectToFormData",value:function(e,t,n){var i=t||new FormData,r=null;for(var s in e){if(!e.hasOwnProperty(s))return;if(n)r=n+"["+(isNaN(parseInt(s))?s:"")+"]";else r=s;"object"!==h()(e[s])||e[s]instanceof File?i.append(r,e[s]):this._objectToFormData(e[s],i,s)}return i}},{key:"_post",value:function(e,t){return this._request(e,{method:"POST",body:this._objectToFormData(t)})}},{key:"_put",value:function(e,t){var n=new FormData;for(var i in t)n.append(i,t[i]);return this._request(e,{method:"PUT",body:n})}},{key:"_handleError",value:function(e){m.error("ComApi::handleError",e),this.onError&&this.onError(e)}},{key:"onError",value:function(e){this.onError=e}},{key:"getRoom",value:function(e){return this._request("/rooms/".concat(this.token)).then(e).catch(function(t){return e?e({error:t}):{error:t}})}},{key:"getUser",value:function(e,t){var n=this,i=this.cache.users.find(function(t){return t.id===e});return i?(t(i),null):this._request("/rooms/".concat(this.token,"/users/").concat(e)).then(function(i){var r=n.cache.users.filter(function(t){return t.id!==e}),s=n.addUserAttributes(i,e);r.push(s),n.cache.users=r,t(s)}).catch(this._handleError)}},{key:"addUserAttributes",value:function(e,t){var n=e.avatar;try{n="".concat(e.avatar,"?size=large")}catch(t){m.warn("ComApi::addUserAttributes missing",e)}return Object.assign(e,{id:t,apiId:e.id,sipId:e.sip&&e.sip.authorizationUser||null,largeAvatar:n})}},{key:"requestUser",value:function(e,t){return this._post("/guests/".concat(this.token),{name:e.name,email:e.email}).then(t).catch(function(e){return t({error:e})})}},{key:"startBroadcast",value:function(e,t){return this._post("/rooms/".concat(this.token,"/broadcasts"),{platform:t,player_url:e.playerUrl||"",stream_url:e.streamUrl})}},{key:"publishBroadcast",value:function(e,t){return this._put("/rooms/".concat(this.token,"/broadcasts/").concat(t),{player_url:e.playerUrl})}},{key:"stopBroadcast",value:function(e){return this._request("/rooms/".concat(this.token,"/broadcasts/").concat(e),{method:"DELETE"})}},{key:"stopAllBroadcasts",value:function(){return this._request("/rooms/".concat(this.token,"/broadcasts"),{method:"DELETE"})}},{key:"startRecording",value:function(){return this._post("/rooms/".concat(this.token,"/recording"),{})}},{key:"stopRecording",value:function(){return this._request("/rooms/".concat(this.token,"/recording"),{method:"DELETE"}).catch(this._handleError)}},{key:"setLayout",value:function(e){return this._post("/rooms/".concat(this.token,"/layout"),e).catch(this._handleError)}},{key:"setLayer",value:function(e){return this._post("/rooms/".concat(this.token,"/layers"),e).catch(this._handleError)}},{key:"clearFrontLayer",value:function(){return this._request("/rooms/".concat(this.token,"/layers/1"),{method:"DELETE"}).catch(this._handleError)}},{key:"takeSnapshot",value:function(){return this._post("/rooms/".concat(this.token,"/snapshot")).catch(this._handleError)}},{key:"createAnnotation",value:function(e,t){var n=this;return this._post("/rooms/".concat(this.token,"/annotation")).then(e).catch(function(e){t(e),n._handleError(e)})}},{key:"stopAnnotation",value:function(){return this._request("/rooms/".concat(this.token,"/annotation"),{method:"DELETE"}).catch(this._handleError)}},{key:"startPlayback",value:function(e){return this._post("/rooms/".concat(this.token,"/playbacks"),{playback:e}).catch(this._handleError)}},{key:"stopPlayback",value:function(e){return this._request("/rooms/".concat(this.token,"/playbacks/").concat(e.play_id),{method:"DELETE"}).catch(this._handleError)}}]),e}(),v=function(e,t,n){var i,r,s,o=null,a=0;n||(n={});var c=function(){a=!1===n.leading?0:Date.now(),o=null,s=e.apply(i,r),o||(i=r=null)};return function(){var u=Date.now();a||!1!==n.leading||(a=u);var h=t-(u-a);return i=this,r=arguments,h<=0||h>t?(o&&(clearTimeout(o),o=null),a=u,s=e.apply(i,r),o||(i=r=null)):o||!1===n.trailing||(o=setTimeout(c,h)),s}},T=n(3),y=n.n(T),S=n(2),b=n.n(S),C=n(4),E=n.n(C),_=function(){function e(t){l()(this,e),this.context=t}return f()(e,[{key:"handle",value:function(e){m.error("BaseEvent::handle is not implemented",e)}}]),e}(),R=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.startPlayback(e.playback)}}]),t}(_),w=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.stopPlayback(e.playback)}}]),t}(_),A=n(6),I=n.n(A),k=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){"client"!==e._src&&(Reflect.deleteProperty(e,"_src"),this.context.listeners.forEach(function(t){return t(e)}))}}]),t}(_),D=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){var e=this;this.context.annotationLoop=window.setInterval(function(){e.context._api.createAnnotation(function(n){return I()(b()(t.prototype),"handle",e).call(e,{type:"annotation",annotation:n})},function(){window.clearInterval(e.context.annotationLoop)})},1e3)}}]),t}(k),x=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){window.clearInterval(this.context.annotationLoop),this.context._api.stopAnnotation()}}]),t}(k),O=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){this.context._rtConnection.send({message:"stfu"})}}]),t}(k),P=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){}}]),t}(_),N=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context.listeners.forEach(function(t){return t(e)})}}]),t}(_);let U=!0,M=!0;function $(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function L(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);const s=e=>{const t=n(e);t&&i(t)};return this._eventMap=this._eventMap||{},this._eventMap[i]=s,r.apply(this,[e,s])};const s=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return s.apply(this,arguments);const i=this._eventMap[n];return delete this._eventMap[n],s.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function H(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(U=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function q(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(M=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function F(){if("object"==typeof window){if(U)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function j(e,t){M&&console.warn(e+" is deprecated, please use "+t+" instead.")}function G(e){const{navigator:t}=e,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=$(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)n.browser="chrome",n.version=$(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=$(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=$(t.userAgent,/AppleWebKit\/(\d+)\./,1),n.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return n}function B(e){return"[object Object]"===Object.prototype.toString.call(e)}function W(e){return B(e)?Object.keys(e).reduce(function(t,n){const i=B(e[n]),r=i?W(e[n]):e[n],s=i&&!Object.keys(r).length;return void 0===r||s?t:Object.assign(t,{[n]:r})},{}):e}function V(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const s=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)}),s.forEach(t=>{e.forEach(n=>{n.type===i&&n.trackId===t.id&&function e(t,n,i){n&&!i.has(n.id)&&(i.set(n.id,n),Object.keys(n).forEach(r=>{r.endsWith("Id")?e(t,t.get(n[r]),i):r.endsWith("Ids")&&n[r].forEach(n=>{e(t,t.get(n),i)})}))}(e,n,r)})}),r}const K=F;function Y(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const n=G(e),i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[r("min",n)]=i.ideal,t.optional.push(e),(e={})[r("max",n)]=i.ideal,t.optional.push(e)):(e[r("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach(e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(n.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const o=n.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let n;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?n=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(n=["front"]),n)return t.mediaDevices.enumerateDevices().then(t=>{let o=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>n.some(t=>e.label.toLowerCase().includes(t)));return!o&&t.length&&n.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=i(e.video),K("chrome: "+JSON.stringify(e)),r(e)})}e.video=i(e.video)}return K("chrome: "+JSON.stringify(e)),r(e)},s=function(e){return n.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,n,i){r(e,e=>{t.webkitGetUserMedia(e,n,e=>{i&&i(s(e))})})}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return r(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(s(e))))}}}function z(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then(t=>{const i=n.video&&n.video.width,r=n.video&&n.video.height,s=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},i&&(n.video.mandatory.maxWidth=i),r&&(n.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function J(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Z(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)L(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.track.id):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)}),t.stream.getTracks().forEach(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===n.id):{track:n};const r=new Event("track");r.track=n,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}}function X(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Q(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach(e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const i=function(e){n(s(r(e)))};return t.apply(this,[i,e])}return new Promise((e,n)=>{t.apply(this,[function(t){e(s(r(t)))},n])}).then(n,i)}}function ee(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>V(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),L(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>V(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach(n=>{n.track===e&&(t?i=!0:t=n)}),this.getReceivers().forEach(t=>(t.track===e&&(n?i=!0:n=t),t.track===e)),i||t&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function te(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),r.apply(this,arguments)}}function ne(e){if(!e.RTCPeerConnection)return;const t=G(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return te(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:n})}function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)}),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find(e=>e.track===t);if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[n.id];if(s)s.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=s(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then(e=>s(this,e))}};e.RTCPeerConnection.prototype[t]=i[t]});const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(n=>{this._streams[n].getTracks().find(t=>e.track===t)&&(t=this._streams[n])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function ie(e){const t=G(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]});const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function re(e){L(e,"negotiationneeded",e=>{if("stable"===e.target.signalingState)return e})}var se=n(14),oe=n.n(se);function ae(e){const t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch(e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))}}function ce(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function ue(e){const t=G(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const n=new Event("enabled");n.enabled=e,this.dispatchEvent(n)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const n=oe()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let n=!1;return(e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&j("RTCIceServer.url","RTCIceServer.urls");const i="string"==typeof t;return i&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!n?(n=!0,!0):t&&!n}),delete e.url,e.urls=i?t[0]:t,!!t.length}})}(e.iceServers,t.version),F("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype}function he(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function de(e){const t=G(e),n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,i){j("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function le(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})}function pe(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function fe(e){const t=G(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,s]=arguments;return i.apply(this,[e||null]).then(e=>{if(t.version<53&&!r)try{e.forEach(e=>{e.type=n[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))})}return e}).then(r,s)}}function me(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ge(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),L(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function ve(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){j("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function Te(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function ye(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(n=>t.call(this,n,e)),e.getVideoTracks().forEach(n=>t.call(this,n,e))},e.RTCPeerConnection.prototype.addTrack=function(e){const n=arguments[1];return n&&(this._localStreams?this._localStreams.includes(n)||this._localStreams.push(n):this._localStreams=[n]),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach(e=>{n.includes(e.track)&&this.removeTrack(e)})})}}function Se(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)})}),t.apply(e,arguments)}}}function be(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Promise.resolve()):r},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Promise.resolve()):r};let a=function(e,t,n){const i=r.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i};t.setLocalDescription=a,a=function(e,t,n){const i=s.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.setRemoteDescription=a,a=function(e,t,n){const i=o.apply(this,[e]);return n?(i.then(t,n),Promise.resolve()):i},t.addIceCandidate=a}function Ce(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(Ee(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function Ee(e){return e&&void 0!==e.video?Object.assign({},e,{video:W(e.video)}):e}function _e(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let i=e.iceServers[n];!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")?(j("RTCIceServer.url","RTCIceServer.urls"),(i=JSON.parse(JSON.stringify(i))).urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Re(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function we(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}}var Ae=n(11),Ie=n.n(Ae);function ke(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),i=Ie.a.parseCandidate(e.candidate),r=Object.assign(n,i);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,L(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function De(e){if(!e.RTCPeerConnection)return;const t=G(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){if(!e||!e.sdp)return!1;const t=Ie.a.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=Ie.a.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},i=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n},r=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},s=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const r=Ie.a.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?i=parseInt(r[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const e=i(arguments[0]),t=r(e),n=s(arguments[0],e);let o;o=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return o.apply(this,arguments)}}function xe(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],r=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},L(e,"datachannel",e=>(t(e.channel,e.target),e))}function Oe(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function Pe(e){if(!e.RTCPeerConnection)return;const t=G(e);if("chrome"===t.browser&&t.version>=71)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),n.apply(this,arguments)}}var Ne,Ue,Me=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=F,c=G(e),u={browserDetails:c,commonShim:a,extractVersion:$,disableLog:H,disableWarnings:q};switch(c.browser){case"chrome":if(!i||!ie||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),u;n("adapter.js shimming chrome."),u.browserShim=i,Y(e),J(e),ie(e),Z(e),ne(e),X(e),Q(e),ee(e),re(e),ke(e),Oe(e),De(e),xe(e),Pe(e);break;case"firefox":if(!s||!fe||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),u;n("adapter.js shimming firefox."),u.browserShim=s,de(e),fe(e),pe(e),ve(e),me(e),ge(e),Te(e),ke(e),Oe(e),De(e),xe(e);break;case"edge":if(!r||!ue||!t.shimEdge)return n("MS edge shim is not included in this adapter release."),u;n("adapter.js shimming edge."),u.browserShim=r,ae(e),ce(e),ue(e),he(e),De(e),xe(e);break;case"safari":if(!o||!t.shimSafari)return n("Safari shim is not included in this adapter release."),u;n("adapter.js shimming safari."),u.browserShim=o,_e(e),we(e),be(e),ye(e),Se(e),Re(e),Ce(e),ke(e),De(e),xe(e),Pe(e);break;default:n("Unsupported browser!")}return u}({window:window}),$e=n(15),Le=n.n($e),He=n(9),qe=n.n(He),Fe=function(){function e(){l()(this,e),this.onChange=this.onChange.bind(this),this.hasSupport=Boolean(qe.a.isEnabled)}return f()(e,[{key:"toggle",value:function(){return this.isFullscreen()?qe.a.exit():qe.a.request()}},{key:"canFullscreen",value:function(){return this.hasSupport}},{key:"isFullscreen",value:function(){return this.hasSupport&&qe.a.isFullscreen}},{key:"onChange",value:function(e){var t=this;this.hasSupport&&qe.a.on("change",function(){return e(t.isFullscreen())})}},{key:"off",value:function(){this.hasSupport&&qe.a.off("change")}}]),e}(),je={environment:function(){return{canMix:this.canMix(),canPip:this.hasPipSupport(),canSFU:this.canSFU(),isPhone:this.isPhone(),inIframe:this.inIframe(),canUseEyeson:this.canUseEyeson(),canFullscreen:this.canFullscreen(),hasMobileDevice:this.hasMobileDevice(),canToggleCamera:this.canToggleCamera(),canPresentFiles:this.canPresentFiles(),canScreenCapture:this.canScreenCapture(),canAdjustSettings:this.canAdjustDeviceSettings(),isExperimentalBrowser:this.isExperimentalBrowser()}},platform:function(){return Le.a},canUseEyeson:function(){return!this.isWebView()&&this.hasGetUserMedia()&&this.hasPeerConnection()&&this.isRecentBrowser()},hasGetUserMedia:function(){return"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices},hasGetDisplayMedia:function(){return"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices},hasPeerConnection:function(){return"RTCPeerConnection"in window},isRecentBrowser:function(){return this.isChrome()?this.isRecentChrome():this.isFF()?this.isRecentFF():this.isEdge()?this.isRecentEdge():!!this.isSafari()&&this.isRecentSafari()},hasCaptureStream:function(){return"captureStream"in window.HTMLMediaElement.prototype||"mozCaptureStream"in window.HTMLMediaElement.prototype},hasCanvasCaptureSupport:function(){return"CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window},hasSenders:function(){return"RTCRtpSender"in window},hasTrackOnUnmute:function(){return!this.isSafari()&&!this.isEdge()&&"onunmute"in MediaStreamTrack.prototype},hasWebpSupport:function(){return!!this.isRecentChrome()||(this.isFF()?Me.browserDetails.version>=65:!!this.isEdge())},canChangeAudioOutput:function(){return"setSinkId"in document.createElement("video")},canChangeMicrophone:function(){return"safari"!==Me.browserDetails.browser&&!this.isTestSuite()},canChangeCamera:function(){return!this.isIOSDevice()&&!this.isTestSuite()},canScreenCapture:function(){return!(this.isTestSuite()||!this.canUseEyeson()||this.isEdge())&&(this.hasGetDisplayMedia()||this.isFF()&&this.hasGetUserMedia())},canPresentFiles:function(){return!(this.isTestSuite()||!this.canUseEyeson()||this.isEdge()||this.isFF()&&Me.browserDetails.version<=60||this.isIOSDevice())},requiresLowerConstraints:function(){return"safari"===Me.browserDetails.browser},browserName:function(){return Me.browserDetails.browser.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},browserVersion:function(){return Me.browserDetails.version},isEdge:function(){return"edge"===Me.browserDetails.browser},isFF:function(){return"firefox"===Me.browserDetails.browser},isChrome:function(){return"chrome"===Me.browserDetails.browser},isSafari:function(){return"safari"===Me.browserDetails.browser},isRecentEdge:function(){return!!this.isEdge()&&Me.browserDetails.version>15e3},isRecentFF:function(){return!!this.isFF()&&Me.browserDetails.version>=52},isRecentChrome:function(){return!!this.isChrome()&&Me.browserDetails.version>=70},isRecentSafari:function(){return!!this.isSafari()&&Me.browserDetails.version>=10},isExperimentalBrowser:function(){return["safari","edge"].includes(Me.browserDetails.browser)},hasPipSupport:function(){var e=document.createElement("video"),t=Boolean(e.webkitSupportsPresentationMode||"pictureInPictureEnabled"in document);return e.remove&&e.remove(),t&&!this.isIOSDevice()},isAndroidDevice:function(){return Boolean(navigator.userAgent.match(/Android/i))},isIOSDevice:function(){return Boolean(navigator.userAgent.match(/iPhone|iPad|iPod/i))},isIPhone:function(){return Boolean(navigator.userAgent.match(/iPhone/i))},isAndroidPhone:function(){var e=/(android)/i.test(navigator.userAgent),t=/(mobile)/i.test(navigator.userAgent);return e&&t},inIframe:function(){try{return window.self!==window.top}catch(e){return!0}},isPhone:function(){return this.isIPhone()||this.isAndroidPhone()},hasMobileDevice:function(){return this.isIOSDevice()||this.isAndroidDevice()},isTouchDevice:function(){return Boolean("ontouchstart"in window||navigator.maxTouchPoints)},canLiveStreamToFacebook:function(){return!this.isIOSDevice()&&!this.isEdge()&&!this.isTestSuite()},canDisplayTooltips:function(){return!this.isIOSDevice()&&!this.isTestSuite()},canAdjustDeviceSettings:function(){return!this.isIOSDevice()},canToggleCamera:function(){return!this.isIOSDevice()},canMix:function(){return this.isChrome()&&this.canScreenCapture()&&this.hasCaptureStream()},stopsDeviceActivityIndicatorOnDisable:function(){return!!this.isFF()},supportsBlurOnSVG:function(){return"undefined"!=typeof SVGElement&&void 0!==SVGElement.prototype.blur},hasLocalStorage:function(){try{var e="object"===h()(window.localStorage)&&null!==window.localStorage;window.localStorage.setItem("eyeson.test","test");var t="test"===window.localStorage.getItem("eyeson.test");return e&&t}catch(e){return m.debug("FeatureDetector::hasLocalStorage:",e.message),!1}},canFullscreen:function(){return(new Fe).canFullscreen()},isFullscreen:function(){return(new Fe).isFullscreen()},canSFU:function(){var e=this.isSafari()&&Me.browserDetails.version<=605;return!this.isEdge()&&!e&&!this.isTestSuite()},canShare:function(){return Boolean(navigator.share)},isWebView:function(){return/Version\/|wv/i.test(navigator.userAgent)&&this.isAndroidDevice()},isTestSuite:function(){return"test-suite"===Me.browserDetails.browser}},Ge=n(8),Be=n.n(Ge),We=n(10),Ve=n.n(We),Ke=n(5),Ye=n.n(Ke),ze=function(){function e(){l()(this,e),this._stream=this.createStream()}return f()(e,[{key:"createStream",value:function(){var e=Object.assign(document.createElement("canvas"),{width:0,height:0});return e.id="eyeson-ninja-stream",e.getContext("2d").fillRect(0,0,0,0),e.captureStream()}},{key:"stream",get:function(){return this._stream}}]),e}(),Je=(Ne={},Ue=je.hasLocalStorage(),{store:function(e,t){Ue?window.localStorage.setItem("eyeson."+e,JSON.stringify(t)):Ne[e]=t},load:function(e,t){var n=t;if("object"!==h()(n)||Array.isArray(n)||(n=Object.assign({},n)),!Ue)return Ne[e]||n;var i=window.localStorage.getItem("eyeson."+e);return i?JSON.parse(i):n}}),Ze=window.CanvasCaptureMediaStream||window.CanvasCaptureMediaStreamTrack,Xe=function(e){return Boolean(e&&e.getAudioTracks().length>0&&e.getAudioTracks()[0].enabled)},Qe=function(e){return Boolean(e&&e.getVideoTracks().length>0&&e.getVideoTracks()[0].enabled)},et=function(e){return e.getAudioTracks().forEach(function(e){return e.enabled=!1}),e},tt=function(e){return e.getAudioTracks().forEach(function(e){return e.enabled=!0}),e},nt=function(e){return e.stop(),e.dispatchEvent(new Event("stopped"))},it=function(e){e.getTracks().forEach(nt)},rt=function(e){return/screen|monitor|window|web-contents-media-stream/i.test(e.label)||"screen-track"===e.type},st=function(e){return Boolean(("canvas-track"===e.type||e instanceof Ze)&&e.canvas&&"eyeson-ninja-stream"!==e.canvas.id)},ot=function(e){return!st(e)&&!rt(e)},at=function(e){return e.getVideoTracks().filter(rt)},ct=function(e){return e.getVideoTracks().filter(ot)},ut=function(e){ct(e).forEach(nt)},ht=function(e){return ct(e).forEach(function(e){return e.enabled=!1}),e},dt=function(e){return ct(e).forEach(function(e){return e.enabled=!0}),e},lt=function(e,t){return ct(e).forEach(function(e){return e.enabled=t}),e},pt=function(e){return e instanceof Ze?e.getVideoTracks():e.getVideoTracks().filter(st)},ft=function(e){return Qe(e)&&e.getVideoTracks().some(rt)},mt=function(e){return!!je.hasCanvasCaptureSupport()&&e.getVideoTracks().some(st)},gt=function(e){return Qe(e)&&!ft(e)&&!mt(e)},vt=function(e){return!!e&&(mt(e)&&e.getVideoTracks().some(st))},Tt=function(e){return ft(e)||mt(e)},yt=function(e){return ct(e).some(function(e){return e.enabled})},St=function(e){e.getContext("2d");var t=e.captureStream(30),n=t.getVideoTracks(),i=Ye()(n,1)[0];return"requestFrame"in i||(i.type="canvas-track",i.canvas=e,i.requestFrame=function(){return t.requestFrame()}),t},bt=function(){function e(t){var n=this;l()(this,e),this.sinkId="default",this.options=t||{audio:!0,video:!0,eco:!1},this.stream=null,this.cameras=[],this.listeners=[],this.speakers=[],this.microphones=[],this.constraints={},this.terminationInProgress=!1,e.getSinkId().then(function(e){return n.sinkId=e}),this.setStream=this.setStream.bind(this),this.handleError=this.handleError.bind(this),this.verifyStream=this.verifyStream.bind(this),this.storeConstraints=this.storeConstraints.bind(this),this.adjustAudioTrack=this.adjustAudioTrack.bind(this)}return f()(e,[{key:"start",value:function(){var t=this;return this.watchForNewDevices(),e.fetchDevices().then(function(e){return t.cameras=e.cameras,t.microphones=e.microphones,t.speakers=e.speakers,t.options.audio=t.microphones.length>0&&t.options.audio,t.options.video=t.cameras.length>0&&t.options.video,t.options.eco=t.options.eco,t.emit(e),e}).then(function(){return e.getConstraints(t.options)}).then(function(e){return t.constraints=e,navigator.mediaDevices.getUserMedia({video:!t.options.eco&&t.constraints.video,audio:t.constraints.audio||!0})}).then(this.adjustAudioTrack).then(this.setStream).catch(this.handleError)}},{key:"stopStream",value:function(){this.stream&&(it(this.stream),this.stream=null)}},{key:"stop",value:function(){this.stopStream()}},{key:"terminate",value:function(){var e=this;this.terminationInProgress=!0,window.setTimeout(function(){return e.stop()},10)}},{key:"watchForNewDevices",value:function(){var t=this;navigator.mediaDevices.ondevicechange=function(){e.fetchDevices().then(function(e){return t.emit(e)}).catch(t.handleError)}}},{key:"onChange",value:function(e){this.listeners.push(e)}},{key:"removeListener",value:function(e){this.listeners=this.listeners.filter(function(t){return t!==e})}},{key:"update",value:function(e){this.constraints=e||this.constraints,this.stop(),navigator.mediaDevices.getUserMedia(this.constraints).then(this.setStream).catch(this.handleError)}},{key:"updateWithOptions",value:function(t){var n=this;return this.options=t||this.options,this.stop(),this.watchForNewDevices(),e.getConstraints(this.options).then(function(e){return n.constraints=e,navigator.mediaDevices.getUserMedia({video:!n.options.eco&&n.constraints.video,audio:n.constraints.audio||!0})}).then(this.adjustAudioTrack).then(this.setStream).catch(this.handleError)}},{key:"adjustAudioTrack",value:function(e){return 1===e.getAudioTracks().length&&(e.getAudioTracks()[0].enabled=this.options.audio),e}},{key:"storeConstraints",value:function(){m.debug("DeviceManager::storeConstraints",this.constraints),Je.store("mediaConstraints",this.constraints),Je.store("sinkId",this.sinkId)}},{key:"setStream",value:function(e){this.stream=e,this.terminationInProgress&&this.stop(),this.emit({stream:this.stream,constraints:this.constraints,options:this.options}),this.verifyStream()}},{key:"verifyStream",value:function(){this.constraints.video&&this.stream&&0===this.stream.getVideoTracks().length&&!this.options.eco&&this.handleError({name:"EyesonCameraError"}),this.constraints.audio&&this.stream&&0===this.stream.getAudioTracks().length&&this.handleError({name:"EyesonMicrophoneError"})}},{key:"setVideoInput",value:function(e){var t={};Object.assign(t,this.constraints.video,{deviceId:{exact:e}}),this.constraints.video=t,this.update()}},{key:"setAudioInput",value:function(e){var t={};Object.assign(t,this.constraints.audio,{deviceId:{exact:e}}),this.constraints.audio=t,this.update()}},{key:"setAudioOutput",value:function(e){this.sinkId=e,Je.store("sinkId",this.sinkId),this.emit({sinkId:this.sinkId})}},{key:"handleError",value:function(e){m.error("DeviceManager::",e),this.emit({error:e,constraints:this.constraints})}},{key:"emit",value:function(e){this.listeners.forEach(function(t){return t(e)})}}],[{key:"getDevices",value:function(){return"mediaDevices"in navigator?navigator.mediaDevices.enumerateDevices():new Promise(function(e){return e([])})}},{key:"getConstraints",value:function(t){var n=t||{audio:!0,video:!0};return e.getDevices().then(function(t){return e.determineConstraintsForDevices(t,n)}).catch(function(e){m.error("DeviceManager::getConstraints ",e)})}},{key:"determineConstraintsForDevices",value:function(e,t){var n=Je.load("mediaConstraints",t);if("video"in n||(n.video=!0),"audio"in n||(n.audio=!0),n.video.deviceId){var i=n.video.deviceId.exact;e.find(function(e){return e.deviceId===i})||(n.video=t.video)}if(n.audio.deviceId){var r=n.audio.deviceId.exact;e.find(function(e){return e.deviceId===r})||(n.audio=t.audio)}return!1!==t.video||t.eco||(n.video=!1),!0===t.video&&!1===n.video&&(n.video=!0),!0===t.audio&&!1===n.audio&&(n.audio=!0),0===e.filter(function(e){return"videoinput"===e.kind}).length&&(n.video=!1),n}},{key:"getMobileConstraints",value:function(e){var t=Object.assign({audio:!0,video:!0},e);return new Promise(function(e){return e(t)})}},{key:"getSinkId",value:function(){var t=Je.load("sinkId","");return e.getDevices().then(function(e){return e.find(function(e){return e.deviceId===t})||(t="default"),t})}},{key:"fetchDevices",value:function(){return e.getDevices().then(function(e){return{cameras:e.filter(function(e){return"videoinput"===e.kind}),microphones:e.filter(function(e){return"audioinput"===e.kind}),speakers:e.filter(function(e){return"audiooutput"===e.kind})}})}},{key:"fetchInputDevices",value:function(){return e.getDevices().then(function(e){return e.filter(function(e){return e.kind.includes("input")})})}}]),e}(),Ct=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{eco:!1,audio:!0,video:!0,screen:!1,screenStream:null,canvas:null,existingStream:null};l()(this,e),this.options=t,this.getMediaStream=this.getMediaStream.bind(this),this.addNinjaTrack=this.addNinjaTrack.bind(this),this.addCanvasTrack=this.addCanvasTrack.bind(this),this.addScreenTrack=this.addScreenTrack.bind(this),this.adjustAudioTrack=this.adjustAudioTrack.bind(this),this.adjustVideoTrack=this.adjustVideoTrack.bind(this),this.addScreenStreamTrack=this.addScreenStreamTrack.bind(this)}var t;return f()(e,[{key:"start",value:function(){m.debug("MediaStreamBuilder::start",this.options);var e=this.options,t=e.existingStream,n=e.video,i=e.screen;return je.isIOSDevice()&&t?new Promise(function(e,i){try{t.getVideoTracks()[0].enabled=n,e(t)}catch(e){i(e)}}):je.isSafari()&&i?navigator.mediaDevices.getDisplayMedia({video:!0}).then(function(e){return navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){return e.addTrack(t.getAudioTracks()[0],e),e})}).then(this.adjustAudioTrack).then(function(e){var t=e.getVideoTracks();return Ye()(t,1)[0].type="screen-track",e}):bt.fetchInputDevices().then(this.getMediaStream).then(this.adjustVideoTrack).then(this.adjustAudioTrack).then(this.addCanvasTrack).then(this.addScreenTrack).then(this.addNinjaTrack).catch(function(e){return m.error("MediaStreamBuilder::start ",e,e.message),Promise.reject(e)})}},{key:"getMediaStream",value:function(e){if(0===e.length)return this.options={audio:!1,video:!1},(new ze).stream;var t=this.options,n=t.eco,i=t.video,r=t.existingStream,s={video:!je.hasCaptureStream()&&!n||i,audio:!0};return je.isPhone()&&r?(ut(r),bt.getMobileConstraints(s).then(navigator.mediaDevices.getUserMedia)):bt.getConstraints(s).then(function(e){return navigator.mediaDevices.getUserMedia(e)})}},{key:"adjustVideoTrack",value:function(e){if(1===e.getVideoTracks().length){var t=e.getVideoTracks(),n=Ye()(t,1)[0];n.enabled=this.options.video,!1===this.options.video&&nt(n)}return e}},{key:"adjustAudioTrack",value:function(e){return 1===e.getAudioTracks().length&&(e.getAudioTracks()[0].enabled=this.options.audio),e}},{key:"addCanvasTrack",value:function(e){var t=this.options,n=t.canvas,i=t.existingStream;if(n){var r=St(n),s=pt(r),o=Ye()(s,1)[0];e.addTrack(o,e)}if(vt(i)){var a=pt(i),c=Ye()(a,1)[0];e.addTrack(c,e)}return e}},{key:"addScreenTrack",value:(t=Ve()(Be.a.mark(function e(t){var n,i,r,s,o,a,c,u;return Be.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.options,i=n.screen,r=n.screenStream,s=n.existingStream,!i){e.next=10;break}if(null!==r){e.next=9;break}return e.next=5,this.getDisplayMedia();case 5:o=e.sent,this.addScreenStreamTrack(t,o),e.next=10;break;case 9:this.addScreenStreamTrack(t,r);case 10:return ft(s)&&(a=at(s),c=Ye()(a,1),u=c[0],t.addTrack(u,t)),e.abrupt("return",t);case 12:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"addScreenStreamTrack",value:function(e,t){var n=t.getVideoTracks(),i=Ye()(n,1)[0];i.type="screen-track",e.addTrack(i,e)}},{key:"getDisplayMedia",value:function(){return je.hasGetDisplayMedia()?navigator.mediaDevices.getDisplayMedia({video:{width:{max:1920},height:{max:1080},frameRate:{max:15}}}):navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen",width:{max:1920},height:{max:1040},frameRate:{max:15}}})}},{key:"addNinjaTrack",value:function(e){var t=this.options,n=t.eco,i=t.video;if(n||!je.hasCaptureStream())return e;if(0===e.getVideoTracks().length){var r=(new ze).stream.getVideoTracks(),s=Ye()(r,1)[0];s.enabled=i,e.addTrack(s,e)}return e}}]),e}(),Et=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.audio,n=e.video;m.debug("ChangeLocalStreamEvent::handle");var i=this.context._session;if(je.isIOSDevice()){var r=function(e,t,n){return e.getAudioTracks().forEach(function(e){return e.enabled=t}),e.getVideoTracks().forEach(function(e){return e.enabled=n}),e.locallyChanged=!0,e}(i.localStream,t,n);i.emit({type:"stream_update",localStream:r})}else new Ct({audio:t,video:n,existingStream:i.localStream}).start().then(function(e){e.locallyChanged=!0,i.setStream(e)}).catch(m.error)}}]),t}(_),_t=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){if(this.context._session){m.debug("PodiumEvent::handle",e);var t=this.context._session,n=t.localStream;!e.hasPresenter&&Tt(n)&&t.emit({type:"stop_presenting"}),t&&this.scanMessageForLocalStreamOptimization(n,e),new N(this.context).handle(e)}}},{key:"scanMessageForLocalStreamOptimization",value:function(e,t){var n=t.media,i=t.video,r=t.isSource,s=t.isPresenter,o=t.hasDesktopSources;e&&(je.isFF()||(!n&&r&&(!i&&gt(e)||i&&!Qe(e)&&e.locallyChanged)&&new Et(this.context).handle({audio:Xe(e),video:i}),i&&!s&&o&&new Et(this.context).handle({audio:Xe(e),video:!1})))}}]),t}(_),Rt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){this.context._api.takeSnapshot()}}]),t}(_),wt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.setLayer(e.params)}}]),t}(_),At=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._session.send({type:"chat",content:e.content})}}]),t}(_),It=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.setLayout(e.params)}}]),t}(_),kt=n(16),Dt=n.n(kt),xt=["chat","recording","memberlist","source_update","voice_activity","stream_offer"],Ot=function(){function e(t,n){l()(this,e);var i=t.src,r=void 0===i?[]:i,s=t.psrc,o=t.asrc,a=t.vsrc,c=t.dsrc;this.sources=r,this.presenterIdx=s,this.audioSources=o,this.videoSources=a,this.desktopSources=c,this.userId=n,this.userSourceIndex=this.sources.indexOf(this.userId)}return f()(e,[{key:"isSolo",get:function(){return 1===Array.from(new Set(this.sources)).length&&this.sources[0]===this.userId}},{key:"isSource",get:function(){return this.sources.includes(this.userId)}},{key:"isPresenter",get:function(){return this.hasPresenter&&this.presenter===this.userId}},{key:"presenter",get:function(){return this.hasPresenter&&this.sources[this.presenterIdx]}},{key:"hasMedia",get:function(){return this.sources.some(function(e){return/media/.test(e)})}},{key:"hasPresenter",get:function(){return!isNaN(this.presenterIdx)}},{key:"hasVideoSources",get:function(){return Boolean(this.videoSources)}},{key:"hasDesktopSources",get:function(){return!isNaN(parseInt(this.desktopSources,10))}},{key:"hasAudioPosition",get:function(){return this.audioSources.includes(this.userSourceIndex)}},{key:"hasVideoPosition",get:function(){return this.videoSources.includes(this.userSourceIndex)}},{key:"hasMutedVideoPeers",get:function(){var e=this;return!this.hasDesktopSources&&0===this.videoSources.filter(function(t){return t!==e.userSourceIndex}).length}}]),e}(),Pt=function(){function e(t,n){l()(this,e),this.opts=Object.assign({},this.defaultOptions,n),this.user=t,this.debug=this.debug.bind(this),this.stamp=this.stamp.bind(this),this.default=this.default.bind(this),this.process=this.process.bind(this),this.sourceUpdate=this.sourceUpdate.bind(this),this.voiceActivity=this.voiceActivity.bind(this)}return f()(e,[{key:"debug",value:function(){if(this.opts.debug){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];m.debug(t)}}},{key:"stamp",value:function(e){return Object.assign({_src:"sip"},e)}},{key:"process",value:function(e){return({source_update:this.sourceUpdate,voice_activity:this.voiceActivity}[e.type]||this.default)(this.stamp(e))}},{key:"default",value:function(e){return this.debug("SipMessageTransformer::default",e),e}},{key:"sourceUpdate",value:function(e){this.debug("SipMessageTransformer::sourceUpdate",e);var t=new Ot(e,this.user.uri);return Object.assign({type:"podium",solo:t.isSolo,audio:t.hasAudioPosition,video:t.hasVideoPosition,media:t.hasMedia,sources:t.sources,isSource:t.isSource,presenter:t.presenter,isPresenter:t.isPresenter,hasPresenter:t.hasPresenter,videoSources:t.videoSources,hasVideoSources:t.hasVideoSources,hasDesktopSources:t.hasDesktopSources,hasMutedVideoPeers:t.hasMutedVideoPeers})}},{key:"voiceActivity",value:function(e){return this.debug("SipMessageTransformer::voiceActivity",e),Object.assign({type:"voice_activity_raw",on:e.on,userId:e.cid.split("@").shift()})}},{key:"defaultOptions",get:function(){return{debug:!0}}}]),e}(),Nt=function(){function e(t,n){l()(this,e),this.options=n||{},this.session=t,this.connection=t.passedOptions.sessionDescriptionHandlerOptions.connection,this.CONTENT_TYPE="application/sdp",this.initPeerConnection()}return f()(e,[{key:"getDescription",value:function(e,t){var n=this;return m.debug("SessionDescriptionHandler::getDescription:",e,t),this.localStream=e.stream,this.localStream.getTracks().forEach(function(e){n.peerConnection.addTrack(e,n.localStream)}),this.createOfferOrAnswer(e.RTCConstraints,t).then(function(e){return{body:e,contentType:n.CONTENT_TYPE}})}},{key:"setDescription",value:function(e,t,n){var i=this;m.debug("SessionDescriptionHandler::setDescription:",e,t,n);var r=new RTCSessionDescription({type:this.hasOffer("local")?"answer":"offer",sdp:e});return this.peerConnection.setRemoteDescription(r).then(function(){i.session.passedOptions.sessionDescriptionHandlerOptions.remoteDescriptionUpdate(r)})}},{key:"hasDescription",value:function(e){return m.debug("SessionDescriptionHandler::hasDescription:",e),e===this.CONTENT_TYPE}},{key:"getDirection",value:function(){m.warn("SessionDescriptionHandler::getDirection: NOT IMPLEMENTED")}},{key:"holdModifier",value:function(e){m.warn("SessionDescriptionHandler::holdModifier: NOT IMPLEMENTED.",e)}},{key:"close",value:function(){m.debug("SessionDescriptionHandler::close"),this.peerConnectionClosed()||(this.stopAllTracks(),this.peerConnection.close(),clearTimeout(this.iceCheckingTimeout),m.debug("SessionDescriptionHandler::close Stopped streams and closed peerConnection."))}},{key:"initPeerConnection",value:function(){var e=this,t=this.buildPeerConnectionOptions();m.debug("SessionDescriptionHandler::initPeerConnection with: ",t),this.onIceCompleted=new Promise(function(t,n){e.resolveIceCompleted=t,e.rejectIceCompleted=n});try{this.peerConnection=new RTCPeerConnection(t),this.peerConnection.ontrack=this.handleOntrack.bind(this),this.peerConnection.onicecandidate=this.gotIceCandidate.bind(this),this.peerConnection.onnegotiationneeded=this.handleNegotiation.bind(this),this.startIceCheckingTimer(t.iceCheckingTimeout)}catch(e){m.error("SessionDescriptionHandler::initPeerConnection failed:",e,this.connection.user)}}},{key:"peerConnectionClosed",value:function(){return Boolean(this.peerConnection&&"closed"===this.peerConnection.signalingState)}},{key:"handleOntrack",value:function(e){var t=this,n=Ye()(e.streams,1);this.remoteStream=n[0],m.debug("SessionDescriptionHandler::handleOntrack: ",e.track.kind),e.track.onunmute=function(){t.session.passedOptions.sessionDescriptionHandlerOptions.handleUnmute(e.track)},this.session.passedOptions.sessionDescriptionHandlerOptions.handleAccept(this.remoteStream)}},{key:"startIceCheckingTimer",value:function(e){var t=this;this.iceCheckingTimer=setTimeout(function(){m.debug("iceCheckingTimeout triggered after: "+e+" milliseconds"),t.resolveIceCompleted()},e)}},{key:"gotIceCandidate",value:function(e){var t=e.candidate;return t?"relay"===t.type&&"video"===t.sdpMid?(m.debug("SessionDescriptionHandler::gotIceCandidate: ".concat(t,".\n                   Relay candidate found, onIceCompleted.")),void this.resolveIceCompleted()):void m.debug("SessionDescriptionHandler::gotIceCandidate: ".concat(t)):(m.debug("SessionDescriptionHandler::gotIceCandidate: no candidates left, onIceCompleted."),void this.resolveIceCompleted())}},{key:"buildPeerConnectionOptions",value:function(){var e=Object.assign({},this.connection.user);return e.stunServers={urls:e.stunServers},e.turnServers=e.turnServers.map(function(e){if(je.isEdge()){var t=e.urls.find(function(e){return!e.match(/transport/)});e.urls.push(t+"?transport=udp")}return e.credential=e.password,e}),Object.assign({},this.options.peerConnectionOptions,{sdpSemantics:"unified-plan",iceServers:e.turnServers.concat(e.stunServers)})}},{key:"createOfferOrAnswer",value:function(e,t){var n=this;m.debug("SessionDescriptionHandler::createOfferOrAnswer: ",e,t);var i=e||{},r=t||[],s=this.hasOffer("remote")?"createAnswer":"createOffer";return this.peerConnection[s](i).then(function(e){return n.peerConnection.setLocalDescription(e)}).then(function(){return n.onIceCompleted}).then(function(){var e=n.peerConnection.localDescription.sdp;try{r.forEach(function(t){e=t(e)})}catch(t){m.error("sdpModifier failed: ",t,e)}return e}).catch(function(e){m.error("createOfferOrAnswer:",e)})}},{key:"hasOffer",value:function(e){return this.peerConnection.signalingState==="have-".concat(e,"-offer")}},{key:"getLocalStream",value:function(){return this.localStream}},{key:"getRemoteStream",value:function(){return this.remoteStream}},{key:"setStream",value:function(e){var t=this;return new Promise(function(n,i){var r=t.getLocalStream();t.localStream=e,t.stopUnusedTracks(r,e);var s=e.getAudioTracks(),o=Ye()(s,1)[0],a=vt(e)?pt(e):e.getVideoTracks(),c=Ye()(a,1)[0];t.tracksExist()||n({newStream:e,remoteStream:t.remoteStream});var u=t.peerConnection.getSenders().find(function(e){return"audio"===e.track.kind}),h=t.peerConnection.getSenders().find(function(e){return"video"===e.track.kind});u.replaceTrack(o).then(function(){return h.replaceTrack(c)}).then(function(){n({newStream:e,remoteStream:t.remoteStream})}).catch(i)})}},{key:"stopUnusedTracks",value:function(e,t){e.getTracks().filter(function(e){return!t.getTracks().includes(e)}).forEach(nt)}},{key:"tracksExist",value:function(){return this.peerConnection.getSenders().find(function(e){return null!==e.track})>0}},{key:"handleNegotiation",value:function(){m.debug("SessionDescriptionHandler::handleNegotiation")}},{key:"stopAllTracks",value:function(){m.debug("SessionDescriptionHandler::stopAllTracks");var e=this.peerConnection.getReceivers?this.peerConnection.getReceivers():[];this.peerConnection.getSenders().concat(e).forEach(function(e){e.track&&nt(e.track)})}}]),e}(),Ut={peerConnectionOptions:{iceCheckingTimeout:3e3}},Mt=function(){function e(t,n){l()(this,e),this.user=t,this._room=n,this.user.sessionDescriptionHandlerFactoryOptions=Ut,this.user.sessionDescriptionHandlerFactory=function(e,t){return new Nt(e,t)};var i=this.adjustUserAgentOptions(this.user);this.userAgent=new Dt.a.UA(i),this.transformer=new Pt(this.user),this.start=this.start.bind(this)}return f()(e,[{key:"adjustUserAgentOptions",value:function(e){return e.autostart=!1,e.transportOptions={wsServers:[e.wsServers],traceSip:!0},e}},{key:"start",value:function(){var e=this;return new Promise(function(t,n){e.userAgent.once("transportCreated",function(e){e.on("transportError",function(){n(new Error("SipTransportError"))}),e.on("connected",function(){return t()})}),e.userAgent.start()})}},{key:"startSession",value:function(e,t){return this.userAgent.invite(this._room.uri,e,t)}},{key:"close",value:function(){this.userAgent&&(this.userAgent.removeAllListeners("message"),this.userAgent.unregister(),this.userAgent=null)}},{key:"onMessage",value:function(e){var t=this;this.userAgent.on("message",function(n){m.debug("SipConnection::onMessage",n);var i=JSON.parse(n.body);if(xt.includes(i.type)){var r=t.transformer.process(i);e(r)}else m.debug('SipConnection::onMessage ignoring "'.concat(i.type,'" message.'))})}},{key:"send",value:function(e){e.cid=this.user.uri,this.userAgent&&this.userAgent.message(this._room.uri,JSON.stringify(e))}}]),e}(),$t=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){if(I()(b()(t.prototype),"handle",this).call(this,e),this.context.rtData=e.content,!0===e.content.ready){var n=e.content,i=n.user,r=n.room,s=n.links;this.context._eyeson.room=r,this.context._eyeson.user=this.context._api.addUserAttributes(i,i.id),this.context._eyeson.links=s,function(e,t,n){e.connection=new Mt(t.sip,n.sip),e._connection.start().then(function(){return e.send({type:"connection",connectionStatus:"ready"})}).catch(function(){return e.send({type:"connection",connectionStatus:"transport_error"})})}(this.context,i,r)}else m.debug("RoomReceived not ready:",e.content)}}]),t}(k),Lt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){var e=this;this.context._api.getRoom(function(n){return I()(b()(t.prototype),"handle",e).call(e,{type:"fetch_room",room:n})})}}]),t}(k),Ht=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.deleteFile(e.file)}}]),t}(_),qt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.uploadFile(e.file,this.addFile.bind(this))}},{key:"addFile",value:function(e){I()(b()(t.prototype),"handle",this).call(this,{type:"add_file",file:e})}}]),t}(k),Ft=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.cid.split("@").shift();this.msg=e,this.context._api.getUser(t,this.forwardMessage.bind(this))}},{key:"forwardMessage",value:function(e){var n=Date.parse(this.msg.ts||this.msg.created_at);I()(b()(t.prototype),"handle",this).call(this,{type:this.msg.type,user:e,timestamp:new Date(n),content:this.msg.content})}}]),t}(k),jt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var n=this;this.context._api.stopBroadcast("youtube").then(function(){return I()(b()(t.prototype),"handle",n).call(n,{type:e.type})}).catch(function(e){return m.warn(e)})}}]),t}(k),Gt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.audio,n=void 0===t||t,i=e.video,r=void 0===i||i;m.debug("StartStreamEvent::handle audio: ".concat(n," video: ").concat(r));var s=this.context._session;new Ct({audio:n,video:r}).start().then(s.setStream).catch(m.error)}}]),t}(_),Bt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.audio,n=void 0===t||t,i=e.video,r=void 0===i||i;m.debug("ChangeStreamEvent::handle audio: ".concat(n," video: ").concat(r));var s=this.context._session;return new Promise(function(e,t){if(je.stopsDeviceActivityIndicatorOnDisable())return lt(s.localStream,r),void e(s.localStream);new Ct({audio:n,video:r,existingStream:s.localStream}).start().then(e).catch(t)}).then(s.setStream).then(function(e){vt(e)?s.canvasMixer.setStream(e):s.send({type:"mute_video",on:!r})}).catch(m.errror)}}]),t}(_),Wt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.facingMode;m.debug("ToggleCameraEvent::handle",t);var n=this.context._session;new Ct({audio:n.localStream.getAudioTracks()[0].enabled,video:{facingMode:t},existingStream:n.localStream}).start().then(n.setStream)}}]),t}(_),Vt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=this.context,n=t._api,i=t._session;n.startBroadcast(e,"youtube").catch(function(e){return i.emit({type:"start_broadcast_error",platform:"youtube",error:e})})}}]),t}(_),Kt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var n=this;this.context._api.stopBroadcast("facebook").then(function(){return I()(b()(t.prototype),"handle",n).call(n,{type:e.type})}).catch(function(e){return m.warn(e)})}}]),t}(k),Yt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var n=e.type,i=e.session.sessionDescriptionHandler,r=i.getLocalStream();I()(b()(t.prototype),"handle",this).call(this,{type:n,localStream:r,remoteStream:i.getRemoteStream()}),this.context._connection.send({type:"mute_video",on:!Qe(r)})}}]),t}(k),zt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=this.context,n=t._api,i=t._session;n.startBroadcast(e,"facebook").catch(function(e){return i.emit({type:"start_broadcast_error",platform:"facebook",error:e})})}}]),t}(_),Jt=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.stopRecording(e)}}]),t}(k),Zt=n(12),Xt=n.n(Zt),Qt=function(e){function t(e){var n;return l()(this,t),(n=y()(this,b()(t).call(this,e))).getUser=n.getUser.bind(Xt()(n)),n}return E()(t,e),f()(t,[{key:"getUser",value:function(e){var t=this;return new Promise(function(n,i){try{t.context._api.getUser(e,n)}catch(e){i(e)}})}},{key:"handle",value:function(e){var t=this;this.getUser(e.userId).then(function(n){t.context.send({type:"voice_activity",user:n,on:e.on})})}}]),t}(_),en=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=this.context,n=t._api,i=t._session;n.startRecording(e).catch(function(e){return i.emit({type:"recording_error",error:e})})}}]),t}(k),tn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.audio,n=e.screen,i=void 0!==n&&n,r=e.screenStream,s=this.context._session;new Ct({audio:t,video:!1,screen:i,screenStream:r,existingStream:s.localStream}).start().then(function(e){var t=at(e),n=Ye()(t,1)[0];return n&&n.addEventListener("ended",function(){s.emit({type:"stop_presenting"}),nt(n)}),e}).then(function(e){s.emit({type:"start_presenting",stream:e})}).catch(function(e){m.error("ScreenCaptureEvent",e),!e.name.match(/notallowed|permission/i)&&i&&s.emit({type:"capture_error",name:"error_".concat(e.name)}),s.emit({type:"stop_presenting"})})}}]),t}(_),nn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}var n;return E()(t,e),f()(t,[{key:"handle",value:(n=Ve()(Be.a.mark(function e(t){var n,i;return Be.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.stream,i=(void 0===n?null:n)||this.context._session.localStream,this.context._session.canvasMixer&&this.context._session.canvasMixer.stream&&(i=this.context._session.canvasMixer.stream),e.next=5,this.context._session.setStream(i);case 5:this.context._session.send({type:"set_presenter",on:!0}),this.context._session.send({type:"desktopstreaming",on:!0}),this.context._session.emit({type:"presentation_started"});case 8:case"end":return e.stop()}},e,this)})),function(e){return n.apply(this,arguments)})}]),t}(_),rn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){this.context._session.canvasMixer&&this.context._session.canvasMixer.stop(),this.context._session.send({type:"desktopstreaming",on:!1}),this.context._session.send({type:"set_presenter",on:!1}),this.context._session.emit({type:"presentation_ended"})}}]),t}(_),sn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var n=this;this.context._api.stopAllBroadcasts().then(function(){return I()(b()(t.prototype),"handle",n).call(n,{type:e.type})})}}]),t}(k),on=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(){this.context._api.clearFrontLayer()}}]),t}(_),an=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){this.context._api.publishBroadcast(e,"facebook")}}]),t}(k),cn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var n=this;return new g(e.api,e.token).requestUser({name:e.name,email:e.email},function(e){e.access_key?I()(b()(t.prototype),"handle",n).call(n,{type:"guest_user",token:e.access_key}):I()(b()(t.prototype),"handle",n).call(n,{type:"error",content:"Request guest user failed"})})}}]),t}(k),un=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){if(this.context._session&&this.context._connection){var t=this.context,n=t._connection,i=t._session,r=i.peerConnection;new Promise(function(t,n){r.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(function(e){return r.createAnswer(e)}).then(function(e){return r.setLocalDescription(e)}).then(function(){return t(r.localDescription)}).catch(n)}).then(function(e){return n.send({type:"stream_answer",sdp:e})}).then(function(){return i.remoteDescriptionUpdate(e.sdp)}).catch(m.error)}else m.warn("HandleStreamOfferEvent::no session or connection.")}}]),t}(k),hn=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=this;m.debug("HandleStreamAnswerEvent: ",e);var n=this.context._session.peerConnection;"stable"!==n.signalingState&&n.setRemoteDescription(new RTCSessionDescription(e.sdp)).then(m.debug("HandleStreamAnswerEvent: set remote description")).then(function(){t.context._session.remoteDescriptionUpdate(e.sdp)}).catch(function(t){return m.warn("HandleStreamAnswerEvent: ",t,e.sdp)})}}]),t}(_),dn=function(e){function t(e){var n;return l()(this,t),(n=y()(this,b()(t).call(this,e))).getUser=n.getUser.bind(Xt()(n)),n}return E()(t,e),f()(t,[{key:"getUser",value:function(e){var t=this;return new Promise(function(n,i){try{t.context._api.getUser(e,n)}catch(e){i(e)}})}},{key:"handle",value:function(e){var t=this;(e.add||[]).forEach(function(e,n,i){var r=e.cid.split("@").shift(),s=Boolean(i.find(function(e){return e.cid===t.context._connection.user.uri}));t.getUser(r).then(function(e){t.context.send({type:"add_user",user:e,initial:s})}).catch(function(e){return m.error(e)})}),(e.del||[]).forEach(function(e){var n=e.split("@").shift();t.getUser(n).then(function(e){t.context.send({type:"remove_user",userId:n,user:e})}).catch(function(e){return m.error(e)})}),this.context.send({type:"playback_update",playing:e.media||[]})}}]),t}(_),ln=function(e){return Number(parseFloat(e).toFixed(2))},pn=function(e,t,n){var i=Math.min(n.width/e,n.height/t);return{width:ln(e*i),height:ln(t*i)}},fn=function(e,t,n){var i;return function(){var r=this,s=arguments,o=function(){i=null,n||e.apply(r,s)},a=n&&!i;clearTimeout(i),i=setTimeout(o,t),a&&e.apply(r,s)}},mn=1e3/15,gn={width:220,height:140},vn={width:320,height:240},Tn={width:420,height:340},yn={width:0,height:0},Sn={getSettings:function(){return{width:0,height:0}},addEventListener:function(){return null}},bn=function(e,t){var n=t.getVideoTracks(),i=Ye()(n,1)[0],r=void 0===i?Sn:i,s=r.getSettings(),o=s.width,a=s.height;return e.setAttribute("controls","true"),e.setAttribute("width",o),e.setAttribute("height",a),e.srcObject=t,r.addEventListener("stopped",function(){return e.srcObject=null}),e.play().catch(function(e){return m.warn("bindVideoToStream: play",e,e.message)}),e},Cn=function(){function e(t,n){l()(this,e),this.canvas=t,this.stream=n,this.context=this.canvas.getContext("2d",{alpha:!1}),this.xPos=0,this.camSize=vn,this.draw=this.draw.bind(this),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this.onError=this.onError.bind(this),this.onRedraw=this.onRedraw.bind(this),this.setStream=this.setStream.bind(this),this.setCamera=this.setCamera.bind(this),this.drawFrame=this.drawFrame.bind(this),this.calcSizesAndPositions=this.calcSizesAndPositions.bind(this),this.bouncedDraw=fn(this.draw,mn)}return f()(e,[{key:"onError",value:function(e){this.errorCallback=e}},{key:"onRedraw",value:function(e){this.redrawCallback=e}},{key:"start",value:function(){this.camera=document.createElement("video"),this.screen=document.createElement("video"),this.setCamera({horizontal:"right",vertical:"bottom"},"medium"),this.setStream(this.stream),this.draw()}},{key:"stop",value:function(){this.stream&&(it(this.stream),this.stream=null,this.screenStream=null,this.cameraStream=null)}},{key:"setStream",value:function(e){this.stream=e,this.cameraStream=new MediaStream(ct(this.stream)),this.screenStream=new MediaStream(at(this.stream)),bn(this.camera,this.cameraStream),bn(this.screen,this.screenStream),this.calcSizesAndPositions(),this.redrawQueued=!0}},{key:"setCamera",value:function(e,t){this.cameraPosition=e||this.cameraPosition,this.cameraSizeInWords=t||this.cameraSizeInWords,this.redrawQueued=!0}},{key:"calcSizesAndPositions",value:function(){var e=this.screenStream.getVideoTracks(),t=Ye()(e,1)[0],n=(void 0===t?Sn:t).getSettings(),i=n.width,r=n.height,s=function(e,t){var n=t.width/t.height,i=e.width/e.height,r=e.width,s=e.height,o=0,a=0;return n<i&&(r=t.width*(s/t.height),o=(e.width-r)/2),n>i&&(s=t.height*(r/t.width),a=(e.height-s)/2),{x:o,y:a,width:r,height:s}}(this.canvas,{width:i,height:r});this.camSize={small:gn,medium:vn,large:Tn,none:yn}[this.cameraSizeInWords];var o=pn(this.camera.width,this.camera.height,this.camSize);this.sizes={screen:{width:s.width,height:s.height},camera:{width:o.width,height:o.height}};var a={x:"right"===this.cameraPosition.horizontal?this.canvas.width-this.sizes.camera.width:0,y:"bottom"===this.cameraPosition.vertical?this.canvas.height-this.sizes.camera.height:0};this.positions={screen:{x:s.x,y:s.y},camera:{x:a.x,y:a.y}}}},{key:"draw",value:function(){try{if(!this.stream||!this.stream.active)return;this.calcSizesAndPositions(),this.redrawCallback&&this.redrawQueued&&(this.redrawCallback(),this.redrawQueued=!1);var e=performance.now();this.drawFrame(this.screen,this.positions.screen,this.sizes.screen),this.drawFrame(this.camera,this.positions.camera,this.sizes.camera);var t=performance.now();t-e>=mn&&m.warn("Mixer::drawFrame took ".concat(t-e,"ms."));var n=pt(this.stream);Ye()(n,1)[0].requestFrame(),this.bouncedDraw()}catch(e){m.error(e),this.errorCallback(e)}}},{key:"drawFrame",value:function(e,t,n){if(e&&e.srcObject&&e.srcObject.active)ft(e.srcObject)&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(e,t.x,t.y,n.width,n.height);else{var i=this.context.createImageData(1,1);this.context.putImageData(i,0,0)}}}]),e}(),En=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.audio,n=e.video,i=e.canvas,r=e.screen,s=void 0!==r&&r,o=e.onRedraw,a=e.changeStream,c=void 0!==a&&a,u=this.context._session,h=function(e){m.error("StartMixerEvent",e),!e.name.match(/notallowed|permission/i)&&s&&u.emit({type:"capture_error",name:"error_".concat(e.name)}),u.emit({type:"stop_presenting"})};new Ct({audio:t,video:n,screen:s,canvas:i,existingStream:u.localStream}).start().then(function(e){var t=at(e),n=Ye()(t,1)[0];return n&&n.addEventListener("ended",function(){u.emit({type:"stop_presenting"}),nt(n)}),u.canvasMixer=new Cn(i,e),u.canvasMixer.onError(h),u.canvasMixer.onRedraw(o),u.canvasMixer.start(),e}).then(function(e){c?u.emit({type:"start_presenting",stream:e}):u.emit({type:"stream_update",presentationStream:e})}).catch(h)}}]),t}(_),_n=function(e){function t(){return l()(this,t),y()(this,b()(t).apply(this,arguments))}return E()(t,e),f()(t,[{key:"handle",value:function(e){var t=e.position,n=e.size,i=this.context._session;try{i.canvasMixer.setCamera(t,n)}catch(e){m.error(e)}}}]),t}(_),Rn=function(){function e(){l()(this,e),this.listeners=[],this._eyeson=null,this._session=null,this._monitor=null,this._connection=null,this._rtConnection=null,this.send=this.send.bind(this)}return f()(e,[{key:"destroy",value:function(){this._monitor&&this._monitor.destroy(),this._connection&&this._connection.close(),this._rtConnection&&this._rtConnection.close(),this._session&&this._session.end(),this._api=null,this._session=null,this._monitor=null,this._connection=null,this._rtConnection=null}},{key:"onReceive",value:function(e){m.debug("EventHandler::onReceive"),this.listeners.push(e)}},{key:"removeListener",value:function(e){this.listeners=this.listeners.filter(function(t){return t!==e})}},{key:"send",value:function(e){e.silenced||m.debug("EventHandler::send",e),new({stfu:N,chat:Ft,accept:Yt,podium:_t,snapshot:Rt,send_chat:At,set_layer:wt,set_layout:It,fetch_room:Lt,room_ready:$t,room_setup:$t,memberlist:dn,upload_file:qt,delete_file:Ht,request_stfu:O,stream_offer:un,stop_youtube:jt,stream_answer:hn,start_youtube:Vt,change_stream:Bt,toggle_camera:Wt,stop_facebook:Kt,stop_playback:w,playback_update:N,start_playback:R,start_stream:Gt,start_facebook:zt,stop_recording:Jt,start_screen_capture:tn,stop_broadcasts:sn,start_recording:en,stop_presenting:rn,start_presenting:nn,stop_annotation:x,start_annotation:D,publish_broadcast:an,clear_front_layer:on,request_guest_user:cn,voice_activity_raw:Qt,start_mixer:En,update_mixer:_n,capture_error:N,voice_activity:N,options_update:N,ext_not_installed:N,broadcasts_update:N,facebook_logged_in:N,facebook_published:N,presentation_ended:N,handle_youtube_error:N,handle_facebook_error:N,status_update_youtube:N,recording:P,ext_cancel:P,ext_installed:P,message_status:P,moderator_info:P}[e.type]||k)(this).handle(e)}},{key:"connection",set:function(e){this._connection?m.error("A connection is already set. If you are trying to start a new session you have to end the current one first."):(this._connection=e,this._connection.onMessage(this.send))}},{key:"rtConnection",set:function(e){this._rtConnection?m.error("A real-time connection is already set. If you are trying to start a new session you have the close the current before."):(this._rtConnection=e,this._rtConnection.onMessage(this.send))}},{key:"monitor",set:function(e){this._monitor?m.error("A monitor is already set. If you are trying to start a new session you have to end the current one first."):(this._monitor=e,this._monitor.onError(this.send))},get:function(){return this._monitor}},{key:"session",set:function(e){this._session?m.error("A session is already set. If you are trying to start a new session you have to end the current one first."):(this._session=e,this._session.onEvent(this.send))}},{key:"api",set:function(e){this._api=e}},{key:"rtData",set:function(e){this._rtData=e}},{key:"eyeson",set:function(e){this._eyeson=e}}]),e}(),wn=[function(e){return e.replace("o=-","o=Visoweb")}];je.canSFU()&&wn.push(function(e){var t=e.split("\n"),n=t.findIndex(function(e){return e.startsWith("t=")});return t.splice(n+1,0,"a=sfu-capable"),t.join("\n")});var An=wn,In=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};l()(this,e),this.options=n,this.options.RTCConstraints=Object.assign({},this.defaultRTCConstraints,{offerToReceiveVideo:!this.options.eco}),this.accepted=!1,this.listeners=[],this.connection=t,this.startAttempts=0,this.maxStartAttempts=3,this.end=this.end.bind(this),this.emit=this.emit.bind(this),this.setStream=this.setStream.bind(this),this.endSession=this.endSession.bind(this),this.handleExit=this.handleExit.bind(this),this.initSession=this.initSession.bind(this),this.handleFailed=this.handleFailed.bind(this),this.handleAccept=this.handleAccept.bind(this),this.handleUnmute=this.handleUnmute.bind(this),this.restartSession=this.restartSession.bind(this),this.tryRecoveryFrom=this.tryRecoveryFrom.bind(this),this.terminateSession=this.terminateSession.bind(this),this.adjustVideoPodium=this.adjustVideoPodium.bind(this),this.remoteDescriptionUpdate=this.remoteDescriptionUpdate.bind(this)}var t;return f()(e,[{key:"start",value:function(){new Ct(this.options).start().then(this.initSession).catch(this.handleFailed)}},{key:"buildSessionOptions",value:function(e){return{sessionDescriptionHandlerOptions:{stream:e,connection:this.connection,handleAccept:this.handleAccept,handleUnmute:this.handleUnmute,RTCConstraints:this.options.RTCConstraints,remoteDescriptionUpdate:this.remoteDescriptionUpdate}}}},{key:"initSession",value:function(e){var t=this.buildSessionOptions(e);this.sipSession=this.connection.startSession(t,An),this.sipSession.on("bye",this.handleExit),this.sipSession.on("failed",this.handleFailed),this.sipSession.on("accepted",this.adjustVideoPodium),this.sipSession.on("terminated",this.handleTermination),window.addEventListener(je.isIOSDevice()?"pagehide":"beforeunload",this.endSession)}},{key:"end",value:function(){this.listeners=[],this.endSession()}},{key:"endSession",value:function(){m.debug("ConferenceSession::endSession"),this.sipSession&&(this.sipSession.removeAllListeners("accepted"),this.sipSession.removeAllListeners("bye"),this.sipSession.removeAllListeners("connecting"),this.sipSession.removeAllListeners("terminated"),this.sipSession.sessionDescriptionHandler&&this.sipSession.sessionDescriptionHandler.close(),this.connection.close(),this.terminateSession())}},{key:"terminateSession",value:function(){m.debug("ConferenceSession::terminateSession");try{this.sipSession.terminate()}catch(e){m.error(e)}}},{key:"setStream",value:(t=Ve()(Be.a.mark(function e(t){var n;return Be.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this.sipSession){e.next=2;break}return e.abrupt("return",null);case 2:return e.prev=2,e.next=5,this.sipSession.sessionDescriptionHandler.setStream(t);case 5:return n=e.sent,this.emit({type:"stream_update",localStream:n.newStream,stream:n.remoteStream}),e.abrupt("return",n.newStream);case 10:return e.prev=10,e.t0=e.catch(2),m.error("ConferenceSession::setStream",e.t0),this.emit({type:"stream_update",localStream:this.localStream,stream:this.remoteStream}),e.abrupt("return",this.localStream);case 15:case"end":return e.stop()}},e,this,[[2,10]])})),function(e){return t.apply(this,arguments)})},{key:"setMonitor",value:function(e){this.monitor=e}},{key:"handleTermination",value:function(e,t){m.debug(e,t)}},{key:"handleAccept",value:function(e){this.monitor&&this.monitor.observe(this.sipSession),this.accepted||(this.emit({type:"accept",session:this.sipSession}),this.accepted=!0),this.emit({type:"stream_update",stream:e})}},{key:"handleUnmute",value:function(e){this.emit({type:"track_unmuted",track:e})}},{key:"remoteDescriptionUpdate",value:function(e){m.debug("ConferenceSession::remoteDescriptionUpdate",e.sdp);var t=!1,n=e.sdp.split("\n").find(function(e){return e.startsWith("a=sfu-mode")});n&&(t=n.includes("on")),this.emit({type:"remote_description_update",update:{sfu:t}})}},{key:"adjustVideoPodium",value:function(){this.send({type:"mute_video",on:!this.options.video})}},{key:"handleExit",value:function(){this.emit({type:"exit",reason:"bye"})}},{key:"handleFailed",value:function(e){m.warn("ConferenceSession::handleFailed: ",e);var t="default_key";if(e&&(t=e&&(e.name||e.reasonPhrase)),!this.tryRecoveryFrom(t)){var n={"Busy Here":"session_in_use",Forbidden:"session_in_use",NotFoundError:"devices",NotAllowedError:"permission",DevicesNotFoundError:"devices",PermissionDeniedError:"permission",NotReadableError:"not_readable","Request Entity Too Large":"request_too_large",1006:"abrupt_disconnect"}[t]||"session_failed";this.emit({type:"error",name:n})}}},{key:"tryRecoveryFrom",value:function(e){var t=this;m.debug("ConferenceSession::tryRecoveryFrom: ",e);var n={"Not Found":{condition:function(){return t.startAttempts<t.maxStartAttempts},action:function(){return t.restartSession()}}}[e];return Boolean(n&&n.condition()&&n.action())}},{key:"restartSession",value:function(){var e=this;return m.debug("ConferenceSession::restartSession: ",this.startAttempts),this.startAttempts+=1,setTimeout(function(){e.endSession(),e.start()},1e3),!0}},{key:"onEvent",value:function(e){this.listeners.push(e)}},{key:"emit",value:function(e){this.listeners.forEach(function(t){return t(e)})}},{key:"send",value:function(e){return this.connection.send(e)}},{key:"peerConnection",get:function(){return this.sipSession.sessionDescriptionHandler.peerConnection}},{key:"localStream",get:function(){return this.sipSession.sessionDescriptionHandler.localStream}},{key:"remoteStream",get:function(){return this.sipSession.sessionDescriptionHandler.remoteStream}},{key:"defaultRTCConstraints",get:function(){return{offerToReceiveAudio:!0,offerToReceiveVideo:!0}}}]),e}(),kn=function(){function e(){l()(this,e),this.listeners=[],this.prevIceState="initial",this.pc=null,this.onOffline=this.onOffline.bind(this),this.handleIceStateChange=this.handleIceStateChange.bind(this),this.handleConnectionStateChange=this.handleConnectionStateChange.bind(this),this.addEventListeners()}return f()(e,[{key:"addEventListeners",value:function(){window.addEventListener("offline",this.onOffline)}},{key:"onOffline",value:function(){this.emit({type:"offline"})}},{key:"observe",value:function(e){this.sipSession=e,this.pc=this.sipSession.sessionDescriptionHandler.peerConnection,this.pc.oniceconnectionstatechange=this.handleIceStateChange,this.pc.onconnectionstatechange=this.handleConnectionStateChange}},{key:"destroy",value:function(){this.sipSession&&(this.sipSession.removeAllListeners("connecting"),this.pc.onconnectionstatechange=null,this.pc.oniceconnectionstatechange=null,window.removeEventListener("offline",this.onOffline))}},{key:"onError",value:function(e){this.listeners.push(e)}},{key:"emit",value:function(e){this.listeners.forEach(function(t){return t(e)})}},{key:"handleConnectionStateChange",value:function(e){e.currentTarget||m.warn("connectionStateChange: ",e.currentTarget.connectionState)}},{key:"handleIceStateChange",value:function(e){var t=this;if(e.currentTarget){var n=e.currentTarget.iceConnectionState;"disconnected"===n&&(this.emit({type:"warning",name:"ice_disconnected"}),window.setTimeout(function(){"connected"!==t.pc.iceConnectionState&&t.emit({type:"error",name:"ice_failed"})},3e3)),"failed"===n&&this.emit({type:"error",name:"ice_failed"}),"disconnected"===this.prevIceState&&["completed","connected"].includes(n)&&this.emit({type:"clear_warning",name:"ice_disconnected"}),this.prevIceState=n}}}]),e}(),Dn=n(17),xn=n.n(Dn),On=function(){function e(t){l()(this,e),this.onMessageHandler=null,this.onReceived=this.onReceived.bind(this),this.offMessage=this.offMessage.bind(this),this.onConnected=this.onConnected.bind(this),this.startSession=this.startSession.bind(this),this.onDisconnected=this.onDisconnected.bind(this),this.cable=xn.a.createConsumer(t)}return f()(e,[{key:"startSession",value:function(){this.cable.subscriptions.create({channel:"RoomChannel"},{connected:this.onConnected,received:this.onReceived,disconnected:this.onDisconnected}),this.cable.subscriptions.create({channel:"UserChannel"},{received:this.onReceived})}},{key:"onConnected",value:function(){this.disconnectTimestamp&&this.handleReconnect(),m.debug("ActionCableConnection::onConnected")}},{key:"handleReconnect",value:function(){this.onMessageHandler({type:"reconnect"})}},{key:"onReceived",value:function(e){m.debug("ActionCableConnection::onReceived",e),e._src="actioncable",this.onMessageHandler(e)}},{key:"onDisconnected",value:function(){m.debug("ActionCableConnection::onDisconnected"),this.disconnectTimestamp=Date.now(),this.onMessageHandler({type:"disconnect"})}},{key:"onMessage",value:function(e){this.onMessageHandler=e}},{key:"offMessage",value:function(){this.onMessageHandler=function(e){m.debug("ActionCableConnection::defaultMessageHandler: ",e)}}},{key:"send",value:function(e){var t=e.channel,n=void 0===t?"RoomChannel":t,i=e.message,r=void 0===i?"ping":i,s=this.cable.subscriptions.subscriptions.find(function(e){return e.identifier==='{"channel":"'.concat(n,'"}')});s?s.perform(r,{message:r}):m.warn("ActionCableConnection::send no subscription found! ",n)}},{key:"close",value:function(){this.offMessage(),this.onDisconnected()}}]),e}(),Pn={eventHandler:new Rn},Nn=function(e){return Pn.eventHandler.send({type:"connection",connectionStatus:e})},Un=function(e){if(Pn.eventHandler._connection){var t,n=new In(Pn.eventHandler._connection,e);n.setMonitor(Pn.eventHandler.monitor),Pn.eventHandler.session=n,n.start(),(t=Pn.eventHandler._rtData).broadcasts&&Pn.eventHandler.send({type:"broadcasts_update",broadcasts:t.broadcasts}),clearInterval(Pn.keepRoomAlive),this.session=n}else m.error("You tried to join a session that is not yet available. Before calling join, a connection status of connected has to be received.")},Mn=function(e){Nn("fetch_room"),Pn.eventHandler.eyeson=e,Pn.comApi.onError=function(){return Pn.eventHandler.send({type:"warning",name:"error:comapi"})},Pn.comApi.getRoom(function(e){if(e.error)return m.warn("eyeson::prepareConnection",e.error),void Nn("access_denied");var t;Nn("received_room"),Pn.rtConnection=new On(e.links.websocket),Pn.eventHandler.rtConnection=Pn.rtConnection,Pn.rtConnection.startSession(),Pn.eventHandler.monitor=new kn,Pn.eventHandler.api=Pn.comApi,Pn.keepRoomAlive=setInterval(function(){Pn.rtConnection.send({message:"user_joins"})},3e4),t=1,Pn.pollingFallbackInterval=setInterval(function(){return 200===t?(m.debug("eyeson::pollingFallback: max count exceeded, clearing interval."),void clearInterval(Pn.pollingFallbackInterval)):Pn.eventHandler._connection?(m.debug("eyeson::pollingFallback: connection set, clearing interval."),void clearInterval(Pn.pollingFallbackInterval)):void Pn.comApi.getRoom(function(e){if(!0===e.ready)return m.debug("eyeson::pollingFallback: room ready"),void Pn.eventHandler.send({type:"room_ready",content:e});m.debug("eyeson::pollingFallback: room not ready",t),t+=1})},5e3)})},$n={config:{api:"https://api.eyeson.team",youtube:{key:"",client:""}},core:Pn,room:{},user:{},links:{},onEvent:function(e){"function"==typeof e?Pn.eventHandler.onReceive(e):m.error("A listener to eyeson events has to be of type function. The argument passed to onEvent is of type "+h()(e)+".")},offEvent:function(e){return Pn.eventHandler.removeListener(e)},connect:function(e){m.debug("eyeson::connect",e),Pn.comApi=new g(this.config.api,e),Mn(this)},join:function(e){m.debug("eyeson::join",e),Un.bind(this,e)()},start:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{audio:!0,video:!0};m.debug("eyeson::start");var i=function e(i){"ready"===i.connectionStatus&&(t.offEvent(e),t.join(n))};this.onEvent(i),this.connect(e)},destroy:function(){m.debug("eyeson::destroy"),clearInterval(Pn.keepRoomAlive),Pn.eventHandler.destroy(),Pn.eventHandler=new Rn},send:function(e){return e._src="client",Pn.eventHandler.send(e)},throttledSend:function(e){var t=this;return this._throttledSend||(this._throttledSend=v(function(e){return t.send(e)},500)),this._throttledSend(e)}},Ln=n(13),Hn=n.n(Ln),qn=function(){function e(t){l()(this,e),this.roomUrl=t}return f()(e,[{key:"search",value:function(e){return this.request("".concat(this.roomUrl,"/search?q=").concat(e)).then(function(e){return e.data})}},{key:"random",value:function(){return this.request("".concat(this.roomUrl,"/random")).then(function(e){return e.data})}},{key:"trending",value:function(){var e=this;return this.request("".concat(this.roomUrl,"/trending?limit=9")).then(function(t){var n=t.data;return e.staff().then(function(e){return[].concat(Hn()(n),Hn()(e))})})}},{key:"staff",value:function(){return this.request("".concat(this.roomUrl,"/staff")).then(function(e){return e.data})}},{key:"randomForQuery",value:function(e){var t=this;return new Promise(function(n,i){t.search(e).then(function(e){return e.filter(function(e){return e.images.original_mp4.mp4_size>=4e4})}).then(function(e){n(e[Math.floor(Math.random()*e.length)])}).catch(i)})}},{key:"request",value:function(e){return fetch(new Request(e)).then(function(e){return e.json()}).catch(function(t){return m.warn("GiphyApi",e,t),{data:[]}})}}]),e}(),Fn="https://www.googleapis.com/youtube/v3",jn=function(){function e(t){l()(this,e),this.eyeson=t,this.apiKey=t.config.youtube.key,this.clientId=t.config.youtube.client,this.activated=null,this.apiKey&&this.clientId&&(this.broadcastId=null,this.activate=this.activate.bind(this),this.getStream=this.getStream.bind(this),this.deactivate=this.deactivate.bind(this),this.startStream=this.startStream.bind(this),this.handleError=this.handleError.bind(this),this.insertStream=this.insertStream.bind(this),this.clearInterval=this.clearInterval.bind(this),this.insertBroadcast=this.insertBroadcast.bind(this),this.createLiveStream=this.createLiveStream.bind(this),this.cleanupBroadcast=this.cleanupBroadcast.bind(this),this.initGoogleApi())}return f()(e,[{key:"initGoogleApi",value:function(){if("undefined"==typeof gapi){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.onload=this.handleClientLoad.bind(this),e.src="//apis.google.com/js/api.js",document.body.appendChild(e)}}},{key:"handleClientLoad",value:function(){gapi.load("client:auth2",this.initClient.bind(this))}},{key:"initClient",value:function(){gapi.client.init({apiKey:this.apiKey,clientId:this.clientId,scope:"https://www.googleapis.com/auth/youtube.force-ssl"}),this.activated&&this.activate()}},{key:"activate",value:function(){try{gapi.auth2.getAuthInstance().signIn({prompt:"select_account"}).then(this.createLiveStream,this.handleError)}catch(e){this.activated=!0,this.handleError()}}},{key:"deactivate",value:function(){m.warn("YouTubeApi::deactivate"),this.clearInterval(),this.cleanupBroadcast(),this.eyeson.send({type:"stop_youtube"})}},{key:"getDefaultTitle",value:function(){return"Live Stream ".concat((new Date).toDateString())}},{key:"insertBroadcast",value:function(){return gapi.client.request({path:Fn+"/liveBroadcasts",method:"POST",params:{part:"snippet,status"},body:{snippet:{title:this.getDefaultTitle(),scheduledStartTime:(new Date).toISOString()},status:{privacyStatus:"public"}}})}},{key:"listBroadcast",value:function(e){return gapi.client.request({path:Fn+"/liveBroadcasts",method:"GET",params:{id:e,part:"id,contentDetails,status"}})}},{key:"insertStream",value:function(){return gapi.client.request({path:Fn+"/liveStreams",method:"POST",params:{part:"snippet,cdn"},body:{snippet:{title:this.getDefaultTitle()},cdn:{resolution:"variable",frameRate:"variable",ingestionType:"rtmp"}}})}},{key:"bindBroadcast",value:function(e,t){return gapi.client.request({path:Fn+"/liveBroadcasts/bind",method:"POST",params:{id:e,streamId:t,part:"id,contentDetails"}})}},{key:"transitionBroadcast",value:function(e,t){return gapi.client.request({path:Fn+"/liveBroadcasts/transition",method:"POST",params:{id:e,part:"id,contentDetails",broadcastStatus:t}})}},{key:"deleteBroadcast",value:function(e){return gapi.client.request({path:Fn+"/liveBroadcasts",method:"DELETE",params:{id:e}})}},{key:"createLiveStream",value:function(){var e=this,t=null,n=null;this.insertBroadcast().then(function(n){return t=JSON.parse(n.body).id,e.broadcastId=t,e.insertStream()}).then(function(i){return n=JSON.parse(i.body).id,e.bindBroadcast(t,n)}).then(function(){return e.getStream(n)}).then(function(n){return e.startStream(t,JSON.parse(n.body))}).then(function(){return e.waitForStatus(function(){return e.getStream(n)},"active")}).then(function(){return e.transitionBroadcast(t,"testing")}).then(function(){return e.waitForStatus(function(){return e.getBroadcast(t)},"testing")}).then(function(){return e.transitionBroadcast(t,"live")}).then(function(){return e.eyeson.send({type:"status_update_youtube",status:"live"})}).catch(this.handleError)}},{key:"getStream",value:function(e){return gapi.client.request({path:Fn+"/liveStreams",params:{part:"cdn,status",id:e}})}},{key:"getBroadcast",value:function(e){return gapi.client.request({path:Fn+"/liveBroadcasts",params:{part:"id,status",id:e}})}},{key:"getViewersCount",value:function(e){return gapi.client.request({path:Fn+"/videos",params:{id:e,part:"liveStreamingDetails"}}).then(function(e){var t=Ye()(e.result.items,1)[0];return t?t.liveStreamingDetails.concurrentViewers:null})}},{key:"startStream",value:function(e,t){var n=Ye()(t.items,1)[0].cdn.ingestionInfo,i=n.ingestionAddress,r=n.streamName;this.eyeson.send({type:"start_youtube",playerUrl:"https://youtu.be/".concat(e),streamUrl:"".concat(i,"/").concat(r)})}},{key:"waitForStatus",value:function(e,t){var n=this,i=0;return new Promise(function(r,s){n.interval=window.setInterval(function(){if(m.debug("YouTubeApi::waitForStatus",t),i>150){n.clearInterval();var o=new Error("YouTube stream not ",t);o.error="timeout",s(o)}i+=1,e().then(function(e){var i=JSON.parse(e.body).items[0].status,s=i.streamStatus||i.lifeCycleStatus;n.eyeson.send({type:"status_update_youtube",status:s,health:i.healthStatus||{}}),s===t?(n.clearInterval(),r()):m.warn("YouTubeApi::waitForStatus: ",s)})},2e3)})}},{key:"handleError",value:function(e){var t={reason:"account_setup"};try{this.clearInterval(),this.cleanupBroadcast(),t=e.error?{reason:e.error}:JSON.parse(e.body).error.errors[0]}catch(e){m.error("YouTubeApi::handleError",e)}this.eyeson.send({type:"handle_youtube_error",error:Object.assign({},{name:"youtube_".concat(t.reason)},t)})}},{key:"clearInterval",value:function(){window.clearInterval(this.interval)}},{key:"cleanupBroadcast",value:function(){var e=this;if(this.broadcastId){var t=["ready","created","testing","testStarting"];this.listBroadcast(this.broadcastId).then(function(n){var i=Ye()(n.result.items,1)[0].status.lifeCycleStatus;t.includes(i)?e.deleteBroadcast(e.broadcastId).then(function(){m.debug("YouTubeApi::deleted: ",e.broadcastId)}):e.transitionBroadcast(e.broadcastId,"complete").then(function(){m.debug("YouTubeApi::completed: ",e.broadcastId)}),e.broadcastId=null}).catch(function(e){m.error("YouTubeApi::cleanupBroadcast",e)})}}}]),e}(),Gn=["FB is not defined","FB.login is not a function"],Bn=function(){function e(t){l()(this,e),this.eyeson=t,this.apiKey=t.config.facebook.key,this.stream=null,this.permalLinkUrl="default-permalink-url",this.apiKey&&(this.sendStop=this.sendStop.bind(this),this.loggedIn=this.loggedIn.bind(this),this.fetchLink=this.fetchLink.bind(this),this.startStream=this.startStream.bind(this),this.handleError=this.handleError.bind(this),this.streamPublished=this.streamPublished.bind(this),this.initFacebookApi())}return f()(e,[{key:"initFacebookApi",value:function(){var e,t,n,i,r,s=this;"undefined"==typeof FB&&(window.fbAsyncInit=function(){FB.init({appId:s.apiKey,xfbml:!0,version:"v2.9",autoLogAppEvents:!0}),FB.AppEvents.logPageView()},e=document,t="script",n="facebook-jssdk",r=e.getElementsByTagName(t)[0],e.getElementById(n)||((i=e.createElement(t)).id=n,i.src="//connect.facebook.net/en_US/sdk.js",r.parentNode.insertBefore(i,r)))}},{key:"activate",value:function(){FB.ui({display:"popup",method:"live_broadcast",phase:"create"},this.startStream)}},{key:"publish",value:function(){FB.ui({display:"popup",method:"live_broadcast",phase:"publish",broadcast_data:this.stream},this.streamPublished)}},{key:"login",value:function(){try{FB.login(this.loggedIn,{scope:"user_videos"})}catch(e){this.handleError(this.getError(e))}}},{key:"deactivate",value:function(){this.stream=null,this.sendStop()}},{key:"sendStop",value:function(){return this.stream?this.eyeson.send({type:"stop_facebook"}):null}},{key:"getError",value:function(e){var t={result:{error:{message:"user closed popup"}}};return e&&e.error_message?(t.result.error.message=e.error_message,t):(!e||e.message&&!Gn.includes(e.message)||(t.result.error={name:"facebook:not_loaded",message:"facebook api did not load"}),t)}},{key:"startStream",value:function(e){e&&!e.error_message?(this.stream=e,this.eyeson.send({type:"start_facebook",streamUrl:e.secure_stream_url})):this.handleError(this.getError(e))}},{key:"streamPublished",value:function(e){e&&!e.error_message?(this.fetchLink(),this.eyeson.send({type:"facebook_published"})):this.handleError(this.getError(e))}},{key:"loggedIn",value:function(e){e.authResponse||e.status?(this.permalLinkUrl="https://facebook.com/".concat(e.authResponse.userID),this.eyeson.send({type:"facebook_logged_in"})):this.handleError(this.getError(e))}},{key:"fetchLink",value:function(){var e=this;FB.api("/".concat(this.stream.id,"?fields=permalink_url"),function(t){t.permalink_url&&!t.error_message||(t.permalink_url=e.permalLinkUrl);var n=t.permalink_url.includes("https://facebook.com")?t.permalink_url:"https://facebook.com".concat(t.permalink_url);e.eyeson.send({type:"publish_broadcast",playerUrl:n})})}},{key:"handleError",value:function(e){e.result.error.name||(e.result.error.name="facebook:closed"),this.sendStop(),this.eyeson.send({type:"handle_facebook_error",error:e.result.error})}}]),e}(),Wn=function(){function e(){l()(this,e),this.level=0,this.instant=0,this.intervalCounter=0,this.silenceDuration=0,this.init(),this.offUpdate=this.offUpdate.bind(this)}return f()(e,[{key:"init",value:function(){var e=this,t=window.AudioContext||window.webkitAudioContext;void 0!==t?(this.context=new t,this.context.onstatechange=function(){"suspended"===e.context.state&&m.error("SoundMeter::init AudioContext: ",e.context.state)},this.script=this.context.createScriptProcessor(2048,1,1),this.script.onaudioprocess=function(t){var n=t.inputBuffer.getChannelData(0),i=n.reduce(function(e,t){return e+t*t},0);e.instant=100*Math.sqrt(i/n.length)}):m.error("AudioContext is not available. Probably the current user agent does not support this feature. Use the feature detector to hide not supported elements. Any call on onUpdate will not send values.")}},{key:"connectToSource",value:function(e){return!this.context||e.getAudioTracks().length<1?this:(m.debug("SoundMeter::connectToSource",e),this.mic=this.context.createMediaStreamSource(e),this.mic.connect(this.script),this.script.connect(this.context.destination),this)}},{key:"stop",value:function(){this.context&&(this.offUpdate(),this.mic&&this.mic.disconnect(),this.script.disconnect(),this.context.close&&this.context.close())}},{key:"offUpdate",value:function(){window.clearInterval(this.audioMeterInterval),window.clearInterval(this.readInterval)}},{key:"onUpdate",value:function(t){this.context&&(this.audioMeterInterval&&clearInterval(this.audioMeterInterval),this.readInterval=setInterval(this.readAudioLevel.bind(this,t),e.updateInterval))}},{key:"readAudioLevel",value:function(e){var t=this.level;if(0===t&&0===this.instant&&this.intervalCounter>5&&(this.silenceDuration++,this.silenceDuration>25&&fn(function(){e({error:"EyesonMicrophoneError"})},1e3)),this.level!==this.instant){this.silenceDuration=0;var n=Math.abs(t-this.instant);((t=this.instant)>.7||n>1)&&(this.level=this.instant,e({value:this.level}))}this.intervalCounter++}}]),e}();Wn.updateInterval=100;var Vn=Wn;n.d(t,"Logger",function(){return m}),n.d(t,"GiphyApi",function(){return qn}),n.d(t,"throttle",function(){return v}),n.d(t,"debounce",function(){return fn}),n.d(t,"YouTubeApi",function(){return jn}),n.d(t,"SoundMeter",function(){return Vn}),n.d(t,"FacebookApi",function(){return Bn}),n.d(t,"LocalStorage",function(){return Je}),n.d(t,"StreamHelpers",function(){return c}),n.d(t,"DeviceManager",function(){return bt}),n.d(t,"FeatureDetector",function(){return je}),n.d(t,"FullscreenHelper",function(){return Fe}),n.d(t,"MediaStreamBuilder",function(){return Ct});t.default=$n}])});
//# sourceMappingURL=eyeson.js.map